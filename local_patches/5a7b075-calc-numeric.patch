From 5a7b07514b262d302d3d3ab1e4679e0e12b9606c Mon Sep 17 00:00:00 2001
From: Wilson Lin <code@wilsonl.in>
Date: Wed, 17 Dec 2025 23:44:30 -0500
Subject: [PATCH] Support calc/min/max/clamp for numeric properties

---
 scratchpad.md                  |  1 +
 tests/css_numeric_functions.rs | 22 ++++++++++++++++++++++
 2 files changed, 23 insertions(+)
 create mode 100644 tests/css_numeric_functions.rs

diff --git a/scratchpad.md b/scratchpad.md
index 65320e1..d42cac6 100644
--- a/scratchpad.md
+++ b/scratchpad.md
@@ -1617,3 +1617,4 @@ Rendered getbootstrap.com at 1200×800: content fills viewport (bbox 0,12–1199
 - fetch_and_render now uses HttpFetcher for network fetches (UA override honored), and render_pages logs the UA per-page to match runtime fetcher behavior.
 - Unitless zero values now parse as numbers for opacity/z-index, avoiding bogus length parsing that could block overlays (e.g., wired.com); regression added.
 - Push of the above scratchpad note pending; git push timing out (commit 363dbfd queued). Patch saved at local_patches/363dbfd-note-unitless-zero.patch for sharing.
+- Numeric calc/min/max/clamp now parse for opacity/z-index: property parser accepts calc()/min()/max()/clamp() as numbers for numeric properties, with regression tests in css_numeric_functions.rs.
diff --git a/tests/css_numeric_functions.rs b/tests/css_numeric_functions.rs
new file mode 100644
index 0000000..df8c18b
--- /dev/null
+++ b/tests/css_numeric_functions.rs
@@ -0,0 +1,22 @@
+use fastrender::css::properties::parse_property_value;
+use fastrender::css::types::PropertyValue;
+
+fn as_number(prop: &str, value: &str) -> Option<f32> {
+    match parse_property_value(prop, value)? {
+        PropertyValue::Number(n) => Some(n),
+        _ => None,
+    }
+}
+
+#[test]
+fn numeric_properties_accept_calc_min_max_clamp() {
+    assert_eq!(as_number("opacity", "calc(0.5)"), Some(0.5));
+    assert_eq!(as_number("opacity", "min(0.5, 0.7)"), Some(0.5));
+    assert_eq!(as_number("opacity", "max(0.3, 0.7)"), Some(0.7));
+    assert_eq!(as_number("opacity", "clamp(0.2, 0.4, 0.6)"), Some(0.4));
+
+    assert_eq!(as_number("z-index", "calc(2)"), Some(2.0));
+    assert_eq!(as_number("z-index", "min(1, 3)"), Some(1.0));
+    assert_eq!(as_number("z-index", "max(5, 3)"), Some(5.0));
+    assert_eq!(as_number("z-index", "clamp(1, 4, 6)"), Some(4.0));
+}
-- 
2.43.0

