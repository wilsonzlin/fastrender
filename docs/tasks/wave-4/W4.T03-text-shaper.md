---
task_id: "W4.T03"
title: "Implement Text Shaper (rustybuzz Integration)"
wave: 4
estimated_hours: 10-12
depends_on:
  - "W3.T18"
inputs:
  - "docs/tasks/notes/W3.T18-notes.md"
outputs:
  - "src/text/shaper.rs"
  - "tests/text/test_shaper.rs"
  - "docs/tasks/notes/W4.T03-notes.md"
skills_required:
  - "Rust"
  - "OpenType shaping"
  - "rustybuzz library"
context_files:
  - "docs/text/shaping.md"
verification:
  - "cargo test text::shaper"
---

# Implement Text Shaper

## Context

Text shaping converts characters to positioned glyphs using OpenType features. Use `rustybuzz` (HarfBuzz port to Rust).

## Implementation

```rust
use rustybuzz::{Face, UnicodeBuffer, shape};

pub fn shape_text(
    text: &str,
    font: &FontFace,
    script: Script,
    direction: Direction,
) -> Vec<GlyphPosition> {
    let mut buffer = UnicodeBuffer::new();
    buffer.push_str(text);
    buffer.set_script(script);
    buffer.set_direction(direction);
    
    let glyph_buffer = shape(&font.face, &[], buffer);
    // Convert to GlyphPosition
}

pub struct GlyphPosition {
    pub glyph_id: u32,
    pub advance: f32,
    pub offset: Point,
}
```

## Testing

Tests (20+):
- Latin text
- Arabic/Hebrew (complex shaping)
- Ligatures
- Kerning
- Combining marks
- RTL text

Time: 10-12 hours
