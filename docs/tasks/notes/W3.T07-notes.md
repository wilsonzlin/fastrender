# W3.T07 - Table Column Width Distribution Algorithm

## Summary

Implemented a complete CSS-compliant table column width distribution algorithm following CSS Tables Module Level 3 and CSS 2.1 Section 17.5.2.2.

## Implementation Details

### New Files Created

1. **`src/layout/contexts/table/mod.rs`**
   - Module organization for table layout algorithms
   - Re-exports for public API

2. **`src/layout/contexts/table/column_distribution.rs`**
   - Core column distribution algorithm (~850 lines)
   - Complete implementation with 33 unit tests

3. **`tests/table_columns_test.rs`**
   - Integration tests (34 tests)
   - Real-world scenario tests

### Public API

```rust
// Column constraints for a single table column
pub struct ColumnConstraints {
    pub min_width: f32,      // Minimum content width
    pub max_width: f32,      // Maximum content width
    pub fixed_width: Option<f32>,    // Explicit CSS width
    pub percentage: Option<f32>,     // Percentage width (0-100)
    pub is_flexible: bool,   // Can receive proportional distribution
}

// Column distributor with mode selection
pub struct ColumnDistributor {
    mode: DistributionMode,  // Fixed or Auto
    min_column_width: f32,   // Global minimum
}

// Distribution result
pub struct ColumnWidthDistributionResult {
    pub widths: Vec<f32>,
    pub total_width: f32,
    pub is_over_constrained: bool,
    pub overflow_amount: f32,
}

// Mode enum
pub enum DistributionMode {
    Fixed,  // table-layout: fixed
    Auto,   // table-layout: auto
}

// Helper functions
pub fn distribute_spanning_cell_width(...);
pub fn compute_column_constraints(...);
```

### Algorithm Overview

The algorithm implements the CSS table width distribution specification:

#### Auto Layout Mode (`table-layout: auto`)

1. **Collect Column Constraints**: Analyze all cells to determine min/max widths
2. **Apply Fixed Widths**: Fixed columns get their specified width
3. **Resolve Percentages**: Percentage columns computed relative to table width
4. **Proportional Distribution**: Remaining space distributed to flexible columns based on flexibility range (max - min)

#### Fixed Layout Mode (`table-layout: fixed`)

1. First row and `<col>` elements determine widths
2. Fixed widths applied directly
3. Remaining space divided equally among auto columns

#### Edge Cases Handled

- **Over-constrained**: When minimum widths exceed available space, proportional scaling
- **Under-constrained**: When available exceeds max widths, columns cap at max
- **Colspan cells**: Width requirements distributed among spanned columns
- **Zero/negative widths**: Graceful handling with fallback to minimums

### CSS Spec Compliance

Based on:
- CSS Tables Module Level 3, Section 4 (Width computation)
- CSS 2.1 Section 17.5.2.2 (Automatic table layout algorithm)

Key behaviors:
- Fixed widths take priority over percentages
- Percentage widths take priority over auto
- min-width constraints always respected
- Proportional distribution based on flexibility range

## Test Summary

### Unit Tests (33 tests)

- Column constraints creation and properties
- Fixed/percentage/auto column handling
- Distribution modes (Fixed vs Auto)
- Proportional distribution
- Over-constrained scenarios
- Colspan handling
- Edge cases (zero width, negative space, etc.)

### Integration Tests (34 tests)

- Equal distribution scenarios
- Fixed width columns
- Percentage width columns
- Mixed constraint types
- Real-world table scenarios
- Responsive width handling

## Technical Decisions

### 1. Proportional Distribution by Flexibility Range

When distributing extra space to flexible columns, the algorithm uses each column's "flexibility range" (max - min) as the weight. This gives more space to columns that can utilize it.

### 2. Over-Constrained Scaling

When table width is less than sum of minimums, all columns are scaled proportionally down. This maintains relative proportions while fitting the constraint.

### 3. Percentage Calculation

Percentages are computed against the full available table width, then clamped to minimum widths. This matches CSS spec behavior where percentages don't account for fixed columns first.

### 4. Fixed Mode Simplicity

In fixed layout mode, auto columns get equal share of remaining space after fixed/percentage columns. This provides fast, predictable layout.

## Integration Points

The column distribution algorithm integrates with:

1. **TableFormattingContext** (W3.T06): Will use this for column width computation
2. **Cell Layout**: Provides column widths for cell content layout
3. **Box Tree**: Uses cell min/max widths from intrinsic sizing

## Future Work

1. **Border spacing**: Account for `border-spacing` in distribution
2. **Border collapse**: Handle collapsed border width contributions
3. **Row span**: Coordinate with row height distribution
4. **Caption handling**: Table wrapper box integration

## Files Modified

- `src/layout/contexts/mod.rs`: Added table module export

## Verification

```bash
cargo build          # Compiles without errors
cargo test           # All 382 tests pass
cargo clippy         # No warnings in our code
cargo fmt --check    # Code properly formatted
```
