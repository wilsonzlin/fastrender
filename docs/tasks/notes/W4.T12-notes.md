# W4.T12: Inline Formatting Context Implementation Notes

## Overview

This task implements the Inline Formatting Context (IFC) algorithm as specified in CSS 2.1 Section 9.4.2. The IFC handles horizontal layout of inline-level boxes, line breaking, and baseline alignment.

## Implementation Structure

### Module Organization

```
src/layout/contexts/inline/
  mod.rs            - Main InlineFormattingContext implementation
  baseline.rs       - Baseline alignment and vertical positioning
  line_builder.rs   - Line box construction and breaking
```

### Key Types

#### baseline.rs

- `VerticalAlign` - CSS vertical-align values (baseline, middle, sub, super, top, bottom, length, percentage)
- `BaselineMetrics` - Font metrics for baseline calculation (ascent, descent, line-gap, baseline-offset)
- `LineBaselineAccumulator` - Tracks maximum ascent/descent across items in a line

#### line_builder.rs

- `InlineItem` - Union of inline content types (Text, InlineBox, InlineBlock, Replaced)
- `TextItem` - Shaped text with advance width, break opportunities
- `InlineBoxItem` - Non-atomic inline box with children
- `InlineBlockItem` - Atomic inline (inline-block)
- `ReplacedItem` - Replaced elements (img, etc.)
- `Line` - A completed line box with positioned items
- `LineBuilder` - Incrementally builds lines from inline items

#### mod.rs (InlineFormattingContext)

- Implements `FormattingContext` trait
- `layout()` - Main entry point
- `compute_intrinsic_inline_size()` - For min-content/max-content sizing

## Algorithm Flow

### Layout Process

1. **Collect inline items**: Traverse BoxNode children, convert to InlineItems
2. **Build lines**: Use LineBuilder to break content into lines
3. **Position items**: Calculate final positions with baseline alignment
4. **Create fragments**: Generate FragmentNode tree

### Line Breaking

The algorithm handles:
- Soft breaks (allowed line break opportunities from UAX #14)
- Hard breaks (mandatory breaks at newlines)
- Overflow handling (content that doesn't fit)

### Baseline Alignment

For each line:
1. Calculate strut from containing block's font metrics
2. Accumulate baseline-relative items (baseline, middle, sub, super, etc.)
3. Track line-relative items separately (top, bottom)
4. Compute final line height as max of baseline height and line-relative heights

## CSS Specification References

- CSS 2.1 Section 9.4.2 - Inline formatting contexts
  https://www.w3.org/TR/CSS21/visuren.html#inline-formatting
- CSS 2.1 Section 10.8 - Line height calculations
  https://www.w3.org/TR/CSS21/visudet.html#line-height
- CSS 2.1 Section 10.8.1 - Leading and half-leading
  https://www.w3.org/TR/CSS21/visudet.html#leading

## Integration Points

### Dependencies

- **W2.T07 (Text Pipeline)**: TextShaper for shaping text
- **W4.T05 (Font Metrics)**: FontMetrics for baseline calculations
- **W4.T09 (Line Breaking)**: find_break_opportunities for UAX #14
- **W3.T18 (FormattingContext)**: FormattingContext trait implementation

### Produces

- `InlineFormattingContext` struct implementing `FormattingContext`
- Line fragments with positioned text/inline content
- Baseline information for each line

## Test Coverage

Total: 39 tests for the inline module

### baseline.rs (14 tests)
- Vertical alignment mode properties
- Baseline metrics calculation
- Line accumulator with various alignments
- Half-leading computation

### line_builder.rs (13 tests)
- Single/multiple item placement
- Line breaking when content exceeds width
- Force breaks
- Empty lines
- Positioned item coordinates
- Various inline item types

### mod.rs (12 tests)
- Empty container layout
- Single/multiple text nodes
- Line breaking behavior
- Min/max content width calculation
- Send+Sync trait bounds
- Edge cases (empty text, whitespace)

## Future Improvements

1. **Full text shaping integration**: Currently uses simplified width approximation
2. **Vertical-align support in style**: Add vertical-align to ComputedStyles
3. **Inline box fragmentation**: Handle multi-line inline boxes (e.g., `<span>` across lines)
4. **Text decoration propagation**: Handle underline/overline spanning
5. **BiDi reordering**: Integrate with bidi module for RTL text
6. **Ruby annotation**: Support for `<ruby>` elements
7. **First-line/first-letter**: Pseudo-element special handling

## Design Decisions

### Simplified Text Shaping

For this implementation, text width is approximated as `char_count * 0.5 * font_size`. This allows the IFC algorithm to work independently of font loading, making it testable and faster for initial implementation. Full font shaping integration is planned for future work.

### Line Builder Pattern

The LineBuilder uses a builder pattern that accumulates items and produces lines. This separates the concerns of:
- Item collection (InlineFormattingContext)
- Line breaking decisions (LineBuilder)
- Baseline computation (LineBaselineAccumulator)

### Fragment Generation

Fragments are created in a separate pass after line building is complete. This allows all positioning decisions to be finalized before creating the immutable fragment tree.

## Files Modified

- `src/layout/contexts/mod.rs` - Added inline module export
- Created `src/layout/contexts/inline/mod.rs`
- Created `src/layout/contexts/inline/baseline.rs`
- Created `src/layout/contexts/inline/line_builder.rs`
