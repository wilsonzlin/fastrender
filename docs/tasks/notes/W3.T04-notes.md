# W3.T04: Block Formatting Context Algorithm - Implementation Notes

## Overview

This task implements the Block Formatting Context (BFC) layout algorithm, the most fundamental layout mode in CSS. The BFC handles vertical stacking of block-level elements with proper width computation and margin collapsing.

## Implementation Summary

### Module Structure

```
src/layout/contexts/block/
├── mod.rs            # BlockFormattingContext implementation
├── margin_collapse.rs # Margin collapsing algorithm (CSS 2.1 §8.3.1)
└── width.rs          # Block width computation (CSS 2.1 §10.3.3)
```

### Key Components

#### 1. BlockFormattingContext (`mod.rs`)

Implements the `FormattingContext` trait for block-level layout:

```rust
pub struct BlockFormattingContext;

impl FormattingContext for BlockFormattingContext {
    fn layout(&self, box_node: &BoxNode, constraints: &LayoutConstraints)
        -> Result<FragmentNode, LayoutError>;

    fn compute_intrinsic_inline_size(&self, box_node: &BoxNode, mode: IntrinsicSizingMode)
        -> Result<f32, LayoutError>;
}
```

**Key behaviors:**
- Lays out children vertically, stacking top-to-bottom
- Computes width using CSS 2.1 §10.3.3 constraint equation
- Handles margin collapsing between siblings
- Skips out-of-flow children (absolute/fixed positioned)
- Computes height based on children (auto) or explicit value
- Applies min-height/max-height constraints

#### 2. Width Computation (`width.rs`)

Implements the CSS 2.1 §10.3.3 constraint equation:

```
margin-left + border-left + padding-left + width +
padding-right + border-right + margin-right = containing-block-width
```

**Key types:**
- `ComputedBlockWidth` - Result containing all horizontal dimensions
- `MarginValue` - Enum for Length or Auto margins

**Resolution algorithm:**
1. If width is specified:
   - Both margins auto → center the box (equal margins)
   - One margin auto → it gets the remainder
   - Neither auto → over-constrained (ignore margin-right in LTR)
2. If width is auto:
   - Auto margins become 0
   - Width fills remaining space

#### 3. Margin Collapsing (`margin_collapse.rs`)

Implements CSS 2.1 §8.3.1 vertical margin collapsing:

**Key types:**
- `CollapsibleMargins` - Tracks positive/negative margins for collapse
- `MarginCollapseContext` - State machine for layout traversal

**Collapsing rules:**
- Both positive: result = max(margins)
- Both negative: result = min(margins) (most negative)
- Mixed: result = max(positives) + min(negatives)

**When margins collapse:**
- Adjacent sibling margins
- Parent-child margins (if no border/padding separation)

**When margins DON'T collapse:**
- Separated by border or padding
- Parent establishes new BFC (overflow ≠ visible)
- Out-of-flow elements (absolute, fixed)

## API Design Decisions

### 1. Stateless Context

The `BlockFormattingContext` struct is stateless:
```rust
#[derive(Debug, Default)]
pub struct BlockFormattingContext;
```

Margin collapse state is passed through method parameters, making the context reusable and thread-safe (Send + Sync).

### 2. ComputedStyles Integration

The implementation works with the existing `ComputedStyles` structure:
- Individual margin/padding/border fields (not EdgeOffsets)
- `Option<Length>` for width/height (None = auto)
- Resolves percentages against containing block width

### 3. Placeholder for Inline Content

Text and inline content uses a placeholder implementation:
```rust
fn layout_inline_placeholder(&self, child: &BoxNode) -> Result<Option<FragmentNode>, LayoutError>
```

This will be replaced when W4.T12 (InlineFormattingContext) is implemented.

## CSS Spec References

| Feature | CSS Spec Reference |
|---------|-------------------|
| Block Formatting Context | CSS 2.1 §9.4.1 |
| Width Computation | CSS 2.1 §10.3.3 |
| Height Computation | CSS 2.1 §10.6.3 |
| Margin Collapsing | CSS 2.1 §8.3.1 |

## Test Coverage

61 tests total covering:

### Width Computation (20 tests)
- Auto width fills container
- Explicit width with auto margins (centering)
- Left/right margin auto individually
- Over-constrained resolution
- Padding and border calculations
- Percentage widths
- Negative width prevention

### Margin Collapsing (25 tests)
- Positive margin collapse
- Negative margin collapse
- Mixed margin collapse
- CollapsibleMargins operations
- MarginCollapseContext state machine
- Border/padding separation detection
- BFC establishment detection

### Layout Integration (16 tests)
- Empty block layout
- Explicit height
- Nested blocks
- Width filling
- Padding and border in layout
- Sibling margin collapse
- Intrinsic sizing (min/max content)
- Out-of-flow skipping
- min-height/max-height constraints
- Deep nesting
- Zero-width containers
- Send+Sync verification

## Integration Points

### Dependencies
- `crate::geometry::Rect` - Fragment bounds
- `crate::layout::LayoutConstraints` - Available space
- `crate::layout::FormattingContext` - Trait implementation
- `crate::style::ComputedStyles` - Style values
- `crate::tree::BoxNode` - Input box tree
- `crate::tree::FragmentNode` - Output fragment tree

### Used By
- `FormattingContextFactory` (W2.T09) - Creates BFC instances
- `LayoutEngine` (W2.T10) - Dispatches to BFC for block layout
- Future inline layout (W4.T12) - Contains inline content

## Future Enhancements

1. **Float handling** - Currently skipped, needs float layout
2. **Clear property** - Clearance below floats
3. **Inline layout** - Replace placeholder with real InlineFormattingContext
4. **Writing modes** - Currently assumes horizontal-tb
5. **Percentage heights** - Need containing block height resolution
6. **Replaced elements** - Special width/height handling

## Performance Notes

- No allocation in width computation (returns stack values)
- Single pass layout (no backtracking)
- Margin collapse state is O(1) memory
- Recursive layout follows tree structure naturally
