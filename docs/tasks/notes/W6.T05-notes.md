# W6.T05 - Reference Test Harness Implementation Notes

## Task Summary

Implemented a comprehensive reference test harness for visual regression testing in FastRender. The harness compares rendered HTML/CSS output against expected reference images to detect visual regressions.

## Files Created

1. **`tests/ref/compare.rs`** (~550 lines)
   - Image comparison module with pixel-by-pixel comparison
   - Configurable tolerance levels (strict, lenient, fuzzy)
   - Difference visualization and statistics (MSE, PSNR)
   - PNG loading and saving utilities

2. **`tests/ref/harness.rs`** (~820 lines)
   - `RefTestHarness` struct - main test runner
   - `RefTestConfig` - configuration for viewport, comparison, and output
   - `RefTestResult` - single test result with detailed diagnostics
   - `RefTestResults` - batch test results with summary
   - Test discovery and batch execution

3. **`tests/ref/mod.rs`** (~160 lines)
   - Module organization and documentation
   - Public API re-exports

4. **`tests/ref_tests.rs`** (~570 lines)
   - Integration test file with 57 unit tests
   - Tests for compare module
   - Tests for harness module
   - Integration tests (3 ignored pending full rendering pipeline)

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Reference Test Harness                     │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐ │
│  │  Test Files │ ───► │   Renderer  │ ───► │   Pixmap    │ │
│  │ (HTML/CSS)  │      │ (FastRender)│      │  (Actual)   │ │
│  └─────────────┘      └─────────────┘      └──────┬──────┘ │
│                                                    │        │
│  ┌─────────────┐                           ┌──────▼──────┐ │
│  │  Reference  │ ─────────────────────────►│   Compare   │ │
│  │    Image    │                           │   Module    │ │
│  └─────────────┘                           └──────┬──────┘ │
│                                                    │        │
│                                             ┌──────▼──────┐ │
│                                             │  ImageDiff  │ │
│                                             │  (Result)   │ │
│                                             └─────────────┘ │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## Key Features

### Image Comparison (`compare.rs`)

- **Pixel-by-pixel comparison** with BGRA format handling (tiny-skia native)
- **Per-channel tolerance** for color differences (0-255 range)
- **Max different percent** threshold for overall image matching
- **Difference visualization** - red pixels show differences with intensity
- **Quality metrics**:
  - MSE (Mean Squared Error)
  - PSNR (Peak Signal-to-Noise Ratio)
  - Per-channel max differences

### Comparison Presets

```rust
CompareConfig::strict()   // Exact pixel match
CompareConfig::lenient()  // 5 tolerance, 0.1% max different
CompareConfig::fuzzy()    // 10 tolerance, 1% max different, no alpha
```

### Test Harness (`harness.rs`)

- **Test discovery** - automatically finds tests with `input.html` files
- **Single test** - `run_ref_test()` with test directory and reference path
- **Inline test** - `run_ref_test_inline()` with HTML string
- **Batch execution** - `run_all_tests()` for entire test suites
- **Reference generation** - `create_reference()` for initial images
- **Reference update** - `update_reference()` to regenerate references

### Test File Convention

```
tests/ref/fixtures/
├── test_name/
│   ├── input.html       # Required: HTML to render
│   ├── style.css        # Optional: CSS styles
│   ├── reference.png    # Required: Expected output
│   └── config.toml      # Optional: Test configuration
```

### Failure Artifacts

When tests fail, the harness can save:
- `{test_name}_actual.png` - rendered output
- `{test_name}_diff.png` - visual difference map

## API Usage Examples

### Running a Single Test

```rust
use ref::{RefTestHarness, RefTestConfig};

let harness = RefTestHarness::new();
let result = harness.run_ref_test(
    Path::new("tests/ref/fixtures/simple_box"),
    Path::new("tests/ref/fixtures/simple_box/reference.png"),
);

assert!(result.passed, "Test failed: {}", result.summary());
```

### Running All Tests

```rust
let harness = RefTestHarness::new();
let results = harness.run_all_tests(Path::new("tests/ref/fixtures"))?;

println!("{}", results.summary());
assert!(results.all_passed());
```

### Comparing Images Directly

```rust
use ref::{compare_images, CompareConfig, load_png};

let actual = load_png(Path::new("actual.png"))?;
let expected = load_png(Path::new("expected.png"))?;

let diff = compare_images(&actual, &expected, &CompareConfig::lenient());

if !diff.is_match() {
    println!("Images differ: {}", diff.summary());
    diff.save_diff_image(Path::new("diff.png"))?;
}
```

### Creating Reference Images

```rust
let harness = RefTestHarness::with_config(
    RefTestConfig::with_viewport(800, 600)
);

let html = r#"<html><body><div style="background: red; width: 100px; height: 100px;"></div></body></html>"#;

harness.create_reference(html, Path::new("reference.png"))?;
```

## Test Results

- **54 tests pass**
- **3 tests ignored** (require full rendering pipeline which has layout limitations)
- **0 failures**

## Implementation Decisions

1. **tiny-skia format**: Used BGRA premultiplied alpha format directly to match tiny-skia's internal representation, avoiding unnecessary conversions.

2. **Tolerance presets**: Provided three preset configurations (strict, lenient, fuzzy) covering common use cases from exact matching to general layout testing.

3. **PSNR/MSE metrics**: Added industry-standard image quality metrics for objective comparison beyond simple pixel counts.

4. **Diff visualization**: Diff images show differences in red with intensity proportional to magnitude, while matching pixels are shown as dimmed grayscale.

5. **Ignored integration tests**: Some integration tests that require the full rendering pipeline are marked as `#[ignore]` since the layout engine may have limitations with certain HTML structures.

## Dependencies

- **tiny_skia**: For Pixmap operations
- **image**: For PNG encoding/decoding
- **fastrender**: For rendering HTML to images

## Verification

```bash
cargo test --test ref_tests
# 54 passed, 3 ignored, 0 failed

cargo fmt --check -- tests/ref/*.rs tests/ref_tests.rs
# No formatting issues

cargo clippy --tests
# Only expected "unused" warnings for public API
```

## Future Enhancements

1. **Config file support**: Parse `config.toml` files in test directories for per-test configuration
2. **Parallel execution**: Run multiple tests concurrently for faster CI
3. **HTML report generation**: Create visual HTML reports with thumbnails
4. **Tolerance regions**: Support masking specific areas for comparison
5. **Animation testing**: Support for testing animated content

## Notes

- The harness integrates with the existing FastRender `Renderer` API
- Image comparison is O(width × height) complexity
- All tests compile and run successfully on the current codebase
