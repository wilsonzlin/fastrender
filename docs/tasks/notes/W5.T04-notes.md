# Task W5.T04 Output Notes

**Task:** Implement Paint Order Sorter
**Completed:** 2025-11-29
**Status:** Complete (merged with stacking module)

---

## Summary

The paint order sorting functionality has been implemented as part of the comprehensive `stacking` module (`src/paint/stacking.rs`). This module provides:

1. **StackingContext struct** - Represents a CSS stacking context with children and layer-organized fragments
2. **StackingContextReason enum** - 20 conditions that create stacking contexts
3. **PaintOrderIterator** - Iterator for traversing stacking tree in paint order
4. **build_stacking_tree()** - Builds stacking context tree from fragment tree
5. **creates_stacking_context()** - Checks if an element creates a stacking context

---

## The 7-Layer Paint Order Algorithm

As specified in CSS 2.1 Appendix E, elements within each stacking context are painted in this order (back to front):

| Layer | Description | Sort Order |
|-------|-------------|------------|
| 1 | Background and borders of stacking context root | N/A (first) |
| 2 | Child stacking contexts with negative z-index | z-index ascending (most negative first) |
| 3 | In-flow, non-inline-level, non-positioned descendants | Tree order (DOM order) |
| 4 | Non-positioned floats | Tree order |
| 5 | In-flow, inline-level, non-positioned descendants | Tree order |
| 6 | Positioned descendants with z-index: auto or 0 | Tree order |
| 7 | Child stacking contexts with positive z-index | z-index ascending (least positive first) |

---

## Architecture

The stacking module integrates with the paint system:

```text
Fragment Tree → Stacking Tree → Display List → Rasterizer → Pixels
```

### StackingContext Structure

```rust
pub struct StackingContext {
    pub z_index: i32,
    pub children: Vec<StackingContext>,
    pub fragments: Vec<FragmentNode>,
    pub layer3_blocks: Vec<FragmentNode>,
    pub layer4_floats: Vec<FragmentNode>,
    pub layer5_inlines: Vec<FragmentNode>,
    pub layer6_positioned: Vec<FragmentNode>,
    pub bounds: Rect,
    pub reason: StackingContextReason,
    pub tree_order: usize,
}
```

### Key Methods

- `negative_z_children()` - Returns layer 2 children sorted by z-index
- `zero_z_children()` - Returns z-index:0 children in tree order
- `positive_z_children()` - Returns layer 7 children sorted by z-index
- `add_fragment_to_layer()` - Classifies and adds fragment to correct layer
- `sort_children()` - Recursively sorts all child stacking contexts

---

## Stacking Context Creation Conditions

The implementation checks 20 conditions (CSS 2.1 + modern CSS):

1. Root element
2. Positioned element with z-index ≠ auto
3. Fixed positioning
4. Sticky positioning
5. Opacity < 1
6. Transform (not none)
7. Filter (not none)
8. Clip-path (not none)
9. Mask properties
10. Mix-blend-mode (not normal)
11. Isolation: isolate
12. Perspective (not none)
13. Backdrop-filter (not none)
14. CSS containment
15. Flex item with z-index
16. Grid item with z-index
17. Will-change
18. Container-type
19. Top layer elements
20. Overflow clip (in some contexts)

---

## Usage Example

```rust
use fastrender::paint::{build_stacking_tree, StackingContext, PaintOrderIterator};

// Build stacking tree from fragment tree
let stacking_tree = build_stacking_tree(&fragment_tree.root, None, true);

// Iterate in paint order
for item in PaintOrderIterator::new(&stacking_tree) {
    // Process fragments in correct paint order
}
```

---

## References

- CSS 2.1 Appendix E: https://www.w3.org/TR/CSS21/zindex.html
- CSS 2.1 Section 9.9: https://www.w3.org/TR/CSS21/visuren.html#z-index
- W1.R05 Research Notes: Comprehensive stacking context research
