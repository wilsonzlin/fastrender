# W3.T03 - Table Structure Fixup Algorithm

## Overview

This task implements the table structure fixup algorithm required by CSS 2.1 Section 17.2.1. The algorithm transforms incomplete table structures into complete ones by inserting anonymous boxes.

## Implementation Details

### Module Location
- **File**: `src/tree/table_fixup.rs`
- **Main struct**: `TableStructureFixer`

### Table Structure Requirements (CSS 2.1)

A well-formed table has the following structure:

```
Table Wrapper Box (optional, if captions present)
  +-- Caption Box(es) (optional)
  +-- Table Grid Box
       +-- Column Group Box (optional)
       |    +-- Column Box(es)
       +-- Row Group Box (thead, tbody, tfoot)
            +-- Row Box
                 +-- Cell Box(es)
```

### Anonymous Box Rules

1. **Cell-to-Row**: If cells exist not in a row, wrap them in an anonymous `table-row`
2. **Row-to-Group**: If rows exist not in a row-group, wrap them in an anonymous `tbody`
3. **Non-Table Content**: Non-table content in table context is wrapped in anonymous cells
4. **Captions**: Tables with captions need a wrapper box

### Algorithm Phases

The fixup algorithm proceeds in four phases:

1. **`ensure_cells_in_rows`**: Wraps loose cells in anonymous rows
2. **`ensure_rows_in_groups`**: Wraps loose rows in anonymous tbody
3. **`infer_columns`**: Determines column count from cells (placeholder for future colspan support)
4. **`create_wrapper_if_needed`**: Creates table wrapper for tables with captions

### Type Checker Methods

The following methods help identify table-related box types:

| Method | Description |
|--------|-------------|
| `is_table_box()` | Checks for `display: table` or `inline-table` |
| `is_table_row()` | Checks for `display: table-row` or anonymous row |
| `is_table_cell()` | Checks for `display: table-cell` or anonymous cell |
| `is_table_row_group()` | Checks for `display: table-row-group/thead/tbody/tfoot` |
| `is_table_caption()` | Checks for `display: table-caption` |
| `is_table_column_group()` | Checks for `display: table-column-group` |
| `is_table_column()` | Checks for `display: table-column` |
| `is_table_internal()` | Checks if any table-internal element |

### Anonymous Box Types Added

Added `AnonymousType::TableRowGroup` to the `AnonymousType` enum in `box_tree.rs`:

```rust
pub enum AnonymousType {
    Block,
    Inline,
    TableWrapper,
    TableRowGroup,  // NEW
    TableRow,
    TableCell,
}
```

### Public API

```rust
// Fix a single table
let fixed = TableStructureFixer::fixup_table(table_box)?;

// Fix all tables in a tree
let fixed = TableStructureFixer::fixup_tree(root)?;

// Validate table structure
let is_valid = TableStructureFixer::validate_table_structure(&table);
```

## Tests

26 comprehensive tests covering:

### Type Checker Tests (5 tests)
- `test_is_table_box`
- `test_is_table_row`
- `test_is_table_cell`
- `test_is_table_row_group`
- `test_is_table_caption`

### Cell-to-Row Fixup Tests (4 tests)
- `test_table_with_loose_cells_wrapped_in_row`
- `test_table_with_loose_rows_wrapped_in_tbody`
- `test_complete_table_no_fixup`
- `test_row_group_with_loose_cells`

### Mixed Content Tests (2 tests)
- `test_mixed_loose_rows_and_row_groups`
- `test_non_table_content_wrapped_in_cell`

### Caption Tests (2 tests)
- `test_table_with_caption_gets_wrapper`
- `test_table_without_caption_no_wrapper`

### Empty Table Tests (3 tests)
- `test_empty_table`
- `test_table_with_empty_row_group`
- `test_table_with_empty_row`

### Column Inference Tests (2 tests)
- `test_column_count_simple`
- `test_column_count_empty_row`

### Validation Tests (3 tests)
- `test_validate_proper_structure`
- `test_validate_loose_row_fails`
- `test_validate_loose_cell_fails`

### Tree Fixup Tests (2 tests)
- `test_fixup_tree_with_nested_tables`
- `test_fixup_tree_non_table`

### Complex Scenario Tests (3 tests)
- `test_complex_table_multiple_row_groups`
- `test_table_with_all_elements`
- `test_deeply_nested_table_content`

## CSS Specification References

- CSS 2.1 Section 17.2.1 - Anonymous Table Objects
  - https://www.w3.org/TR/CSS21/tables.html#anonymous-boxes

## Future Work

1. **Colspan/Rowspan Support**: The `count_columns` method currently assumes colspan=1. When table layout properties are added, this should read actual colspan values from cell styles.

2. **Column Box Generation**: Currently column inference is a placeholder. Full implementation would generate anonymous column boxes based on inferred column count.

3. **Integration with Box Generator**: The table fixup should be called during box generation when `BoxGenerationConfig::insert_anonymous_boxes` is enabled.

## Verification

All verification steps pass:
- `cargo build`: Compiles without errors
- `cargo test tree::table_fixup`: 26/26 tests pass
- `cargo clippy -- -D warnings`: No warnings in fastrender code
- `cargo fmt --check`: Code is properly formatted
