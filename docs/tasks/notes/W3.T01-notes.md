# W3.T01 Box Generation Algorithm - Implementation Notes

## Summary

This task enhanced the box generation system by implementing comprehensive replaced element handling, utility methods for box tree traversal, and extensive tests. The implementation builds on the W2.T11 foundation.

## Dependencies

- **W2.T11**: BoxGenerator structure and core generation logic (foundational)
- **W1.R01**: CSS specification research for box generation semantics

## Implementation Details

### 1. Replaced Element Handling

Enhanced `DOMNode` to support replaced elements (CSS 2.1 Section 3.1):

#### New DOMNode Fields
```rust
pub struct DOMNode {
    // ... existing fields ...

    /// Intrinsic size for replaced elements (images, video, etc.)
    pub intrinsic_size: Option<Size>,

    /// Source URL for replaced elements (img src, video src, etc.)
    pub src: Option<String>,
}
```

#### New Methods
- `DOMNode::new_replaced()` - Constructor for replaced elements
- `DOMNode::is_replaced_element()` - Detects img, video, canvas, svg, iframe, embed, object, audio
- `DOMNode::aspect_ratio()` - Computes width/height ratio
- `DOMNode::replaced_type()` - Maps tag name to ReplacedType enum
- `DOMNode::with_intrinsic_size()` - Builder method
- `DOMNode::with_src()` - Builder method

#### BoxGenerator Enhancement
```rust
fn create_replaced_box(&self, node: &DOMNode) -> Result<BoxNode, BoxGenerationError> {
    // Creates BoxNode::new_replaced() with intrinsic size and aspect ratio
}
```

### 2. Utility Methods

Added utility methods to `BoxGenerator`:

| Method | Purpose |
|--------|---------|
| `count_boxes()` | Total box count in tree |
| `find_boxes_by_predicate()` | Generic tree search |
| `find_block_boxes()` | Find all block-level boxes |
| `find_inline_boxes()` | Find all inline-level boxes |
| `find_text_boxes()` | Find all text boxes |
| `find_replaced_boxes()` | Find all replaced boxes |
| `validate_box_tree()` | Structural validation |
| `tree_depth()` | Maximum nesting depth |

### 3. Error Handling

Added new error variant:
```rust
pub enum BoxGenerationError {
    // ... existing ...
    InvalidStructure(String),  // For structural validation errors
}
```

## Replaced Element Types

The implementation supports these replaced elements per CSS spec:

| Element | ReplacedType | Notes |
|---------|--------------|-------|
| `<img>` | Image { src } | Most common replaced element |
| `<video>` | Video { src } | Video content |
| `<canvas>` | Canvas | Drawing surface |
| `<svg>` | Svg { content } | Vector graphics |
| `<iframe>` | Iframe { src } | Nested browsing context |
| `<embed>` | - | External content |
| `<object>` | - | External resources |
| `<audio>` | - | Audio content |

## Box Generation Flow

```
DOM Node
    │
    ├─> is_text()? ─────────────> create_text_box()
    │
    ├─> is_replaced_element()? ──> create_replaced_box()
    │
    └─> else ────────────────────> generate_box_for_element()
                                      │
                                      ├─> Block/FlowRoot/ListItem
                                      ├─> Inline
                                      ├─> InlineBlock
                                      ├─> Flex/InlineFlex
                                      ├─> Grid/InlineGrid
                                      └─> Table/etc.
```

## Test Coverage

Added 21 new tests for a total of 51 box_generation tests:

### Replaced Element Tests
- `test_dom_node_is_replaced_element` - Detection for all replaced element types
- `test_new_replaced_constructor` - Constructor validation
- `test_replaced_element_aspect_ratio` - Aspect ratio calculation
- `test_replaced_element_type_detection` - ReplacedType mapping
- `test_generate_replaced_box` - Box generation
- `test_generate_multiple_replaced_elements` - Multiple replaced elements
- `test_replaced_element_with_display_none_child` - Edge case
- `test_replaced_element_inline_context` - Inline flow context
- `test_empty_replaced_src` - Empty source handling
- `test_mixed_content_with_replaced` - Mixed content
- `test_svg_replaced_element` - SVG handling
- `test_iframe_replaced_element` - IFrame handling

### Utility Method Tests
- `test_count_boxes_utility` - Box counting
- `test_find_boxes_by_predicate` - Generic search
- `test_find_block_boxes` - Block box search
- `test_find_inline_boxes` - Inline box search
- `test_find_text_boxes` - Text box search
- `test_find_replaced_boxes_utility` - Replaced box search
- `test_validate_box_tree_valid` - Tree validation
- `test_tree_depth` - Depth calculation
- `test_with_builder_methods` - Builder pattern tests

## CSS Spec Compliance

### CSS 2.1 Section 9.2 (Box Generation)
- Elements generate boxes based on `display` property
- Text nodes generate inline text boxes
- Replaced elements generate atomic inline boxes

### CSS 2.1 Section 3.1 (Replaced Elements)
- Replaced elements have content outside CSS formatting model
- They have intrinsic dimensions and aspect ratios
- Layout uses intrinsic size when explicit dimensions not set

### CSS 2.1 Section 10.3.2 (Replaced Element Widths)
- Uses intrinsic width if no CSS width specified
- Maintains aspect ratio when only width or height set

## API Examples

### Creating Replaced Elements
```rust
let img = DOMNode::new_replaced(
    "img",
    style.clone(),
    "image.png",
    Some(Size::new(100.0, 50.0)),
);
```

### Using Builder Pattern
```rust
let node = DOMNode::new_element("img", style, vec![])
    .with_id("hero-image")
    .with_class("responsive")
    .with_src("hero.png")
    .with_intrinsic_size(Size::new(1920.0, 1080.0));
```

### Finding Boxes
```rust
let replaced_boxes = BoxGenerator::find_replaced_boxes(&tree.root);
let text_boxes = BoxGenerator::find_text_boxes(&tree.root);
let depth = BoxGenerator::tree_depth(&tree.root);
```

## Files Changed

| File | Changes |
|------|---------|
| `src/tree/box_generation.rs` | +350 lines: DOMNode fields, methods, BoxGenerator utilities, tests |

## Verification

```
cargo test --lib box_generation
# 51 passed

cargo test
# 150 passed; 0 failed; 5 ignored

cargo clippy --all-targets -- -D warnings
# No errors (vendor warnings only)

cargo fmt
# Applied formatting
```

## Future Work

1. **Anonymous Box Insertion**: W3.T02 will implement anonymous block and inline box creation
2. **Table Box Generation**: W3.T04 will handle table-specific box generation
3. **Form Element Handling**: Form elements (input, select, textarea) are also replaced elements

## Key Design Decisions

1. **Replaced elements ignore children**: Even if DOM children exist, replaced element boxes have no child boxes (per CSS spec)
2. **Aspect ratio optional**: Intrinsic size may not be known at generation time (lazy loading)
3. **ReplacedType carries source**: Source URL stored in enum variant for layout/painting phases
4. **Generic predicate search**: `find_boxes_by_predicate` enables flexible queries without adding specialized methods for every case
