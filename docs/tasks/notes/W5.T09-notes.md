# W5.T09 Pseudo-Element Box Generation - Implementation Notes

## Summary

This task implements CSS pseudo-element box generation for `::before` and `::after` pseudo-elements per CSS 2.1 Section 12.1. The implementation provides a complete system for generating boxes from pseudo-element content, supporting all display types and integrating with the existing box generation pipeline.

## Dependencies

- **W3.T01**: BoxGenerator structure and core generation logic (foundational)
- **CSS 2.1 Section 12.1**: The :before and :after pseudo-elements specification

## Implementation Details

### 1. Pseudo-Element Types

Created `PseudoElementType` enum to represent the two CSS pseudo-elements:

```rust
pub enum PseudoElementType {
    Before,  // ::before - inserted as first child
    After,   // ::after - inserted as last child
}
```

#### Type Methods
- `css_name()` - Returns "::before" or "::after"
- `short_name()` - Returns "before" or "after"
- `Display` trait implementation for string conversion

### 2. Content Property Values

Implemented `PseudoContent` enum for the CSS `content` property:

```rust
pub enum PseudoContent {
    None,           // No box generated
    Normal,         // Computes to none for pseudo-elements
    String(String), // Text content
    Multiple(Vec<PseudoContentItem>), // Concatenated content
    OpenQuote,      // Opening quote character
    CloseQuote,     // Closing quote character
    NoOpenQuote,    // Increment nesting, no content
    NoCloseQuote,   // Decrement nesting, no content
}
```

#### Content Items
```rust
pub enum PseudoContentItem {
    String(String),         // Literal text
    Attr(String),           // attr(name) - attribute value
    Counter(String),        // counter(name)
    CounterStyled(String, String), // counter(name, style)
    Counters(String, String),      // counters(name, separator)
    OpenQuote,
    CloseQuote,
    Url(String),            // URL for image content
}
```

### 3. Pseudo-Element Style

Created `PseudoElementStyle` to hold computed styles for pseudo-elements:

```rust
pub struct PseudoElementStyle {
    pub content: PseudoContent,  // What to generate
    pub display: Display,        // Box type (default: inline)
    pub computed: Arc<ComputedStyles>, // Full computed styles
}
```

#### Key Methods
- `with_string()` - Create style with string content
- `none()` - Create style with no content (no box)
- `generates_box()` - Check if content + display produces a box
- `with_display()` - Builder to set display type

### 4. Pseudo-Element Configuration

Created `PseudoElementConfig` to hold both pseudo-element styles:

```rust
pub struct PseudoElementConfig {
    pub before: Option<PseudoElementStyle>,
    pub after: Option<PseudoElementStyle>,
}
```

#### Configuration Methods
- `new()` - Empty configuration
- `with_before()` / `with_after()` / `with_both()` - Constructors
- `set_before()` / `set_after()` - Setters
- `get()` - Get style by type
- `has_generated_content()` / `has_before()` / `has_after()` - Predicates

### 5. Pseudo-Element Generator

The core generator class:

```rust
pub struct PseudoElementGenerator {
    include_debug_info: bool,
}
```

#### Generator Methods
- `new()` - Create with debug info enabled
- `without_debug_info()` - Create without debug info
- `generate_box()` - Generate box for a pseudo-element style
- `insert_pseudo_boxes()` - Insert boxes into children list

## Box Generation Flow

```
PseudoElementStyle
    │
    ├─> content.generates_box()? ──> false ──> return None
    │
    ├─> display == None? ──────────> true ───> return None
    │
    └─> content.to_text()? ────────> Some(text) ──┐
                                                  │
              ┌───────────────────────────────────┘
              │
              v
        Create text BoxNode
              │
              v
        create_container_box() based on display:
              │
              ├─> Block/FlowRoot/ListItem ──> new_block()
              │
              ├─> InlineBlock ──────────────> new_inline_block()
              │
              ├─> Flex ─────────────────────> new_block(Flex)
              │
              ├─> InlineFlex ───────────────> new_inline_block(Flex)
              │
              ├─> Grid ─────────────────────> new_block(Grid)
              │
              ├─> InlineGrid ───────────────> new_inline_block(Grid)
              │
              └─> _ (default inline) ───────> new_inline()
              │
              v
        Add debug info (if enabled)
              │
              v
        Return Some(BoxNode)
```

## Helper Functions

| Function | Purpose |
|----------|---------|
| `count_pseudo_boxes()` | Count pseudo-element boxes in tree |
| `find_pseudo_boxes()` | Find all pseudo-element boxes |
| `is_pseudo_box()` | Check if a box is a pseudo-element |
| `get_pseudo_type()` | Get pseudo-element type from box |

## CSS Spec Compliance

### CSS 2.1 Section 12.1 (The :before and :after pseudo-elements)

- ✅ `::before` content inserted as first child
- ✅ `::after` content inserted as last child
- ✅ Default display is inline
- ✅ `content: none` generates no box
- ✅ `display: none` generates no box
- ✅ Pseudo-elements inherit from originating element

### CSS 2.1 Section 12.2 (The 'content' property)

- ✅ String content supported
- ✅ `none` and `normal` values supported
- ✅ Quote values supported (OpenQuote, CloseQuote)
- ✅ Multiple content items concatenation
- ⏳ `attr()` function (needs runtime resolution)
- ⏳ `counter()` functions (needs counter system)
- ⏳ URL content (needs image loading)

## Test Coverage

Created 121 tests total (41 unit tests + 80 integration tests):

### Unit Tests (in src/tree/pseudo_elements.rs)
- PseudoElementType tests (5)
- PseudoContent tests (7)
- PseudoElementStyle tests (5)
- PseudoElementConfig tests (6)
- PseudoElementGenerator tests (12)
- Helper function tests (6)

### Integration Tests (in tests/tree_pseudo_test.rs)
- Type property tests (4)
- Content behavior tests (13)
- Content item tests (6)
- Style tests (7)
- Config tests (11)
- Generator tests (15)
- Insert pseudo boxes tests (7)
- Helper function tests (9)
- Edge cases (8)

## API Examples

### Creating Pseudo-Element Styles

```rust
// String content with default inline display
let style = PseudoElementStyle::with_string("» ", default_style());

// Block display pseudo-element
let style = PseudoElementStyle::with_string("Header")
    .with_display(Display::Block);

// No content (no box generated)
let style = PseudoElementStyle::none(default_style());
```

### Using Configuration

```rust
// Configure both pseudo-elements
let config = PseudoElementConfig::with_both(
    PseudoElementStyle::with_string("Before: ", styles.clone()),
    PseudoElementStyle::with_string(" :After", styles.clone()),
);

// Check if any content generated
if config.has_generated_content() {
    // ...
}
```

### Generating Boxes

```rust
let generator = PseudoElementGenerator::new();

// Generate a single pseudo-element box
if let Some(box_node) = generator.generate_box(
    PseudoElementType::Before,
    &style,
) {
    // Use the generated box
}

// Insert pseudo boxes into existing children
let children_with_pseudo = generator.insert_pseudo_boxes(
    children,
    &config,
);
```

### Finding Pseudo Boxes

```rust
// Count pseudo-elements in tree
let count = count_pseudo_boxes(&root);

// Find all pseudo-element boxes
let pseudo_boxes = find_pseudo_boxes(&root);

// Check if a box is a pseudo-element
if is_pseudo_box(&node) {
    match get_pseudo_type(&node) {
        Some(PseudoElementType::Before) => { /* ... */ }
        Some(PseudoElementType::After) => { /* ... */ }
        None => { /* Not a pseudo-element */ }
    }
}
```

## Files Changed

| File | Changes |
|------|---------|
| `src/tree/pseudo_elements.rs` | +600 lines: New module implementing pseudo-element box generation |
| `src/tree/mod.rs` | +10 lines: Module declaration and re-exports |
| `tests/tree_pseudo_test.rs` | +850 lines: Comprehensive integration tests |

## Verification

```
cargo test pseudo
# 121 passed (41 unit + 80 integration)

cargo test --test tree_pseudo_test
# 80 passed; 0 failed; 0 ignored

cargo clippy -p fastrender --lib
# No errors in pseudo_elements module

cargo fmt
# Applied formatting
```

## Future Work

1. **Content Function Resolution**: Implement `attr()`, `counter()`, `counters()` functions
2. **URL Content**: Support image content via `url()` in content property
3. **Quote Nesting**: Track quote nesting level for proper quote character selection
4. **Integration with Box Generator**: Add pseudo-element configuration to DOMNode and integrate with BoxGenerator::generate()
5. **CSS Parser Integration**: Parse pseudo-element selectors and content property from stylesheets

## Key Design Decisions

1. **Separate from main box generation**: Pseudo-element generation is a distinct phase that can be applied after initial box tree construction

2. **Debug info for identification**: Pseudo-element boxes carry debug info with "pseudo-element" class and tag name ("before"/"after") for tree traversal

3. **Display type support**: All display types are supported, not just inline, per modern CSS specs

4. **Content string resolution**: Content items that need context (attr, counter) return None from `to_text()` and need separate resolution phase

5. **Configuration pattern**: Using `PseudoElementConfig` allows both pseudo-elements to be managed together, matching how they're typically used in CSS
