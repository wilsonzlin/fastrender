# W3.T15: Font Loading & Caching - Dependency Notes

## Overview

This task extends the existing font system (W3.T14) with font metrics extraction and scaling for text layout. The additions enable:

- Font metrics extraction from loaded fonts
- Scaled metrics for pixel-based layout calculations
- Direct ttf-parser access for advanced operations

## Files Modified

- `src/text/font_db.rs` - Added FontMetrics, ScaledMetrics, and LoadedFont methods
- `src/text/mod.rs` - Updated exports to include new types

## Key Types

### FontMetrics

Font metrics in font design units. Must be scaled for a specific font size.

```rust
use fastrender::text::{FontDatabase, FontWeight, FontStyle, FontMetrics};

let db = FontDatabase::new();
if let Some(id) = db.query("sans-serif", FontWeight::NORMAL, FontStyle::Normal) {
    let font = db.load_font(id).unwrap();
    let metrics = font.metrics().unwrap();

    println!("Units per em: {}", metrics.units_per_em);
    println!("Ascent: {}", metrics.ascent);
    println!("Descent: {}", metrics.descent);
    println!("Line height: {}", metrics.line_height);
}
```

Fields:
- `units_per_em: u16` - Font design units (typically 1000 or 2048)
- `ascent: i16` - Distance above baseline (positive)
- `descent: i16` - Distance below baseline (typically negative)
- `line_gap: i16` - Additional line spacing
- `line_height: i16` - Computed: ascent - descent + line_gap
- `x_height: Option<i16>` - Height of lowercase 'x'
- `cap_height: Option<i16>` - Height of uppercase letters
- `underline_position/thickness: i16` - Underline positioning
- `strikeout_position/thickness: Option<i16>` - Strikeout positioning
- `is_bold, is_italic, is_monospace: bool` - Style flags

### ScaledMetrics

Pre-computed metrics for a specific font size in pixels.

```rust
let metrics = font.metrics().unwrap();
let scaled = metrics.scale(16.0); // 16px font

println!("Ascent: {}px", scaled.ascent);
println!("Descent: {}px", scaled.descent);
println!("Line height: {}px", scaled.line_height);
println!("Total height: {}px", scaled.total_height());
println!("Baseline offset: {}px", scaled.baseline_offset());
```

Fields:
- `font_size: f32` - Font size in pixels
- `scale: f32` - Scale factor (font_size / units_per_em)
- `ascent: f32` - Pixels above baseline
- `descent: f32` - Pixels below baseline (positive)
- `line_gap: f32` - Line gap in pixels
- `line_height: f32` - Line height in pixels
- `x_height, cap_height: Option<f32>` - Typography heights
- `underline_position/thickness: f32` - Underline metrics

Methods:
- `baseline_offset()` - Returns ascent (baseline from top of line box)
- `total_height()` - Returns ascent + descent
- `with_line_height_factor(factor)` - Apply CSS line-height multiplier
- `with_line_height(height)` - Set explicit line height

### LoadedFont Methods

```rust
// Get metrics
let metrics = font.metrics()?;

// Get ttf-parser face for advanced operations
let face = font.as_ttf_face()?;
```

## Usage in Layout

### Line Box Calculations

```rust
let font = ctx.get_sans_serif().unwrap();
let metrics = font.metrics().unwrap();
let scaled = metrics.scale(font_size);

// Line box height
let line_box_height = scaled.line_height;

// Baseline position from top of line box
let baseline_y = scaled.baseline_offset();

// Half-leading calculation (for vertical centering)
let half_leading = (scaled.line_height - scaled.total_height()) / 2.0;
```

### CSS line-height: normal

```rust
let normal_lh = metrics.normal_line_height(font_size);
```

### Line-height with multiplier (e.g., 1.5)

```rust
let scaled = metrics.scale(16.0);
let with_factor = scaled.with_line_height_factor(1.5);
assert_eq!(with_factor.line_height, 24.0);
```

## Dependencies for Downstream Tasks

### W3.T16: Text Shaping

Use `as_ttf_face()` for rustybuzz integration:

```rust
let font = ctx.get_font(&families, weight, italic, oblique).unwrap();

// For rustybuzz
let face = rustybuzz::Face::from_slice(&font.data, font.index).unwrap();

// Or via ttf-parser
let ttf_face = font.as_ttf_face().unwrap();
```

### W3.T17: Inline Layout

Use ScaledMetrics for inline box calculations:

```rust
let scaled = metrics.scale(font_size);

// Baseline alignment
let baseline_from_top = scaled.baseline_offset();

// Line box sizing
let content_height = scaled.total_height();

// Apply CSS line-height
let line_box = if let Some(lh) = computed_line_height {
    scaled.with_line_height(lh)
} else {
    scaled.with_line_height(metrics.normal_line_height(font_size))
};
```

## CSS Specification References

- CSS Inline Layout Module Level 3: <https://www.w3.org/TR/css-inline-3/>
- CSS line-height: <https://www.w3.org/TR/css-inline-3/#line-height>

## Testing

```bash
cargo test text::font_db  # 27 tests including 7 new metrics tests
```
