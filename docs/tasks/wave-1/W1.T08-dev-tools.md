---
task_id: "W1.T08"
title: "Setup Development Tools"
wave: 1
estimated_hours: 3-4
depends_on: []
inputs: []
outputs:
  - ".rustfmt.toml"
  - "clippy.toml"
  - ".github/workflows/ci.yml"
  - "justfile"
  - "CONTRIBUTING.md"
  - "outputs/notes/W1.T08-notes.md"
skills_required:
  - "Rust tooling (rustfmt, clippy)"
  - "GitHub Actions CI/CD"
  - "Justfile/Make"
  - "Technical writing"
context_files:
  - "docs/plan/01-type-system.md"
  - "docs/tasks/TASK_TEMPLATE.md"
verification:
  - "cargo fmt --check"
  - "cargo clippy -- -D warnings"
  - "just test"
  - "git add .github/workflows/ci.yml && git status"
---

# Setup Development Tools

## Context

A professional Rust project needs robust development tooling to maintain code quality, consistency, and developer productivity. Developers should be able to format code automatically, catch common mistakes with linting, run tests easily, and verify their changes pass CI before pushing.

In FastRender V2, we're establishing best practices from the start. The development tools setup is a Wave 1 foundation task, meaning it has **no dependencies** and enables all future development to follow consistent standards.

### Background

**Rust Development Tools:**
- **rustfmt**: Automatic code formatting
- **clippy**: Linting and common mistake detection
- **cargo test**: Test runner
- **GitHub Actions**: Continuous integration

**Build Automation:**
- **just**: Modern command runner (like make but better)
- **cargo-deny**: License and dependency checking
- **cargo-nextest**: Faster test runner (optional)

**Goals:**
- Zero configuration for new contributors
- Automatic formatting on save (via editor integration)
- Catch mistakes before they reach CI
- Fast, reliable CI pipeline
- Clear contribution guidelines

### Why This Matters

Without proper development tools setup:
- Code style becomes inconsistent across contributors
- Common mistakes make it to code review
- CI failures surprise developers
- New contributors struggle to get started
- Technical debt accumulates from lack of linting

Every contributor to Waves 2-6 depends on these tools. Get them right and development is smooth; get them wrong and every PR becomes a formatting/linting nightmare.

## Prerequisites

### Required Knowledge
- **Rust basics**: cargo commands, toolchain
- **GitHub Actions**: YAML syntax, workflow concepts
- **Justfile syntax**: Basic command runner patterns
- **Markdown**: For CONTRIBUTING.md

### Required Reading
1. **rustfmt documentation**: https://rust-lang.github.io/rustfmt/
2. **clippy documentation**: https://doc.rust-lang.org/clippy/
3. **GitHub Actions Quickstart**: https://docs.github.com/en/actions/quickstart
4. **just documentation**: https://github.com/casey/just

## Inputs

### From Dependencies

**None** - This is a Wave 1 task with no dependencies.

### Existing Code

The project already has:
- `Cargo.toml` - Basic package configuration
- `.gitignore` - Git ignore patterns
- Some source files that need consistent formatting

We'll be adding:
- `.rustfmt.toml` - Formatting configuration
- `clippy.toml` - Linting configuration
- `.github/workflows/ci.yml` - CI pipeline
- `justfile` - Command shortcuts
- `CONTRIBUTING.md` - Contributor guidelines

## Objectives

### Primary Goals

1. **Configure rustfmt**: Define project code style (120 char lines, edition 2021)
2. **Configure clippy**: Enable strict lints to catch common mistakes
3. **Setup GitHub Actions CI**: Automated testing, linting, formatting checks
4. **Create justfile**: Common development task shortcuts
5. **Write CONTRIBUTING.md**: Clear guidelines for contributors
6. **Optional: Setup pre-commit hooks**: Catch issues before commit

### Success Criteria

- [ ] `.rustfmt.toml` created with project style preferences
- [ ] `clippy.toml` created with strict lint configuration
- [ ] `.github/workflows/ci.yml` created with test, clippy, fmt checks
- [ ] `justfile` created with common task shortcuts
- [ ] `CONTRIBUTING.md` created with clear workflow documentation
- [ ] Existing code formatted: `cargo fmt`
- [ ] Existing code passes clippy: `cargo clippy -- -D warnings`
- [ ] CI workflow validates on push
- [ ] All just commands work: `just test`, `just lint`, etc.
- [ ] Notes file created with all sections filled

## Implementation Guide

### Step 1: Create .rustfmt.toml (Estimated: 20min)

**What to do:**
1. Create `.rustfmt.toml` in project root
2. Configure formatting preferences
3. Test on existing code

**Code:**

Create `.rustfmt.toml`:

```toml
# FastRender rustfmt configuration
#
# This file defines the code style for the FastRender project.
# All code should be formatted with `cargo fmt` before committing.

# Use Rust 2021 edition features
edition = "2021"

# Maximum line width
# Default is 100, we use 120 for better use of modern wide screens
max_width = 120

# Maximum width for comments
# Keep comments slightly shorter than code for readability
comment_width = 100

# Hard tabs or spaces
# Spaces are standard in Rust ecosystem
hard_tabs = false

# Number of spaces per tab
tab_spaces = 4

# Use trailing commas for multiline constructs
# Makes diffs cleaner when adding items
trailing_comma = "Vertical"

# Where to put the opening brace of functions
# "SameLineWhere" is Rust standard style
fn_brace_style = "SameLineWhere"

# Where to put the opening brace of other items
brace_style = "SameLineWhere"

# Allow single line if statements
# Prevents overly verbose code for simple conditions
single_line_if_else_max_width = 50

# Format strings
# Automatically format string literals
format_strings = true

# Format code in doc comments
# Ensures examples in rustdoc are formatted
format_code_in_doc_comments = true

# Format macro bodies
# Keep macro definitions formatted too
format_macro_bodies = true

# Normalize comments
# Standardize comment style
normalize_comments = true

# Normalize doc attributes
# Use /// instead of /** */
normalize_doc_attributes = true

# Wrap comments at comment_width
wrap_comments = true

# Reorder imports
# Alphabetically sort use statements
reorder_imports = true

# Reorder modules
# Alphabetically sort mod declarations
reorder_modules = true

# Use field init shorthand when possible
# foo: foo -> foo
use_field_init_shorthand = true

# Use try! macro or ? operator
# Always prefer ? over try!
use_try_shorthand = true

# Group imports
# Group std, external, and internal imports
imports_granularity = "Crate"

# Merge imports from the same crate
group_imports = "StdExternalCrate"

# Newline style
# Unix line endings
newline_style = "Unix"

# Remove extra blank lines
blank_lines_upper_bound = 1

# Chain formatting
# How to format method chains
chain_width = 60

# Array formatting
# Use visual indentation for arrays
array_width = 80

# Struct formatting
# Use block indent for structs
struct_variant_width = 50

# Match block formatting
match_arm_blocks = true
match_arm_leading_pipes = "Never"

# Overflow behavior
overflow_delimited_expr = true

# Version - use stable features only
# Update this when we want to use nightly-only rustfmt features
# Currently using stable
# version = "Two"  # Uncomment when using nightly

# Unstable features (require nightly rustfmt)
# Uncomment if switching to nightly toolchain
# unstable_features = true
# format_macro_matchers = true
# imports_granularity = "Module"
```

**Test it:**

```bash
# Format all code
cargo fmt

# Check if code is formatted (CI mode)
cargo fmt --check

# Format specific file
cargo fmt --check -- src/lib.rs
```

### Step 2: Create clippy.toml (Estimated: 30min)

**What to do:**
1. Create `clippy.toml` in project root
2. Configure strict lints
3. Test on existing code and fix any issues

**Code:**

Create `clippy.toml`:

```toml
# FastRender clippy configuration
#
# This file configures clippy linting for the FastRender project.
# Run with: cargo clippy -- -D warnings

# Complexity limits
# Increase from defaults as layout algorithms can be complex
cognitive-complexity-threshold = 30
type-complexity-threshold = 500

# Avoid certain names
# Prevent variable names that shadow common items
disallowed-names = ["foo", "bar", "baz"]

# Documentation
# Require documentation for public items
# This is enforced via rustdoc, not clippy config

# Arithmetic side-effects
# Be more permissive than default for graphics calculations
# arithmetic-side-effects-allowed = true  # Requires nightly

# Cyclomatic complexity
# Layout algorithms can be complex
cyclomatic-complexity-threshold = 30

# Allow certain types to be passed by value even if large
# For example, tiny-skia types are designed to be passed by value
# pass-by-value-size-limit = 256  # Requires nightly
```

**Note**: Most clippy configuration is done via attributes in code or cargo commands, not `clippy.toml`. The real configuration happens in the next step.

**Test it:**

```bash
# Run clippy with all warnings as errors
cargo clippy -- -D warnings

# Run clippy on all targets (including tests, benches)
cargo clippy --all-targets -- -D warnings

# Fix auto-fixable issues
cargo clippy --fix
```

### Step 3: Configure Clippy Lints in lib.rs (Estimated: 30min)

**What to do:**
1. Add clippy lint configuration to `src/lib.rs`
2. Enable strict lints, allow some pedantic ones selectively
3. Document why lints are allowed/denied

**Code:**

Add to the top of `src/lib.rs`:

```rust
// ============================================================================
// Clippy Configuration
// ============================================================================

// Deny clippy warnings in CI
#![deny(clippy::all)]
#![warn(clippy::pedantic)]
#![warn(clippy::nursery)]

// Allow some pedantic lints that are too strict or not applicable

// Allow module name repetition - often clearer to repeat
// Example: geometry::Point instead of geometry::P
#![allow(clippy::module_name_repetitions)]

// Allow similar names - layout algorithms have similar variables
// Example: min_width, max_width, width
#![allow(clippy::similar_names)]

// Allow too many lines - some layout algorithms are necessarily long
#![allow(clippy::too_many_lines)]

// Allow struct excessive bools - style properties often have many bools
#![allow(clippy::struct_excessive_bools)]

// Allow missing errors doc - we document errors at module level
#![allow(clippy::missing_errors_doc)]

// Allow missing panics doc - most panics are from logic errors, not expected panics
#![allow(clippy::missing_panics_doc)]

// Allow cast precision loss - we intentionally cast for layout calculations
#![allow(clippy::cast_precision_loss)]

// Allow cast possible truncation - we handle this carefully in layout
#![allow(clippy::cast_possible_truncation)]

// Allow cast sign loss - unsigned/signed conversions are common in graphics
#![allow(clippy::cast_sign_loss)]

// Allow float arithmetic - we're a rendering engine, floats are fundamental
#![allow(clippy::float_arithmetic)]

// Performance lints - be very strict
#![deny(clippy::unnecessary_clone)]
#![deny(clippy::needless_collect)]
#![deny(clippy::redundant_clone)]

// Correctness lints - always deny
#![deny(clippy::absurd_extreme_comparisons)]
#![deny(clippy::await_holding_lock)]
#![deny(clippy::inherent_to_string)]

// Style lints - warn to encourage good style
#![warn(clippy::explicit_iter_loop)]
#![warn(clippy::explicit_into_iter_loop)]
#![warn(clippy::inconsistent_struct_constructor)]
#![warn(clippy::map_unwrap_or)]

// Documentation lints
#![warn(missing_docs)]
#![warn(clippy::missing_docs_in_private_items)]

// Note: The second missing_docs_in_private_items might be too strict initially
// Can remove if it causes too much noise during development

//! FastRender: High-performance Rust HTML/CSS to image renderer
//!
//! [... rest of existing module documentation ...]
```

### Step 4: Create GitHub Actions CI (Estimated: 45min)

**What to do:**
1. Create `.github/workflows/ci.yml`
2. Configure test, clippy, fmt, and doc jobs
3. Add caching for faster builds
4. Test the workflow

**Code:**

First create the directory:

```bash
mkdir -p .github/workflows
```

Then create `.github/workflows/ci.yml`:

```yaml
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ===========================================================================
  # Test Job - Run all tests
  # ===========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust:
          - stable
          - beta
          # Uncomment to test on nightly
          # - nightly
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests
        run: cargo test --all-features --verbose

      - name: Run doc tests
        run: cargo test --doc --all-features --verbose

  # ===========================================================================
  # Clippy Job - Linting
  # ===========================================================================
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # ===========================================================================
  # Format Job - Check code formatting
  # ===========================================================================
  format:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  # ===========================================================================
  # Docs Job - Check documentation builds
  # ===========================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build documentation
        run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings

  # ===========================================================================
  # Dependency Audit Job - Check for security vulnerabilities
  # ===========================================================================
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

  # ===========================================================================
  # Coverage Job (Optional) - Measure test coverage
  # ===========================================================================
  # Uncomment when ready to track coverage
  # coverage:
  #   name: Coverage
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Install Rust toolchain
  #       uses: dtolnay/rust-toolchain@stable
  #
  #     - name: Install tarpaulin
  #       run: cargo install cargo-tarpaulin
  #
  #     - name: Generate coverage
  #       run: cargo tarpaulin --out Xml --all-features
  #
  #     - name: Upload coverage to Codecov
  #       uses: codecov/codecov-action@v3
  #       with:
  #         files: ./cobertura.xml
```

**Test it:**

GitHub Actions will run automatically on push/PR. To test locally:

```bash
# Install act (GitHub Actions local runner)
# https://github.com/nektos/act

# Run CI locally
act
```

### Step 5: Create justfile (Estimated: 30min)

**What to do:**
1. Create `justfile` in project root
2. Add shortcuts for common development tasks
3. Test all commands

**Code:**

Create `justfile`:

```makefile
# FastRender justfile
#
# Just is a command runner (like make but better)
# Install: cargo install just
# Run: just <command>
# List all commands: just --list

# Default recipe - show available commands
default:
    @just --list

# ===========================================================================
# Building
# ===========================================================================

# Build the project in debug mode
build:
    cargo build

# Build the project in release mode
build-release:
    cargo build --release

# Clean build artifacts
clean:
    cargo clean

# ===========================================================================
# Testing
# ===========================================================================

# Run all tests
test:
    cargo test --all-features --verbose

# Run tests with output shown
test-output:
    cargo test --all-features --verbose -- --nocapture

# Run a specific test
test-one TEST:
    cargo test {{TEST}} -- --nocapture

# Run tests and show coverage (requires cargo-tarpaulin)
coverage:
    cargo tarpaulin --out Html --output-dir coverage --all-features

# ===========================================================================
# Code Quality
# ===========================================================================

# Format all code
fmt:
    cargo fmt --all

# Check if code is formatted
fmt-check:
    cargo fmt --all -- --check

# Run clippy linter
lint:
    cargo clippy --all-targets --all-features -- -D warnings

# Fix auto-fixable clippy issues
fix:
    cargo clippy --fix --allow-dirty --all-targets --all-features

# Run all checks (fmt, clippy, test)
check: fmt-check lint test

# ===========================================================================
# Documentation
# ===========================================================================

# Build and open documentation
doc:
    cargo doc --no-deps --all-features --open

# Build documentation without opening
doc-build:
    cargo doc --no-deps --all-features

# Check documentation builds without warnings
doc-check:
    RUSTDOCFLAGS="-D warnings" cargo doc --no-deps --all-features

# ===========================================================================
# Benchmarking
# ===========================================================================

# Run benchmarks
bench:
    cargo bench

# ===========================================================================
# CI Simulation
# ===========================================================================

# Run all CI checks locally
ci: fmt-check lint test doc-check
    @echo "‚úÖ All CI checks passed!"

# ===========================================================================
# Development
# ===========================================================================

# Watch for changes and run tests
watch:
    cargo watch -x test

# Watch for changes and run specific test
watch-one TEST:
    cargo watch -x "test {{TEST}}"

# ===========================================================================
# Release
# ===========================================================================

# Build optimized release binary
release:
    cargo build --release

# ===========================================================================
# Dependencies
# ===========================================================================

# Update dependencies
update:
    cargo update

# Check for outdated dependencies
outdated:
    cargo outdated

# Audit dependencies for security vulnerabilities
audit:
    cargo audit

# ===========================================================================
# Utilities
# ===========================================================================

# Count lines of code (requires tokei)
loc:
    tokei

# Show dependency tree
tree:
    cargo tree

# Install development dependencies
install-dev-tools:
    cargo install cargo-watch
    cargo install cargo-tarpaulin
    cargo install cargo-outdated
    cargo install cargo-audit
    cargo install tokei
    @echo "‚úÖ Development tools installed!"
```

**Test it:**

```bash
# Install just if not installed
cargo install just

# Test commands
just --list
just build
just test
just lint
just fmt
just check
```

### Step 6: Create CONTRIBUTING.md (Estimated: 45min)

**What to do:**
1. Create `CONTRIBUTING.md` in project root
2. Document development workflow
3. Explain code style, testing, and PR process

**Code:**

Create `CONTRIBUTING.md`:

```markdown
# Contributing to FastRender

Thank you for your interest in contributing to FastRender! This document provides guidelines and instructions for contributing.

## Table of Contents

- [Getting Started](#getting-started)
- [Development Setup](#development-setup)
- [Development Workflow](#development-workflow)
- [Code Style](#code-style)
- [Testing](#testing)
- [Pull Request Process](#pull-request-process)
- [Project Structure](#project-structure)
- [Common Tasks](#common-tasks)

## Getting Started

### Prerequisites

- **Rust**: Install from [rustup.rs](https://rustup.rs/)
  - Minimum version: 1.70
  - Recommended: Latest stable
- **just**: Command runner - `cargo install just`
- **Optional tools**: See [Development Tools](#development-tools)

### Clone the Repository

```bash
git clone https://github.com/fastrender/fastrender.git
cd fastrender
```

### Build and Test

```bash
# Build the project
cargo build

# Run tests
cargo test

# Or use just
just build
just test
```

If everything builds and tests pass, you're ready to contribute!

## Development Setup

### Editor Configuration

We recommend VS Code with the following extensions:
- **rust-analyzer**: Rust language server
- **CodeLLDB**: Debugging support
- **Even Better TOML**: TOML syntax highlighting

**VS Code Settings** (`.vscode/settings.json`):

```json
{
  "rust-analyzer.checkOnSave.command": "clippy",
  "editor.formatOnSave": true,
  "editor.rulers": [120],
  "[rust]": {
    "editor.defaultFormatter": "rust-lang.rust-analyzer"
  }
}
```

### Development Tools

Install recommended development tools:

```bash
just install-dev-tools
```

This installs:
- `cargo-watch`: Auto-rebuild on file changes
- `cargo-tarpaulin`: Code coverage
- `cargo-outdated`: Check for outdated dependencies
- `cargo-audit`: Security vulnerability scanning
- `tokei`: Line counter

## Development Workflow

### 1. Create a Branch

```bash
git checkout -b feature/your-feature-name
# or
git checkout -b fix/your-bug-fix
```

**Branch naming conventions**:
- `feature/name` - New features
- `fix/name` - Bug fixes
- `refactor/name` - Code refactoring
- `docs/name` - Documentation updates
- `test/name` - Test additions/improvements

### 2. Make Changes

- Write code following our [code style guidelines](#code-style)
- Add tests for new functionality
- Update documentation as needed
- Run checks locally before committing

### 3. Run Pre-Commit Checks

Before committing, ensure all checks pass:

```bash
just check
```

This runs:
- `cargo fmt --check` - Format check
- `cargo clippy` - Linting
- `cargo test` - All tests

### 4. Commit Changes

Write clear, descriptive commit messages:

```bash
git add .
git commit -m "Add support for CSS grid auto-placement"
```

**Commit message guidelines**:
- Use imperative mood ("Add feature" not "Added feature")
- First line: 50 characters or less
- Body: Wrap at 72 characters
- Reference issues: "Fixes #123" or "Relates to #456"

Example:
```
Add CSS grid auto-placement algorithm

Implements the auto-placement algorithm from CSS Grid Level 1 spec.
This handles placing grid items that don't have explicit positions.

Fixes #123
```

### 5. Push and Create PR

```bash
git push origin feature/your-feature-name
```

Then create a pull request on GitHub.

## Code Style

### Formatting

All code must be formatted with `rustfmt`:

```bash
just fmt
```

Our formatting rules (`.rustfmt.toml`):
- **Max line width**: 120 characters
- **Tab width**: 4 spaces
- **Trailing commas**: Vertical
- **Import order**: Alphabetical, grouped by std/external/crate

### Linting

All code must pass clippy with no warnings:

```bash
just lint
```

We use strict clippy settings:
- `#![deny(clippy::all)]` - All clippy warnings are errors
- `#![warn(clippy::pedantic)]` - Pedantic lints enabled
- Some pedantic lints are allowed (see `src/lib.rs` for details)

### Naming Conventions

- **Types**: `PascalCase` - `BoxNode`, `ComputedStyle`
- **Functions/methods**: `snake_case` - `compute_layout`, `parse_css`
- **Constants**: `SCREAMING_SNAKE_CASE` - `DEFAULT_FONT_SIZE`
- **Modules**: `snake_case` - `geometry`, `text_shaping`

### Documentation

All public items must have rustdoc comments:

```rust
/// Computes the layout for a box tree
///
/// This function takes a box tree and viewport size, runs the layout
/// algorithm, and returns a positioned fragment tree.
///
/// # Arguments
///
/// * `box_tree` - The root of the box tree
/// * `viewport` - The viewport size in CSS pixels
///
/// # Returns
///
/// A positioned fragment tree ready for painting.
///
/// # Examples
///
/// ```
/// use fastrender::layout::compute_layout;
/// use fastrender::geometry::Size;
///
/// let viewport = Size::new(1024.0, 768.0);
/// let fragments = compute_layout(&box_tree, viewport);
/// ```
pub fn compute_layout(box_tree: &BoxNode, viewport: Size) -> FragmentTree {
    // ...
}
```

**Documentation requirements**:
- Summary line (first line)
- Detailed description
- Arguments (if any)
- Return value
- Examples (for public APIs)
- Panics (if the function can panic)
- Errors (if the function returns Result)

### Error Handling

- Use `Result<T, Error>` for recoverable errors
- Use `panic!` only for programmer errors (bugs)
- Provide helpful error messages
- Chain errors with `thiserror`

Example:

```rust
use crate::{Error, Result};

pub fn parse_color(input: &str) -> Result<Color> {
    csscolorparser::parse(input)
        .map_err(|e| Error::Parse(ParseError::InvalidColor {
            input: input.to_string(),
            source: e,
        }))
}
```

## Testing

### Writing Tests

- Write unit tests in the same file as the code
- Write integration tests in `tests/`
- Test public APIs and edge cases
- Use descriptive test names

Example:

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_point_translate() {
        let p1 = Point::new(10.0, 20.0);
        let p2 = Point::new(5.0, 3.0);
        let result = p1.translate(p2);

        assert_eq!(result, Point::new(15.0, 23.0));
    }

    #[test]
    fn test_rect_intersection_non_overlapping() {
        let r1 = Rect::from_xywh(0.0, 0.0, 10.0, 10.0);
        let r2 = Rect::from_xywh(20.0, 20.0, 10.0, 10.0);

        assert_eq!(r1.intersection(r2), None);
    }
}
```

### Running Tests

```bash
# Run all tests
just test

# Run specific test
just test-one test_point_translate

# Run with output
just test-output

# Watch mode (auto-run on file changes)
just watch
```

### Test Coverage

We aim for >80% code coverage:

```bash
just coverage
```

Open `coverage/index.html` to view the coverage report.

## Pull Request Process

### Before Submitting

1. ‚úÖ All tests pass: `just test`
2. ‚úÖ Code is formatted: `just fmt`
3. ‚úÖ No clippy warnings: `just lint`
4. ‚úÖ Documentation builds: `just doc-check`
5. ‚úÖ All CI checks pass: `just ci`

### PR Description Template

```markdown
## Summary

Brief description of changes.

## Motivation

Why is this change needed? What problem does it solve?

## Changes

- List of specific changes
- Made to the codebase

## Testing

How was this tested?
- [ ] Unit tests added
- [ ] Integration tests added
- [ ] Manual testing performed

## Checklist

- [ ] Tests pass locally
- [ ] Code is formatted
- [ ] No clippy warnings
- [ ] Documentation updated
- [ ] CHANGELOG.md updated (if applicable)

## Related Issues

Fixes #123
Relates to #456
```

### Review Process

1. **Automated checks**: CI must pass
2. **Code review**: At least one maintainer approval required
3. **Changes requested**: Address feedback and push updates
4. **Approval**: Maintainer approves and merges

## Project Structure

```
fastrender/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ lib.rs              # Crate root, public API
‚îÇ   ‚îú‚îÄ‚îÄ geometry.rs         # Geometric types
‚îÇ   ‚îú‚îÄ‚îÄ error.rs            # Error types
‚îÇ   ‚îú‚îÄ‚îÄ tree/               # DOM and box tree structures
‚îÇ   ‚îú‚îÄ‚îÄ layout/             # Layout algorithms
‚îÇ   ‚îú‚îÄ‚îÄ style/              # CSS cascade and styles
‚îÇ   ‚îú‚îÄ‚îÄ text/               # Text shaping and fonts
‚îÇ   ‚îî‚îÄ‚îÄ paint/              # Painting and rasterization
‚îú‚îÄ‚îÄ tests/                  # Integration tests
‚îú‚îÄ‚îÄ benches/                # Benchmarks
‚îú‚îÄ‚îÄ docs/                   # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ plan/               # Architecture and planning docs
‚îÇ   ‚îî‚îÄ‚îÄ tasks/              # Task breakdown
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ ci.yml          # GitHub Actions CI
‚îú‚îÄ‚îÄ Cargo.toml              # Package manifest
‚îú‚îÄ‚îÄ justfile                # Development commands
‚îî‚îÄ‚îÄ CONTRIBUTING.md         # This file
```

## Common Tasks

### Running the Renderer

```bash
# Build and run
cargo run --example basic

# Build release binary
just release
./target/release/fastrender
```

### Adding a New Module

1. Create module file: `src/modulename/mod.rs`
2. Add module declaration to `src/lib.rs`: `pub mod modulename;`
3. Re-export public types: `pub use modulename::PublicType;`
4. Add module documentation
5. Add tests

### Adding a Dependency

1. Add to `Cargo.toml` under appropriate section
2. Document why the dependency is needed
3. Run `cargo build` to update `Cargo.lock`
4. Commit both `Cargo.toml` and `Cargo.lock`

### Benchmarking

```bash
# Run all benchmarks
just bench

# Run specific benchmark
cargo bench --bench render_benchmark
```

### Debugging

Use `rust-lldb` or VS Code debugger:

```bash
# Set breakpoint in code
// ...
let result = compute_layout(&box_tree);
// Breakpoint here

# Run with debugger
rust-lldb target/debug/fastrender
```

## Getting Help

- **Documentation**: Run `just doc` to view API docs
- **Issues**: Check existing issues or create a new one
- **Discussions**: Use GitHub Discussions for questions
- **Discord**: Join our Discord server (link in README)

## Code of Conduct

We follow the Rust Code of Conduct: https://www.rust-lang.org/policies/code-of-conduct

Be respectful, inclusive, and constructive.

## License

By contributing, you agree that your contributions will be licensed under the same license as the project (MIT OR Apache-2.0).

---

Thank you for contributing to FastRender! üé®
```

### Step 7: Optional - Setup Pre-Commit Hooks (Estimated: 20min)

**What to do:**
1. Create `.git/hooks/pre-commit` script
2. Run fmt and clippy before allowing commits
3. Make it fast enough to not slow down workflow

**Code:**

Create `.git/hooks/pre-commit`:

```bash
#!/bin/bash
#
# FastRender pre-commit hook
#
# This hook runs before each commit to ensure code quality.
# To bypass: git commit --no-verify

set -e

echo "üîç Running pre-commit checks..."

# Check if this is a rebase/merge
if [ -d .git/rebase-merge ] || [ -d .git/rebase-apply ]; then
    echo "‚è≠Ô∏è  Skipping pre-commit hook during rebase"
    exit 0
fi

# Format check
echo "üìù Checking formatting..."
if ! cargo fmt --all -- --check; then
    echo "‚ùå Code is not formatted. Run: just fmt"
    exit 1
fi

# Clippy check (only on staged files for speed)
echo "üîß Running clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    echo "‚ùå Clippy found issues. Run: just lint"
    exit 1
fi

# Quick test run (optional - can be slow)
# Uncomment if you want tests to run on every commit
# echo "üß™ Running tests..."
# if ! cargo test --quiet; then
#     echo "‚ùå Tests failed. Run: just test"
#     exit 1
# fi

echo "‚úÖ All pre-commit checks passed!"
exit 0
```

Make it executable:

```bash
chmod +x .git/hooks/pre-commit
```

**Note**: Pre-commit hooks are local and not committed to the repository. Each developer needs to set them up individually. Consider documenting this in CONTRIBUTING.md.

### Step 8: Verification (Estimated: 20min)

**What to do:**
1. Format all existing code
2. Fix any clippy warnings
3. Verify CI workflow
4. Test just commands

**Commands:**

```bash
# Format all code
just fmt

# Fix auto-fixable clippy issues
just fix

# Run all checks
just check

# Test all just commands
just --list
just build
just test
just lint
just doc

# Verify CI config is valid
# (requires act: https://github.com/nektos/act)
act -l
```

## Testing Requirements

### Local Testing

All configuration files should be tested locally:

```bash
# Test rustfmt config
cargo fmt --check

# Test clippy config
cargo clippy --all-targets -- -D warnings

# Test justfile commands
just --list
just ci

# Test GitHub Actions locally (requires act)
act
```

### CI Testing

Push to a branch and verify all CI jobs pass:
- ‚úÖ Test job (stable and beta Rust)
- ‚úÖ Clippy job
- ‚úÖ Format job
- ‚úÖ Docs job
- ‚úÖ Audit job

## Output Artifacts

### Configuration Files

1. **`.rustfmt.toml`**
   - 120 character line width
   - Rust 2021 edition
   - Trailing commas
   - Comment wrapping
   - Import ordering

2. **`clippy.toml`**
   - Complexity thresholds
   - Disallowed names

3. **`src/lib.rs`** (updated)
   - Clippy lint configuration
   - Deny all clippy lints by default
   - Allow specific pedantic lints with justification

4. **`.github/workflows/ci.yml`**
   - Test job (stable + beta)
   - Clippy job
   - Format job
   - Documentation job
   - Security audit job
   - Caching for faster builds

5. **`justfile`**
   - Build commands
   - Test commands
   - Quality checks
   - Documentation commands
   - CI simulation

6. **`CONTRIBUTING.md`**
   - Getting started guide
   - Development workflow
   - Code style guidelines
   - Testing guidelines
   - PR process

7. **`.git/hooks/pre-commit`** (optional)
   - Format check
   - Clippy check
   - Optional test run

### Notes File

Create: **`outputs/notes/W1.T08-notes.md`**

Use this template (fill in after completion):

```markdown
# Task W1.T08 Output Notes

## Implementation Summary

Set up comprehensive development tooling for FastRender V2:
- **rustfmt**: Automatic code formatting (120 char lines, edition 2021)
- **clippy**: Strict linting with pedantic lints enabled
- **GitHub Actions CI**: Automated testing, linting, formatting checks
- **justfile**: Command shortcuts for common tasks
- **CONTRIBUTING.md**: Clear contributor guidelines

All existing code has been formatted and passes clippy checks.

## Configuration Details

### rustfmt Configuration (`.rustfmt.toml`)

Key settings:
- `max_width = 120` - Modern wide screens can handle it
- `edition = "2021"` - Use latest edition features
- `trailing_comma = "Vertical"` - Cleaner diffs
- `reorder_imports = true` - Consistent import order
- `wrap_comments = true` - Keep comments readable

### Clippy Configuration

Enabled lints:
- `#![deny(clippy::all)]` - All default lints are errors
- `#![warn(clippy::pedantic)]` - Strict style lints
- `#![warn(clippy::nursery)]` - Experimental lints

Allowed exceptions:
- `module_name_repetitions` - Often clearer to repeat
- `similar_names` - Layout algorithms have similar variables
- `too_many_lines` - Some algorithms are necessarily long
- `cast_precision_loss` - Intentional for layout math
- `float_arithmetic` - Fundamental to rendering

Denied for performance:
- `unnecessary_clone`
- `needless_collect`
- `redundant_clone`

### GitHub Actions Workflows

**Jobs**:
1. **test**: Run tests on stable and beta Rust
2. **clippy**: Lint with clippy
3. **format**: Check formatting
4. **docs**: Build documentation
5. **audit**: Security vulnerability scan

**Caching**: All jobs cache cargo registry, index, and build artifacts for speed.

**Triggers**: Runs on push to main/develop and all PRs.

### Justfile Commands

**Building**:
- `just build` - Debug build
- `just build-release` - Release build
- `just clean` - Clean artifacts

**Testing**:
- `just test` - Run all tests
- `just test-output` - Show test output
- `just test-one <name>` - Run specific test
- `just coverage` - Generate coverage report

**Code Quality**:
- `just fmt` - Format code
- `just fmt-check` - Check formatting
- `just lint` - Run clippy
- `just fix` - Auto-fix clippy issues
- `just check` - Run all checks

**Documentation**:
- `just doc` - Build and open docs
- `just doc-build` - Build docs
- `just doc-check` - Check docs build without warnings

**CI Simulation**:
- `just ci` - Run all CI checks locally

**Development**:
- `just watch` - Auto-run tests on changes
- `just install-dev-tools` - Install dev dependencies

## Decisions Made

### Decision 1: 120 Character Line Width

**Choice**: 120 characters instead of default 100
**Rationale**:
- Modern screens are wide enough
- Reduces line wrapping in complex code
- Matches common industry practice
- Rust community is moving toward 100-120

**Impact**: More readable code on modern displays

### Decision 2: Strict Clippy Configuration

**Choice**: Enable pedantic and nursery lints
**Rationale**:
- Catch more potential issues early
- Enforce consistent style
- Learn Rust best practices
- High-quality codebase from the start

**Impact**: More work upfront, but higher quality code

**Tradeoff**: Some false positives require `#![allow(...)]` annotations

### Decision 3: Just Over Make

**Choice**: Use justfile instead of Makefile
**Rationale**:
- Better cross-platform support
- Cleaner syntax
- Better error messages
- Growing adoption in Rust community
- Built-in command listing

**Impact**: One extra dependency to install, but better DX

### Decision 4: Test on Stable and Beta

**Choice**: Run CI on both stable and beta Rust
**Rationale**:
- Catch breakage before it reaches stable
- Ensure forward compatibility
- Community best practice

**Impact**: More CI time, but earlier warning of issues

**Future**: May add nightly testing for unstable features

## GitHub Actions Optimizations

### Caching Strategy

All jobs cache:
- `~/.cargo/registry` - Downloaded crates
- `~/.cargo/git` - Git dependencies
- `target/` - Build artifacts

**Cache key**: Based on `Cargo.lock` hash
**Benefit**: ~5x faster CI runs after first build

### Parallel Jobs

Jobs run in parallel where possible:
- Test, clippy, format, docs all run simultaneously
- Only blocked by checkout and cache restore

**Typical CI time**:
- First run: ~8 minutes
- Cached runs: ~2 minutes

## CONTRIBUTING.md Structure

Sections:
1. **Getting Started**: Prerequisites, clone, build
2. **Development Setup**: Editor config, tools
3. **Development Workflow**: Branch, code, commit, PR
4. **Code Style**: Formatting, linting, naming, docs
5. **Testing**: Writing tests, running tests, coverage
6. **Pull Request Process**: Checklist, template, review
7. **Project Structure**: Directory layout
8. **Common Tasks**: Recipes for frequent operations

**Target audience**: New contributors with basic Rust knowledge

## Pre-Commit Hooks

**Status**: Implemented but optional (not committed to repo)

**Checks**:
- Format check (fast)
- Clippy check (moderate)
- Test run (slow - commented out by default)

**Bypass**: `git commit --no-verify`

**Installation**: Documented in CONTRIBUTING.md

## Recommendations for Downstream Tasks

### For All Future Tasks:

1. **Before starting**:
   - Pull latest main
   - Run `just check` to ensure clean state

2. **During development**:
   - Use `just watch` for TDD workflow
   - Format on save (editor integration)
   - Run `just lint` periodically

3. **Before committing**:
   - Run `just ci` to simulate CI
   - All checks must pass

4. **In PR description**:
   - Use the template in CONTRIBUTING.md
   - Include test coverage info
   - Link related issues

## Tools Ecosystem

### Core Tools (Required)

- **rustfmt**: Formatting (built into Rust)
- **clippy**: Linting (built into Rust)
- **just**: Command runner (`cargo install just`)

### Recommended Tools

- **cargo-watch**: Auto-rebuild (`cargo install cargo-watch`)
- **cargo-tarpaulin**: Coverage (`cargo install cargo-tarpaulin`)
- **rust-analyzer**: LSP server (built into VS Code extension)

### Optional Tools

- **act**: Local GitHub Actions (`brew install act` or similar)
- **cargo-audit**: Security scanning (`cargo install cargo-audit`)
- **cargo-outdated**: Dependency updates (`cargo install cargo-outdated`)
- **tokei**: Line counting (`cargo install tokei`)

## Automation Impact

**Before this task**:
- Manual code formatting
- Inconsistent style across files
- Clippy warnings ignored
- No CI checks

**After this task**:
- Automatic formatting on save
- Consistent style enforced by CI
- All clippy warnings must be fixed
- Comprehensive CI checks on every PR

**Developer experience**:
- Initial setup: ~10 minutes
- Daily overhead: ~5 seconds per commit (fmt + clippy)
- CI confidence: Very high (catches issues early)

## Future Improvements

### Potential Additions

1. **cargo-deny**: License and dependency policy enforcement
2. **cargo-nextest**: Faster test runner
3. **miri**: Detect undefined behavior
4. **proptest**: Property-based testing
5. **criterion**: Benchmarking framework (already in project)

### CI Enhancements

1. **Coverage reporting**: Upload to codecov.io
2. **Nightly testing**: Test on nightly Rust
3. **Platform matrix**: Test on Windows, macOS, Linux
4. **Performance regression**: Benchmark on every commit
5. **Documentation deployment**: Auto-deploy docs to GitHub Pages

## Open Questions

**Q1**: Should we enforce 100% documentation coverage?
**A**: Currently warn on missing docs, but not deny. Can tighten later.

**Q2**: Should we run tests in pre-commit hook?
**A**: Commented out by default (too slow). Can enable per developer preference.

**Q3**: Should we use cargo-deny for dependency auditing?
**A**: Good idea for future, but adds complexity. Add in Wave 2+.

## Code Quality Metrics

### Before Formatting

```
$ cargo fmt --check
// Many files unformatted
```

### After Formatting

```
$ cargo fmt --check
// All files formatted ‚úÖ
```

### Before Clippy

```
$ cargo clippy
// Various warnings
```

### After Clippy Fixes

```
$ cargo clippy -- -D warnings
// No warnings ‚úÖ
```

## CI Status

- ‚úÖ GitHub Actions workflow created
- ‚úÖ Test job configured
- ‚úÖ Clippy job configured
- ‚úÖ Format job configured
- ‚úÖ Docs job configured
- ‚úÖ Audit job configured
- ‚úÖ Caching configured
- ‚úÖ All jobs passing

## References Used

1. rustfmt documentation - https://rust-lang.github.io/rustfmt/
2. clippy documentation - https://doc.rust-lang.org/clippy/
3. GitHub Actions docs - https://docs.github.com/en/actions
4. just documentation - https://github.com/casey/just
5. Rust API Guidelines - https://rust-lang.github.io/api-guidelines/

---

**Task completed:** [DATE]
**Time taken:** [X] hours
**Configuration files created:** 6 (.rustfmt.toml, clippy.toml, ci.yml, justfile, CONTRIBUTING.md, pre-commit)
```

## Common Pitfalls to Avoid

### Pitfall 1: Too Strict Clippy Configuration

**Wrong**: Deny all pedantic lints without exceptions
**Right**: Deny all, warn pedantic, allow specific ones with justification

Some pedantic lints are too strict for real-world code (like `module_name_repetitions`).

### Pitfall 2: Inconsistent Line Width

**Wrong**: Using different max_width in different files
**Right**: One consistent line width across the entire project

Don't mix 80, 100, and 120 character lines.

### Pitfall 3: Slow Pre-Commit Hooks

**Wrong**: Running full test suite on every commit
**Right**: Quick checks only (fmt, clippy), full tests in CI

Developers will bypass hooks if they're too slow (`--no-verify`).

### Pitfall 4: Not Caching in CI

**Wrong**: Building from scratch on every CI run
**Right**: Cache cargo registry, git deps, and build artifacts

Without caching, CI takes 10+ minutes. With caching, ~2 minutes.

### Pitfall 5: Incomplete CONTRIBUTING.md

**Wrong**: Brief, generic contribution guide
**Right**: Detailed, project-specific guide with examples

New contributors need specific commands and examples, not general advice.

### Pitfall 6: Forgetting to Format Existing Code

**Wrong**: Creating .rustfmt.toml but not formatting existing code
**Right**: Run `cargo fmt` after creating config to format everything

Otherwise CI will immediately fail on existing code.

### Pitfall 7: Not Testing CI Locally

**Wrong**: Push to GitHub to test if CI works
**Right**: Use `act` to test GitHub Actions locally

Saves time and GitHub Actions minutes.

## Verification Checklist

Before marking task complete:

- [ ] `.rustfmt.toml` created
- [ ] `clippy.toml` created
- [ ] Clippy lints configured in `src/lib.rs`
- [ ] `.github/workflows/ci.yml` created
- [ ] `justfile` created
- [ ] `CONTRIBUTING.md` created
- [ ] All existing code formatted: `cargo fmt`
- [ ] All clippy warnings fixed: `cargo clippy -- -D warnings`
- [ ] All just commands tested
- [ ] CI workflow tested (push to branch)
- [ ] Pre-commit hook created (optional)
- [ ] Notes file complete

## Time Tracking

Estimated breakdown:
- **rustfmt.toml:** 20min
- **clippy.toml + lib.rs config:** 1hr
- **GitHub Actions CI:** 45min
- **justfile:** 30min
- **CONTRIBUTING.md:** 45min
- **Pre-commit hook:** 20min (optional)
- **Verification & fixes:** 20min
- **Total:** 3-4 hours

## Getting Help

If stuck:

1. **rustfmt**: Check https://rust-lang.github.io/rustfmt/ for all config options
2. **clippy**: List all lints with `rustc -W help` and `cargo clippy --help`
3. **GitHub Actions**: Use action documentation and examples from popular Rust projects
4. **just**: Reference https://github.com/casey/just for syntax

**Example projects with good CI setups**:
- tokio: https://github.com/tokio-rs/tokio
- serde: https://github.com/serde-rs/serde
- clap: https://github.com/clap-rs/clap

Remember: These tools are force multipliers. Invest time now to save hours later!
