name: Fixture Chrome diff (artifacts)

on:
  workflow_dispatch:
    inputs:
      fixtures:
        description: "Comma-separated fixture stems (default: fixtures referenced by tests/pages_regression_test.rs)"
        required: false
        type: string
      shard:
        description: "Optional deterministic shard (index/total, 0-based, e.g. 0/4)"
        required: false
        type: string
      fail_on_regression:
        description: "Fail the workflow when the fixture-vs-Chrome diff regresses vs the last successful main run."
        type: boolean
        default: false
      regression_threshold_percent:
        description: "Allowed regression threshold in percent (0 = any regression fails when fail_on_regression=true)."
        required: false
        type: string
        default: "0"
  schedule:
    # Weekly report so maintainers have fresh evidence artifacts without running Chrome locally.
    - cron: "0 7 * * 1"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  OUT_DIR: target/fixture_chrome_diff_ci
  REPORT_ARTIFACT: fixture_chrome_diff_ci
  REPORT_JSON_ARTIFACT: fixture_chrome_diff_report_json
  DELTA_ARTIFACT: fixture_chrome_diff_delta

jobs:
  fixture-chrome-diff:
    name: Fixture vs Chrome diff report
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      # workflow_dispatch inputs are only populated for dispatch runs. Use github.event.inputs so
      # this workflow can run on the weekly main schedule as well.
      FAIL_ON_REGRESSION: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.fail_on_regression || 'false' }}
      REGRESSION_THRESHOLD_PERCENT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.regression_threshold_percent || '0' }}
      BASELINE_FOUND: "0"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: fixture-chrome-diff-${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: fixture-chrome-diff-${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: fixture-chrome-diff-${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Chrome
        id: setup_chrome
        uses: browser-actions/setup-chrome@v1

      - name: Export CHROME_BIN
        shell: bash
        run: |
          set -euo pipefail
          chrome_path="${{ steps.setup_chrome.outputs.chrome-path }}"
          if [[ -n "${chrome_path}" && -x "${chrome_path}" ]]; then
            echo "CHROME_BIN=${chrome_path}" >> "$GITHUB_ENV"
            "${chrome_path}" --version
            exit 0
          fi

          chrome="$(command -v google-chrome-stable || command -v google-chrome || command -v chromium || command -v chromium-browser)"
          echo "CHROME_BIN=${chrome}" >> "$GITHUB_ENV"
          "${chrome}" --version

      - name: Install font packages
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y \
            fonts-dejavu-core \
            fonts-noto-core \
            fonts-noto-color-emoji

      - name: Resolve fixture list
        id: fixtures
        shell: bash
        run: |
          set -euo pipefail

          raw_fixtures="${{ github.event.inputs.fixtures }}"
          raw_fixtures="${raw_fixtures// /}"

          if [[ -n "${raw_fixtures}" ]]; then
            fixtures_csv="${raw_fixtures}"
          else
            mapfile -t fixtures < <(
              (
                grep -Eo 'html:[[:space:]]*"[^"]+"' tests/pages_regression_test.rs 2>/dev/null || true
              ) | sed -E 's/.*"([^"]+)".*/\1/' \
                | awk -F/ '{print $1}' \
                | awk '!seen[$0]++'
            )

            if [[ "${#fixtures[@]}" -eq 0 ]]; then
              mapfile -t fixtures < <(
                find tests/pages/fixtures -mindepth 2 -maxdepth 2 -type f -name index.html -print \
                  | sed -E 's#/index\\.html$##' \
                  | xargs -n1 basename \
                  | sort -u
              )
            fi

            fixtures_csv="$(IFS=,; echo "${fixtures[*]}")"
          fi

          if [[ -z "${fixtures_csv}" ]]; then
            echo "no fixtures selected" >&2
            exit 1
          fi

          echo "FIXTURES=${fixtures_csv}" >> "$GITHUB_ENV"
          echo "fixtures=${fixtures_csv}" >> "$GITHUB_OUTPUT"

      - name: Generate report (fixture vs Chrome)
        shell: bash
        run: |
          set -euo pipefail

          rm -rf "${OUT_DIR}"

          args=(
            --out-dir "${OUT_DIR}"
            --fixtures "${FIXTURES}"
            --timeout 30
          )

          shard="${{ github.event.inputs.shard }}"
          shard="${shard// /}"
          if [[ -n "${shard}" ]]; then
            args+=(--shard "${shard}")
          fi

          cargo xtask fixture-chrome-diff "${args[@]}"

          test -f "${OUT_DIR}/report.html"
          test -f "${OUT_DIR}/report.json"

      - name: Upload report directory
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPORT_ARTIFACT }}
          path: ${{ env.OUT_DIR }}/
          if-no-files-found: error

      - name: Prepare report.json artifact payload
        shell: bash
        run: |
          set -euo pipefail
          cp "${OUT_DIR}/report.json" report.json

      - name: Upload report.json (baseline for comparisons)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPORT_JSON_ARTIFACT }}
          path: report.json
          if-no-files-found: error

      - name: Download main baseline report.json artifact (last successful)
        id: download_baseline
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: chrome_fixture_diff.yml
          workflow_conclusion: success
          branch: main
          name: ${{ env.REPORT_JSON_ARTIFACT }}
          path: baseline

      - name: Locate baseline report.json
        if: steps.download_baseline.outcome == 'success'
        shell: bash
        run: |
          set -euo pipefail

          if [[ -f baseline/report.json ]]; then
            echo "BASELINE_FOUND=1" >> "$GITHUB_ENV"
            exit 0
          fi

          match=$(find baseline -type f -name report.json | head -n 1 || true)
          if [[ -z "${match}" ]]; then
            echo "baseline artifact downloaded, but report.json was not found; skipping delta compare" >&2
            exit 0
          fi

          cp "${match}" baseline/report.json
          echo "BASELINE_FOUND=1" >> "$GITHUB_ENV"

      - name: Build compare_diff_reports
        if: env.BASELINE_FOUND == '1'
        shell: bash
        run: |
          set -euo pipefail
          cargo build --release --bin compare_diff_reports
          echo "$PWD/target/release" >> "$GITHUB_PATH"

      - name: Compare diff reports vs main baseline
        if: env.BASELINE_FOUND == '1'
        id: compare_delta
        shell: bash
        run: |
          set -euo pipefail

          compare_diff_reports \
            --allow-config-mismatch \
            --baseline baseline/report.json \
            --new "${OUT_DIR}/report.json" \
            --html "${OUT_DIR}/delta.html" \
            --json "${OUT_DIR}/delta.json"

          test -f "${OUT_DIR}/delta.json"
          test -f "${OUT_DIR}/delta.html"

      - name: Regression gate (delta vs main)
        if: env.BASELINE_FOUND == '1' && env.FAIL_ON_REGRESSION == 'true'
        shell: bash
        run: |
          set -euo pipefail

          mismatch_count="$(python3 - <<'PY'
import json
from pathlib import Path

delta = json.loads(Path("target/fixture_chrome_diff_ci/delta.json").read_text())
mismatches = delta.get("config_mismatches")
if not isinstance(mismatches, list):
  mismatches = []
print(len(mismatches))
PY
          )"

          if [[ "${mismatch_count}" != "0" ]]; then
            echo "Delta report config mismatch vs baseline; skipping regression gate." >&2
            exit 0
          fi

          compare_diff_reports \
            --baseline baseline/report.json \
            --new "${OUT_DIR}/report.json" \
            --html "${OUT_DIR}/delta.html" \
            --json "${OUT_DIR}/delta.json" \
            --fail-on-regression \
            --regression-threshold-percent "${REGRESSION_THRESHOLD_PERCENT}"

      - name: Upload delta artifacts (delta.html + delta.json)
        if: always() && env.BASELINE_FOUND == '1'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DELTA_ARTIFACT }}
          path: |
            ${{ env.OUT_DIR }}/delta.html
            ${{ env.OUT_DIR }}/delta.json
          if-no-files-found: warn

      - name: Step summary
        if: always()
        shell: bash
        run: |
          {
            echo "## Fixture vs Chrome diff report"
            echo
            echo "Download the **${REPORT_ARTIFACT}** artifact from this workflow run."
            echo
            echo "- HTML report: \`${OUT_DIR}/report.html\`"
            echo "- JSON report: \`${OUT_DIR}/report.json\`"
            echo "- Fixtures: \`${{ steps.fixtures.outputs.fixtures }}\`"
            echo
          } >> "$GITHUB_STEP_SUMMARY"

          if [[ -f "${OUT_DIR}/report.json" ]]; then
            python3 - <<'PY' >> "$GITHUB_STEP_SUMMARY"
import json
from pathlib import Path

report = json.loads(Path("target/fixture_chrome_diff_ci/report.json").read_text())
totals = report.get("totals", {})

def fmt(key):
  value = totals.get(key)
  return "?" if value is None else str(value)

print("### Report totals")
print()
print(f"- Discovered: {fmt('discovered')}")
print(f"- Processed: {fmt('processed')}")
print(f"- Differences: {fmt('differences')}")
print(f"- Missing: {fmt('missing')}")
print(f"- Errors: {fmt('errors')}")
PY
          fi

          if [[ "${BASELINE_FOUND}" != "1" ]]; then
            {
              echo
              echo "### Delta vs \`main\`"
              echo
              echo "Baseline report.json from \`main\` was not available; skipping delta compare."
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          {
            echo
            echo "### Delta vs \`main\`"
            echo
            if [[ -f "${OUT_DIR}/delta.json" ]]; then
              echo "- Delta artifact: \`${DELTA_ARTIFACT}\`"
            else
              echo "- Delta report was not generated (compare_diff_reports failed); see workflow logs."
            fi
            echo
          } >> "$GITHUB_STEP_SUMMARY"

          if [[ -f "${OUT_DIR}/delta.json" ]]; then
            python3 - <<'PY' >> "$GITHUB_STEP_SUMMARY"
import json
import os
from pathlib import Path

delta = json.loads(Path("target/fixture_chrome_diff_ci/delta.json").read_text())
totals = delta.get("totals", {})
mismatches = delta.get("config_mismatches")
if not isinstance(mismatches, list):
  mismatches = []

def fmt(key: str) -> str:
  value = totals.get(key)
  return "?" if value is None else str(value)

print("| Change | Count |")
print("| --- | ---: |")
print(f"| Improved | {fmt('improved')} |")
print(f"| Regressed | {fmt('regressed')} |")
print(f"| Unchanged | {fmt('unchanged')} |")

if mismatches:
  print()
  print(f"Config mismatches vs baseline: {len(mismatches)} (see delta.html for details).")

fail_on_regression = (os.getenv("FAIL_ON_REGRESSION") or "").lower() == "true"
threshold = os.getenv("REGRESSION_THRESHOLD_PERCENT") or "0"

print()
if not fail_on_regression:
  print("Regression gate: disabled (set `fail_on_regression=true` on workflow_dispatch to enable)")
elif mismatches:
  print("Regression gate: skipped (baseline/new diff config mismatch)")
else:
  print(f"Regression gate: enabled (`--fail-on-regression`), threshold: {threshold}%")
PY
          else
            {
              if [[ "${FAIL_ON_REGRESSION}" == "true" ]]; then
                echo "Regression gate: skipped (no delta.json)"
              else
                echo "Regression gate: disabled (set \`fail_on_regression=true\` on workflow_dispatch to enable)"
              fi
            } >> "$GITHUB_STEP_SUMMARY"
          fi
