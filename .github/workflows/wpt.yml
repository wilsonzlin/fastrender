name: WPT Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Run weekly to catch new WPT tests and regressions
  schedule:
    - cron: '0 0 * * 0'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      suite:
        description: 'WPT test suite to run (e.g., css/css-flexbox)'
        required: false
        default: 'css/CSS2'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ===========================================================================
  # WPT CSS Flexbox Tests
  # ===========================================================================
  wpt-flexbox:
    name: WPT Flexbox
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-wpt-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-wpt-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfreetype6-dev libfontconfig1-dev

      - name: Build WPT runner
        run: cargo build --release

      - name: Setup WPT test directory
        run: |
          mkdir -p tests/wpt_results

      - name: Run WPT CSS Flexbox tests
        run: |
          # Run flexbox tests using the test harness
          cargo test --release wpt_flexbox 2>&1 | tee tests/wpt_results/flexbox.txt || true
        continue-on-error: true

      - name: Generate flexbox results summary
        run: |
          echo "## WPT Flexbox Results" > tests/wpt_results/flexbox-summary.md
          echo "" >> tests/wpt_results/flexbox-summary.md
          echo "Test run completed at: $(date -u)" >> tests/wpt_results/flexbox-summary.md
          if [ -f tests/wpt_results/flexbox.txt ]; then
            echo "" >> tests/wpt_results/flexbox-summary.md
            echo '```' >> tests/wpt_results/flexbox-summary.md
            tail -50 tests/wpt_results/flexbox.txt >> tests/wpt_results/flexbox-summary.md
            echo '```' >> tests/wpt_results/flexbox-summary.md
          fi

      - name: Upload flexbox results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wpt-flexbox-results
          path: tests/wpt_results/flexbox*
          retention-days: 30

  # ===========================================================================
  # WPT CSS Block Layout Tests (CSS2)
  # ===========================================================================
  wpt-block:
    name: WPT Block Layout
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-wpt-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-wpt-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfreetype6-dev libfontconfig1-dev

      - name: Build WPT runner
        run: cargo build --release

      - name: Setup WPT test directory
        run: |
          mkdir -p tests/wpt_results

      - name: Run WPT CSS2 Block Layout tests
        run: |
          # Run block layout tests using the test harness
          cargo test --release wpt_block 2>&1 | tee tests/wpt_results/block.txt || true
        continue-on-error: true

      - name: Upload block results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wpt-block-results
          path: tests/wpt_results/block*
          retention-days: 30

  # ===========================================================================
  # WPT CSS Inline Layout Tests
  # ===========================================================================
  wpt-inline:
    name: WPT Inline Layout
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-wpt-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-wpt-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfreetype6-dev libfontconfig1-dev

      - name: Build WPT runner
        run: cargo build --release

      - name: Setup WPT test directory
        run: |
          mkdir -p tests/wpt_results

      - name: Run WPT CSS Inline tests
        run: |
          # Run inline layout tests using the test harness
          cargo test --release wpt_inline 2>&1 | tee tests/wpt_results/inline.txt || true
        continue-on-error: true

      - name: Upload inline results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wpt-inline-results
          path: tests/wpt_results/inline*
          retention-days: 30

  # ===========================================================================
  # WPT CSS Tables Tests
  # ===========================================================================
  wpt-tables:
    name: WPT Tables
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-wpt-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-wpt-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfreetype6-dev libfontconfig1-dev

      - name: Build WPT runner
        run: cargo build --release

      - name: Setup WPT test directory
        run: |
          mkdir -p tests/wpt_results

      - name: Run WPT CSS Tables tests
        run: |
          # Run table layout tests using the test harness
          cargo test --release wpt_tables 2>&1 | tee tests/wpt_results/tables.txt || true
        continue-on-error: true

      - name: Upload tables results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wpt-tables-results
          path: tests/wpt_results/tables*
          retention-days: 30

  # ===========================================================================
  # Aggregate WPT Results and Report
  # ===========================================================================
  wpt-report:
    name: WPT Report
    runs-on: ubuntu-latest
    needs: [wpt-flexbox, wpt-block, wpt-inline, wpt-tables]
    if: always()
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: wpt-results

      - name: Generate combined report
        run: |
          echo "# WPT Test Results Summary" > wpt-report.md
          echo "" >> wpt-report.md
          echo "**Date:** $(date -u)" >> wpt-report.md
          echo "**Commit:** ${{ github.sha }}" >> wpt-report.md
          echo "" >> wpt-report.md

          echo "## Test Suite Status" >> wpt-report.md
          echo "" >> wpt-report.md
          echo "| Suite | Status |" >> wpt-report.md
          echo "|-------|--------|" >> wpt-report.md
          echo "| Flexbox | ${{ needs.wpt-flexbox.result }} |" >> wpt-report.md
          echo "| Block Layout | ${{ needs.wpt-block.result }} |" >> wpt-report.md
          echo "| Inline Layout | ${{ needs.wpt-inline.result }} |" >> wpt-report.md
          echo "| Tables | ${{ needs.wpt-tables.result }} |" >> wpt-report.md
          echo "" >> wpt-report.md

          cat wpt-report.md

      - name: Upload combined report
        uses: actions/upload-artifact@v4
        with:
          name: wpt-combined-report
          path: wpt-report.md
          retention-days: 90

      - name: Comment on PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let body = `## WPT Test Results\n\n`;
            body += `**Commit:** \`${{ github.sha }}\`\n\n`;
            body += `| Suite | Status |\n`;
            body += `|-------|--------|\n`;
            body += `| Flexbox | ${{ needs.wpt-flexbox.result == 'success' && '✅ Pass' || '❌ Fail' }} |\n`;
            body += `| Block Layout | ${{ needs.wpt-block.result == 'success' && '✅ Pass' || '❌ Fail' }} |\n`;
            body += `| Inline Layout | ${{ needs.wpt-inline.result == 'success' && '✅ Pass' || '❌ Fail' }} |\n`;
            body += `| Tables | ${{ needs.wpt-tables.result == 'success' && '✅ Pass' || '❌ Fail' }} |\n\n`;
            body += `View detailed results in the [Actions artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).`;

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## WPT Test Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ===========================================================================
  # Upload to WPT.fyi (Main branch only)
  # ===========================================================================
  upload-wptfyi:
    name: Upload to WPT.fyi
    runs-on: ubuntu-latest
    needs: [wpt-flexbox, wpt-block, wpt-inline, wpt-tables]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: wpt-results

      - name: Prepare WPT.fyi upload
        run: |
          echo "WPT.fyi upload would happen here"
          echo "This requires setting up WPTFYI_API_KEY secret"
          # When ready, uncomment:
          # curl -X POST https://wpt.fyi/api/results/upload \
          #   -H "Authorization: Bearer ${{ secrets.WPTFYI_API_KEY }}" \
          #   -F "result_file=@wpt-results/combined-results.json" \
          #   -F "labels=fastrender,experimental"
