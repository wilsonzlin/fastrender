# W6.T02: Rendering Pipeline Integration - Implementation Notes

## Summary

This task wired the complete rendering pipeline from HTML to pixels, integrating all previously implemented phases into a cohesive Renderer module.

## Implementation Details

### Pipeline Architecture

The rendering pipeline follows six distinct phases:

```
HTML String
    ↓
┌──────────────────┐
│   1. Parse       │  dom::parse_html() → DomNode
└──────────────────┘
    ↓
┌──────────────────┐
│   2. Style       │  style::apply_styles() → StyledNode
└──────────────────┘
    ↓
┌──────────────────┐
│   3. Box Gen     │  generate_box_tree() → BoxTree
└──────────────────┘
    ↓
┌──────────────────┐
│   4. Layout      │  LayoutEngine::layout_tree() → FragmentTree
└──────────────────┘
    ↓
┌──────────────────┐
│   5. Paint       │  paint_tree() → Pixmap
└──────────────────┘
    ↓
┌──────────────────┐
│   6. Encode      │  encode_image() → Vec<u8>
└──────────────────┘
```

### Key Components

#### Renderer (`src/renderer.rs`)

The main entry point for HTML-to-image rendering:

```rust
pub struct Renderer {
    viewport_width: u32,
    viewport_height: u32,
    background_color: Color,
}
```

Key methods:
- `render_to_png(&self, html: &str, width: u32, height: u32) -> Result<Vec<u8>>`
- `render_to_jpeg(&self, html: &str, width: u32, height: u32, quality: u8) -> Result<Vec<u8>>`
- `render_to_webp(&self, html: &str, width: u32, height: u32, quality: u8) -> Result<Vec<u8>>`
- `render_to_png_auto_height(&self, html: &str, width: u32) -> Result<Vec<u8>>`

#### RendererBuilder

Builder pattern for configuring the renderer:

```rust
let renderer = Renderer::builder()
    .viewport_size(1024, 768)
    .background_color(Color::rgb(240, 240, 240))
    .build();
```

### Bug Fixes Required

#### 1. Document Node Display Type

**Problem:** The DOM parser returns a Document node at root level that defaulted to `Display::Inline`, preventing it from establishing a formatting context.

**Solution:** Added handling in `get_default_styles_for_element()` to set Document nodes to `Display::Block`:

```rust
// Handle Document node type - must be block to establish formatting context at root
if matches!(node.node_type, crate::dom::DomNodeType::Document) {
    styles.display = Display::Block;
    return styles;
}
```

#### 2. HTML/Body Element Display Types

**Problem:** The `<html>` and `<body>` elements weren't in the block-level elements list.

**Solution:** Added them to the display type matching:

```rust
styles.display = match tag {
    // Document structure elements (must be block to establish formatting context)
    "html" | "body" => Display::Block,
    // ...
};
```

#### 3. Hidden Elements Display Type

**Problem:** The user-agent stylesheet had `head`, `style`, and `script` set to `display: inline` instead of `display: none`.

**Solution:** Fixed the user-agent stylesheet (`src/user_agent.css`):

```css
/* Hidden elements - these should not be rendered */
head, style, script, meta, link, title, noscript, template {
    display: none;
}
```

#### 4. Em/Rem Unit Resolution in Layout

**Problem:** The block layout code called `.to_px()` on lengths that might be in `em` or `rem` units, causing a panic.

**Solution:** Added helper functions in `src/layout/contexts/block/mod.rs` to resolve lengths with font-size context:

```rust
fn resolve_length(length: &Length, font_size: f32, containing_block_size: f32) -> f32 {
    use crate::style::values::LengthUnit;
    match length.unit {
        LengthUnit::Em | LengthUnit::Rem => length.value * font_size,
        LengthUnit::Percent => (length.value / 100.0) * containing_block_size,
        _ if length.unit.is_absolute() => length.to_px(),
        _ => 0.0,
    }
}
```

### Files Modified

1. **`src/style/mod.rs`**
   - Added Document node handling in `get_default_styles_for_element()`
   - Added `html` and `body` to block-level elements
   - Added hidden elements (head, style, script, etc.) to display: none

2. **`src/user_agent.css`**
   - Fixed hidden elements CSS rule

3. **`src/layout/contexts/block/mod.rs`**
   - Added `resolve_length()` and `resolve_opt_length()` helper functions
   - Updated `layout_block_child()` to use these helpers for margin, padding, border, and height values

4. **`tests/integration_test.rs`**
   - Removed all `#[ignore]` attributes from tests
   - Updated module documentation

5. **`examples/simple.rs`** (new file)
   - Comprehensive example demonstrating all renderer capabilities

### Integration Tests

All 15 integration tests now pass:

- `test_simple_html_rendering`
- `test_text_rendering`
- `test_flexbox_layout`
- `test_grid_layout`
- `test_gradient_background`
- `test_border_radius`
- `test_box_shadow`
- `test_transform`
- `test_multiple_output_formats`
- `test_custom_viewport_size`
- `test_invalid_dimensions`
- `test_malformed_html`
- `test_class_selector`
- `test_id_selector`
- `test_nested_elements`

### Usage Example

```rust
use fastrender::Renderer;

let html = r#"
    <html>
        <head>
            <style>
                .box { width: 100px; height: 100px; background-color: red; }
            </style>
        </head>
        <body>
            <div class="box"></div>
        </body>
    </html>
"#;

let renderer = Renderer::new();
let png_bytes = renderer.render_to_png(html, 800, 600)?;
```

### Design Decisions

1. **User-Agent Stylesheet**: The user-agent stylesheet is embedded via `include_str!()` and automatically merged with author stylesheets during style application.

2. **Error Propagation**: Errors from each phase are propagated up using the `Result<T, Error>` type, with descriptive error messages.

3. **Box Generation**: The `generate_box_tree()` function recursively converts StyledNodes to BoxNodes, handling display types, replaced elements, and text content.

4. **Font-size Context**: Layout operations that need to resolve `em`/`rem` units now receive the element's computed font-size.

### Known Limitations

1. **Inline Formatting Context**: Text nodes inside block containers are handled through the existing IFC implementation, but complex inline layouts may have edge cases.

2. **Percentage Heights**: Height percentages require a definite containing block height; auto heights may not resolve correctly in all cases.

3. **CSS var() in UA stylesheet**: CSS custom properties aren't supported in the user-agent stylesheet.

### Performance Notes

- The pipeline is single-threaded and processes sequentially
- Large documents benefit from incremental processing
- Memory usage scales with DOM tree size and output dimensions

### Dependencies

This task depends on:
- W6.T01 (box tree generation)
- W5.T08 (paint tree)
- W3.T04 (text rendering)
- W4.T12 (flexbox/grid layout)
- W2.T10 (layout engine)

### Verification

```bash
# Run all tests
cargo test

# Run integration tests specifically
cargo test --test integration_test

# Run the example
cargo run --example simple

# Build in release mode
cargo build --release
```

All 268 unit tests pass, 15 integration tests pass, and the example runs successfully producing valid PNG, JPEG, and WebP output.
