# W4.T13 - Baseline Alignment Implementation Notes

## Task Summary

Implemented baseline alignment for inline layout according to CSS 2.1 Section 10.8 (Line height calculations) and CSS Inline Layout Module Level 3.

## Implementation Overview

### Files Created

1. **`src/layout/inline/mod.rs`** - Inline layout module root
2. **`src/layout/inline/baseline.rs`** - Baseline alignment algorithm implementation
3. **`tests/layout/test_baseline.rs`** - Comprehensive integration tests

### Files Modified

1. **`src/layout/mod.rs`** - Added inline module and re-exports
2. **`tests/layout/mod.rs`** - Added test_baseline module

## Core Types

### VerticalAlign

CSS `vertical-align` property values:

```rust
pub enum VerticalAlign {
    Baseline,     // Align to parent baseline (default)
    Top,          // Align to line box top
    Bottom,       // Align to line box bottom
    Middle,       // Align to baseline + x-height/2
    TextTop,      // Align to parent's content area top
    TextBottom,   // Align to parent's content area bottom
    Super,        // Superscript positioning
    Sub,          // Subscript positioning
    Length(f32),  // Offset by specified px amount
    Percentage(f32), // Offset by % of line-height
}
```

### InlineBoxMetrics

Metrics for a single inline box:

- `ascent`: Distance from baseline to top (positive)
- `descent`: Distance from baseline to bottom (positive)
- `line_height`: Total line height including leading
- `baseline_offset`: Offset from box top to baseline
- `x_height`: Optional x-height for middle alignment
- `vertical_align`: Alignment mode

Provides constructors for:
- Text runs (`from_text`)
- Replaced elements like images (`from_replaced`)
- Inline-block elements (`from_inline_block`)

### LineMetrics

Computed metrics for an entire line box:

- `height`: Total line box height
- `baseline`: Distance from line top to baseline
- `max_ascent`: Maximum extent above baseline
- `max_descent`: Maximum extent below baseline
- `text_top`, `text_bottom`: For text-top/text-bottom alignment

### BaselineAligner

Main alignment engine that:
1. Collects inline box metrics
2. Computes optimal baseline position
3. Positions each box according to its `vertical-align`

## Algorithm

The alignment algorithm follows CSS 2.1 Section 10.8:

### Phase 1: Baseline Position Computation

For baseline-relative items (baseline, middle, super, sub, length, percentage):
- Compute each box's extent above/below the line baseline
- Track maximum extents to determine baseline position

### Phase 2: Line Height Extension

For top/bottom aligned items:
- Check if items extend beyond current line box
- Extend line height if needed

### Phase 3: Final Positioning

Position each box based on alignment mode:
- **Baseline**: Y = baseline - ascent - half_leading - offset
- **Top**: Y = half_leading (align to top)
- **Bottom**: Y = line_height - box_height + half_leading

## CSS Compliance

### Supported Features

- All `vertical-align` keyword values
- Length and percentage offsets
- Strut (minimum line height from parent font)
- Leading distribution (half above, half below)
- Proper baseline computation for different box types

### Alignment Modes Implementation

| Mode | Implementation |
|------|----------------|
| `baseline` | Direct baseline alignment |
| `top` | Align box top to line top |
| `bottom` | Align box bottom to line bottom |
| `middle` | Align box middle to baseline + x-height/2 |
| `text-top` | Align box top to parent text top |
| `text-bottom` | Align box bottom to parent text bottom |
| `super` | Raise by ~40% of em |
| `sub` | Lower by ~20% of em |
| `<length>` | Offset by exact pixels |
| `<percentage>` | Offset by % of line-height |

## Integration with Font System

Uses `ScaledMetrics` from W3.T16 (Font Metrics Extraction):

```rust
let metrics = InlineBoxMetrics::from_text(&scaled_metrics, VerticalAlign::Baseline);
```

## Test Coverage

27 unit tests covering:
- VerticalAlign variants and methods
- InlineBoxMetrics construction and calculations
- LineMetrics from strut
- BaselineAligner with various scenarios:
  - Empty aligner
  - Strut-only lines
  - Single and multiple text items
  - Different font sizes
  - Top/bottom alignment
  - Middle alignment
  - Super/subscript
  - Length/percentage offsets
  - Replaced elements (images)
  - Inline-blocks
  - Mixed alignment modes

## Usage Example

```rust
use fastrender::layout::inline::{BaselineAligner, InlineBoxMetrics, VerticalAlign};
use fastrender::text::ScaledMetrics;

// Create aligner with parent font (strut)
let strut = font_context.scale_metrics(parent_font, 16.0);
let mut aligner = BaselineAligner::with_strut(strut);

// Add inline boxes
aligner.add_box(InlineBoxMetrics::from_text(&text_metrics, VerticalAlign::Baseline));
aligner.add_box(InlineBoxMetrics::from_replaced(image_height, VerticalAlign::Bottom));

// Compute alignment
let (line_metrics, positioned_boxes) = aligner.align();

// Use results
for box_pos in positioned_boxes {
    let y = line_metrics.baseline + box_pos.y_offset;
    // Position content at y
}
```

## Known Limitations

1. Does not handle writing modes other than horizontal-tb
2. Super/sub offsets use fixed percentages (proper implementation would use font-specific metrics)
3. Does not handle vertical text

## Future Work

- W4.T12 will use this module for full inline formatting context
- Could add writing mode support for vertical text
- Could extract super/sub metrics from fonts if available

## References

- CSS 2.1 Section 10.8: https://www.w3.org/TR/CSS21/visudet.html#line-height
- CSS Inline Layout Module Level 3: https://www.w3.org/TR/css-inline-3/
- W3.T16 Font Metrics: outputs/notes/W3.T16-notes.md
