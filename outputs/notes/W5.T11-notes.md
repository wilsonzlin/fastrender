# W5.T11: Counter System - Implementation Notes

## Overview

Implemented CSS counter system for automatic numbering as specified in:
- CSS Lists Module Level 3: https://www.w3.org/TR/css-lists-3/#auto-numbering
- CSS 2.1 Section 12.4: https://www.w3.org/TR/CSS21/generate.html#counters

## Files Created/Modified

### New Files
- `src/style/counters.rs` - Core counter system module
- `tests/test_counters.rs` - Integration tests (66 tests)

### Modified Files
- `src/style/mod.rs` - Added counter module and re-exports

## Architecture

### CounterStyle Enum

Defines formatting styles for counter values:

| Style | Example Output | Range |
|-------|---------------|-------|
| `Decimal` | 1, 2, 3, ... | All integers |
| `DecimalLeadingZero` | 01, 02, 03, ... | All integers |
| `LowerAlpha` | a, b, c, ..., z, aa, ab, ... | Positive only |
| `UpperAlpha` | A, B, C, ..., Z, AA, AB, ... | Positive only |
| `LowerRoman` | i, ii, iii, iv, ... | 1-3999 |
| `UpperRoman` | I, II, III, IV, ... | 1-3999 |
| `LowerGreek` | α, β, γ, ... | 1-24 |
| `None` | (empty) | N/A |
| `Disc` | • | N/A |
| `Circle` | ◦ | N/A |
| `Square` | ▪ | N/A |

Out-of-range values fall back to decimal representation.

### CounterSystem Struct

Manages counter scopes during DOM traversal:

```rust
pub struct CounterSystem {
    scopes: Vec<CounterScope>,
}
```

Key operations:
- `push_scope()` / `pop_scope()` - Manage scope stack during tree traversal
- `reset_counter(name, value)` - Create/reset counter (counter-reset)
- `increment_counter(name, delta)` - Increment counter (counter-increment)
- `set_counter(name, value)` - Set counter value (counter-set)
- `get_counter(name)` - Get current value
- `get_counters(name)` - Get all nested values for counters()

### Scope Model

Counters follow CSS scoping rules:
1. `counter-reset` creates a new counter instance in the current scope
2. `counter-increment` affects the nearest matching counter in ancestor scopes
3. Child scopes can shadow parent counters via `counter-reset`
4. When a scope is popped, its counter instances are discarded

This enables nested list numbering like:
```
1.
  1.1
  1.2
    1.2.1
    1.2.2
2.
```

### Property Parsers

Three property value parsers:
- `CounterReset::parse(value)` - Parse `counter-reset: name value ...`
- `CounterIncrement::parse(value)` - Parse `counter-increment: name delta ...`
- `CounterSet::parse(value)` - Parse `counter-set: name value ...`

All support:
- `none` keyword
- Multiple counters
- Negative values
- Default values (0 for reset/set, 1 for increment)

## Counter Name Validation

Counter names follow CSS identifier rules:
- Must start with letter, underscore, or hyphen (followed by non-digit)
- Can contain letters, digits, underscores, hyphens
- Cannot be CSS keywords (inherit, initial, unset, revert, none)

## Integration Points

For downstream tasks implementing content generation (W5.T10):

```rust
use fastrender::style::counters::{CounterSystem, CounterStyle};

let mut counters = CounterSystem::new();

// During DOM traversal, for each element:
counters.push_scope();

// Apply counter-reset from styles
if let Some(reset) = CounterReset::parse(&style.counter_reset) {
    reset.apply(&mut counters);
}

// Apply counter-increment from styles
if let Some(incr) = CounterIncrement::parse(&style.counter_increment) {
    incr.apply(&mut counters);
}

// Generate content: counter(section, upper-roman)
let content = counters.format_counter("section", CounterStyle::UpperRoman);

// Generate content: counters(item, ".")
let content = counters.format_counters("item", ".", CounterStyle::Decimal);

// After processing element's children:
counters.pop_scope();
```

## Test Coverage

66 tests covering:
- Counter style formatting (13 tests)
- Counter system operations (24 tests)
- Property parsing (20 tests)
- Integration scenarios (9 tests)

Integration tests include:
- Document outline numbering (chapters and sections)
- Nested list numbering with counters()
- Roman numeral appendixes
- Alphabetic footnotes
- Multiple independent counters
- Custom increment values
- Counter decrement (negative increment)

## Notes for Downstream Tasks

1. **Content Generation (W5.T10)**: This module provides the counter tracking infrastructure. W5.T10 should integrate by:
   - Creating a CounterSystem at the start of content generation
   - Calling push_scope/pop_scope during tree traversal
   - Parsing and applying counter-reset/counter-increment properties
   - Using format_counter/format_counters for content generation

2. **List Marker Generation**: For `<ol>` elements, use:
   ```rust
   system.reset_counter("list-item", start_value);
   // For each <li>:
   system.increment_counter("list-item", 1);
   let marker = system.format_counter("list-item", list_style_type);
   ```

3. **Performance**: CounterSystem clones are cheap (only scope stack, not shared). Consider cloning before recursive traversal if parallel processing is needed.
