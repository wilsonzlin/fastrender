# W2.T09: FormattingContext Factory Structure - Implementation Notes

## Summary

Implemented FormattingContextFactory for creating FormattingContext implementations based on box properties.

## Files Created

- `src/layout/contexts/factory.rs` (~350 lines)
  - FormattingContextFactory struct with `create_for_box()` and `create_specific()`
  - 5 stub FC implementations (Block, Inline, Flex, Grid, Table)
  - 12 comprehensive tests

## Files Modified

- `src/layout/contexts/mod.rs` - Added factory module and re-export
- `src/layout/mod.rs` - Added FormattingContextFactory to re-exports

## API

```rust
pub struct FormattingContextFactory;

impl FormattingContextFactory {
    pub fn new() -> Self;

    /// Creates FC based on box's formatting_context()
    pub fn create_for_box(&self, box_node: &BoxNode)
        -> Result<Box<dyn FormattingContext>, LayoutError>;

    /// Creates FC for specific type (bypasses box analysis)
    pub fn create_specific(&self, fc_type: FormattingContextType)
        -> Box<dyn FormattingContext>;
}
```

## Design Decisions

1. **Trait Objects**: Returns `Box<dyn FormattingContext>` for runtime polymorphism
2. **Stateless Factory**: No caching, simple creation
3. **Private Stubs**: Stub implementations are private, only accessible through factory
4. **Error on Inline**: `create_for_box()` returns error for boxes that don't establish FC

## Integration

Used by LayoutEngine (W2.T10):
```rust
let factory = FormattingContextFactory::new();
let fc = factory.create_for_box(&box_node)?;
let fragment = fc.layout(&box_node, &constraints)?;
```

## Stub Replacement Path

Each stub will be replaced in future waves:
- Block: W3.T04
- Inline: W4.T12
- Flex: W3.T08 (likely Taffy delegation)
- Grid: Wave 4+ (likely Taffy delegation)
- Table: W3.T06

## Tests

All 12 tests passing:
- Factory creation and default
- All 5 FC types create successfully
- Inline box correctly fails (doesn't establish FC)
- Intrinsic sizing works
- Indefinite constraints handled
- Factory reuse works
