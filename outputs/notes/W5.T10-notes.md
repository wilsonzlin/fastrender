# W5.T10 Content Generation - Implementation Notes

## Summary

This task implemented CSS content generation for pseudo-elements (`::before` and `::after`). The implementation provides a complete system for generating text content from the CSS `content` property, including support for strings, `attr()`, `counter()`, `counters()`, and quote functions.

## Dependencies

- **W3.T01**: Box generation algorithm (for context on box tree structure)
- **W5.T09**: Pseudo-element box generation (will use this content generation system)

## Implementation Details

### 1. Core Types

The implementation provides the following core types in `src/style/content.rs`:

#### ContentValue

Represents the computed value of the CSS `content` property:

```rust
pub enum ContentValue {
    None,      // content: none (no pseudo-element generated)
    Normal,    // content: normal (default for pseudo-elements)
    Items(Vec<ContentItem>),  // One or more content items
}
```

#### ContentItem

Individual content items that can appear in a content value:

```rust
pub enum ContentItem {
    String(String),                           // "text"
    Attr { name, type_or_unit, fallback },   // attr(data-label)
    Counter { name, style },                  // counter(chapter)
    Counters { name, separator, style },      // counters(section, ".")
    OpenQuote,                                // open-quote
    CloseQuote,                               // close-quote
    NoOpenQuote,                              // no-open-quote
    NoCloseQuote,                             // no-close-quote
    Url(String),                              // url(image.png)
}
```

#### CounterStyle

Formatting styles for counters:

```rust
pub enum CounterStyle {
    Decimal,           // 1, 2, 3
    DecimalLeadingZero,// 01, 02, 03
    LowerRoman,        // i, ii, iii
    UpperRoman,        // I, II, III
    LowerAlpha,        // a, b, c
    UpperAlpha,        // A, B, C
    LowerGreek,        // α, β, γ
    Disc,              // •
    Circle,            // ◦
    Square,            // ▪
    None,              // (empty)
}
```

### 2. ContentContext

Maintains state needed for content generation:

```rust
pub struct ContentContext {
    counters: HashMap<String, Vec<i32>>,  // Counter stacks for nesting
    attributes: HashMap<String, String>,   // Element attributes
    quote_depth: usize,                    // Quote nesting level
    quotes: Vec<(String, String)>,         // Quote characters per level
}
```

Key methods:
- `set_counter()`, `get_counter()`, `increment_counter()` - Counter manipulation
- `push_counter()`, `pop_counter()` - Nested counter scopes
- `get_counters()` - All values for `counters()` function
- `set_attribute()`, `get_attribute()` - Element attribute access
- `open_quote()`, `close_quote()`, `push_quote()`, `pop_quote()` - Quote handling

### 3. ContentGenerator

Generates text from content values:

```rust
pub struct ContentGenerator {}

impl ContentGenerator {
    pub fn new() -> Self;
    pub fn generate(&self, content: &ContentValue, context: &mut ContentContext) -> String;
    pub fn is_text_only(content: &ContentValue) -> bool;
}
```

### 4. Parser Function

```rust
pub fn parse_content(input: &str) -> Option<ContentValue>;
```

Parses CSS content property values from strings.

## API Contracts

### Counter Management

1. **Counter initialization**: Counters default to 0 when first accessed
2. **Nested counters**: Use `push_counter()` when entering a scope, `pop_counter()` when leaving
3. **Counter format**: Default style is `Decimal`

### Quote Handling

1. **Quote depth**: Starts at 0 (no open quotes)
2. **Default quotes**: `["", "", "'", "'"]` (curly quotes)
3. **Close quote timing**: Call `close_quote()` BEFORE `pop_quote()` to get correct character

### Content Generation

1. **Empty content**: `ContentValue::None` and `ContentValue::Normal` generate empty strings
2. **URL content**: Returns empty string (should be handled as image by caller)
3. **Concatenation**: Multiple items are concatenated in order

## Usage Examples

### Basic String Content

```rust
let content = ContentValue::from_string("Hello, World!");
let gen = ContentGenerator::new();
let mut ctx = ContentContext::new();
let text = gen.generate(&content, &mut ctx);
assert_eq!(text, "Hello, World!");
```

### Counter-based Content

```rust
let content = ContentValue::Items(vec![
    ContentItem::String("Chapter ".to_string()),
    ContentItem::counter("chapter"),
    ContentItem::String(": ".to_string()),
]);

let gen = ContentGenerator::new();
let mut ctx = ContentContext::new();
ctx.set_counter("chapter", 5);

let text = gen.generate(&content, &mut ctx);
assert_eq!(text, "Chapter 5: ");
```

### Nested Counters (Outline Numbering)

```rust
let content = ContentValue::Items(vec![
    ContentItem::counters("section", "."),
]);

let gen = ContentGenerator::new();
let mut ctx = ContentContext::new();
ctx.push_counter("section", 1);
ctx.push_counter("section", 2);
ctx.push_counter("section", 3);

let text = gen.generate(&content, &mut ctx);
assert_eq!(text, "1.2.3");
```

### Parsing Content Property

```rust
let content = parse_content("\"Chapter \" counter(chapter, upper-roman)").unwrap();
// Produces: ContentValue::Items(vec![
//   ContentItem::String("Chapter "),
//   ContentItem::Counter { name: "chapter", style: Some(UpperRoman) }
// ])
```

## CSS Spec Compliance

### CSS Generated Content Module Level 3

Reference: https://www.w3.org/TR/css-content-3/

Implemented features:
- String values
- `attr()` function (basic form)
- `counter()` function
- `counters()` function
- Quote keywords (`open-quote`, `close-quote`, `no-open-quote`, `no-close-quote`)
- `url()` function (parsing only - rendering handled separately)

### CSS Counter Styles Level 3

Reference: https://www.w3.org/TR/css-counter-styles-3/

Implemented styles:
- `decimal`, `decimal-leading-zero`
- `lower-roman`, `upper-roman`
- `lower-alpha`, `upper-alpha` (also `lower-latin`, `upper-latin`)
- `lower-greek`
- `disc`, `circle`, `square`
- `none`

## Test Coverage

- **Unit tests**: 49 tests in `src/style/content.rs`
- **Integration tests**: 70 tests in `tests/content_generation_test.rs`

Test categories:
- ContentValue construction and methods
- ContentItem construction and display
- CounterStyle formatting and parsing
- ContentContext counter operations
- ContentContext quote handling
- ContentGenerator generation
- Content parsing
- Workflow integration tests

## Files Changed

| File | Changes |
|------|---------|
| `src/style/content.rs` | New file: ~1200 lines (types, generator, parser, tests) |
| `src/style/mod.rs` | Added `content` module and re-exports |
| `tests/content_generation_test.rs` | New file: ~700 lines (integration tests) |

## Verification

```
cargo test style::content
# 49 passed

cargo test --test content_generation_test
# 70 passed

cargo clippy --lib -p fastrender -- -D warnings
# No warnings in content module

cargo fmt
# Applied formatting
```

## Future Work

1. **W5.T09 Integration**: Pseudo-element box generation will use `ContentGenerator` to create text content for `::before` and `::after` boxes

2. **Image content**: The `url()` function currently returns empty string. Image content requires integration with the image loading and replaced element systems.

3. **CSS attr() Level 3**: Currently only basic `attr(name)` is fully supported. Future work could add type coercion and more fallback options.

4. **Custom counter styles**: Could add support for `@counter-style` rule for custom numbering systems.

5. **Leader functions**: CSS Generated Content Module Level 3 includes `leader()` function for table of contents leaders (not implemented).

## Key Design Decisions

1. **Separate context from generator**: `ContentContext` holds mutable state (counters, quotes) while `ContentGenerator` is stateless, allowing the same generator to be reused.

2. **Counter stacks**: Counters use `Vec<i32>` to support nested scopes (e.g., nested lists with `counters()` function).

3. **Quote depth tracking**: Quotes use a simple depth counter rather than a stack since only the nesting level matters.

4. **Fail-safe parsing**: `parse_content()` returns `Option` and gracefully handles invalid input by returning `None`.

5. **Display implementations**: All types implement `Display` for debugging and CSS serialization.
