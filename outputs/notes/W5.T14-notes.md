# W5.T14: CSS var() Resolution Implementation Notes

## Overview

This task implements a dedicated module for CSS `var()` function resolution as specified in the CSS Custom Properties for Cascading Variables Module Level 1. The module provides robust substitution of CSS custom property references with proper handling of fallback values, nested references, and recursion protection.

## Implementation Structure

### Module Organization

```
src/style/var_resolution.rs    - Main var() resolution implementation
tests/test_var.rs              - Comprehensive integration tests
```

### Key Types

#### VarResolutionResult

```rust
pub enum VarResolutionResult {
    Resolved(PropertyValue),       // Successfully resolved to a value
    NotFound(String),              // Variable not found, no fallback
    RecursionLimitExceeded,        // Depth limit reached
    InvalidSyntax(String),         // Malformed var() syntax
}
```

### Key Functions

#### resolve_var

```rust
pub fn resolve_var(
    value: &PropertyValue,
    custom_properties: &HashMap<String, String>
) -> PropertyValue
```

Main entry point for var() resolution. Handles:
- Simple `var(--name)` references
- Fallback values: `var(--name, fallback)`
- Nested var() references in fallbacks
- var() embedded within CSS functions (e.g., `calc(var(--size) + 10px)`)

#### resolve_var_with_depth

```rust
pub fn resolve_var_with_depth(
    value: &PropertyValue,
    custom_properties: &HashMap<String, String>,
    depth: usize
) -> PropertyValue
```

Exposes depth tracking for custom resolution strategies.

#### Utility Functions

- `contains_var(value: &str) -> bool` - Check if string contains var() references
- `extract_var_references(value: &str) -> Vec<String>` - Extract all referenced custom property names
- `is_valid_custom_property_name(name: &str) -> bool` - Validate custom property naming

## Algorithm Flow

### Resolution Process

1. **Check Input Type**: Only `PropertyValue::Keyword` values are processed
2. **Simple var() Detection**: Check if value is a complete `var(...)` expression
3. **Argument Parsing**: Split into variable name and optional fallback using `split_var_args`
4. **Property Lookup**: Check custom_properties map for the variable
5. **Value Parsing**: Parse resolved value using `parse_property_value`
6. **Fallback Handling**: If not found, use fallback (which may itself contain var())
7. **Recursive Resolution**: Continue resolving nested var() references

### Recursion Protection

- Maximum depth of 10 levels to prevent infinite loops
- Circular reference detection via depth tracking
- Safety limit of 100 iterations for embedded var() replacement

### Embedded var() Handling

For values like `calc(var(--size) + 10px)`:
1. Find each var() occurrence in the string
2. Match parentheses properly (handles nested parens in fallbacks)
3. Resolve and substitute in-place
4. Re-parse the final result

## CSS Specification References

- CSS Custom Properties for Cascading Variables Module Level 1
  https://www.w3.org/TR/css-variables-1/

Key behaviors implemented:
- Custom property names must start with `--`
- Fallback values are comma-separated: `var(--name, fallback)`
- Fallbacks can contain additional var() references
- Invalid var() references result in the property being ignored

## Integration Points

### Dependencies

- `crate::css::PropertyValue` - Enum for CSS property values
- `crate::css::parse_property_value` - Parsing resolved values into typed representations

### Usage in Style System

The module is integrated via `src/style/mod.rs`:

```rust
fn resolve_var(value: &PropertyValue, custom_properties: &HashMap<String, String>) -> PropertyValue {
    var_resolution::resolve_var(value, custom_properties)
}
```

Called during style computation to resolve custom property references before applying values.

## Test Coverage

### Unit Tests (src/style/var_resolution.rs) - 22 tests

- Basic var() resolution
- Fallback value handling
- Nested var() in fallbacks
- Chained variable resolution
- Embedded var() in calc() expressions
- Multiple var() in single value
- Recursion limit enforcement
- Utility function tests

### Integration Tests (tests/test_var.rs) - 32 tests

- Color value resolution
- Length value resolution (px, em, rem)
- Keyword value resolution
- Fallback value usage
- Nested fallback resolution
- Variable chaining
- calc() integration
- Box shadow with var()
- Circular reference protection
- Edge cases (empty var, whitespace, non-existent)

## Design Decisions

### Property-Agnostic Resolution

The var() resolution module operates independently of property context. Color values like `#ffffff` are returned as `PropertyValue::Keyword` rather than `PropertyValue::Color` because the CSS parser requires property context (e.g., "color", "background-color") to determine value types. The actual type interpretation happens when the property is applied.

### HashMap for Custom Properties

Uses `HashMap<String, String>` for custom properties storage. The `#[allow(clippy::implicit_hasher)]` attribute is used because:
1. This is an internal module with known usage patterns
2. No need for hasher flexibility in this context
3. Keeps the API simple and consistent

### String-Based Fallback Parsing

Fallback values are kept as strings during resolution and re-parsed after substitution. This ensures proper handling of complex fallbacks like `var(--size, calc(10px + 5px))`.

## Known Limitations

1. **No env() support**: CSS environment variables (`env()`) are not supported
2. **No registered properties**: `@property` registered custom properties are not validated
3. **No animation support**: Animated custom properties require additional handling
4. **Property-agnostic**: Colors and other context-dependent types need property context

## Future Improvements

1. **Property-aware resolution**: Pass property name for context-dependent parsing
2. **Cycle detection reporting**: Report which variables form cycles
3. **env() function support**: Handle CSS environment variables
4. **Typed custom properties**: Support `@property` registered properties
5. **Animation integration**: Support animatable custom properties

## Files Modified/Created

- Created: `src/style/var_resolution.rs` - Main module
- Created: `tests/test_var.rs` - Integration tests
- Modified: `src/style/mod.rs` - Added module export and integration
- Created: `outputs/notes/W5.T14-notes.md` - This documentation
