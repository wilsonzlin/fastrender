# W6.T03 - Implement Public API Notes

## Task Summary

This task implements a clean, simple public API for FastRender V2 that provides a unified entry point for HTML/CSS to image rendering.

## Implementation Details

### Files Created/Modified

1. **`src/api.rs`** (new) - Main public API module
   - `FastRender` struct - Main entry point with `FontContext` and `LayoutEngine`
   - `FastRenderConfig` struct - Configuration with builder pattern
   - Methods: `new()`, `with_config()`, `render_html()`, `render_html_with_background()`, `parse_html()`, `layout_document()`, `paint()`
   - Re-exports `tiny_skia::Pixmap` for public use

2. **`src/lib.rs`** (modified)
   - Added `pub mod api` declaration
   - Added re-exports: `FastRender`, `FastRenderConfig`, `Pixmap`
   - Added re-exports: `FragmentContent`, `FragmentNode`, `FragmentTree`
   - Added re-exports: `LayoutConfig`, `LayoutEngine`, `FontContext`
   - Updated Quick Start documentation with new API example

3. **`tests/test_public_api.rs`** (new) - Comprehensive test suite
   - 17 passing tests for API functionality
   - 16 ignored tests for full rendering pipeline (pending integration)

### API Design

```rust
pub struct FastRender {
    font_context: FontContext,
    layout_engine: LayoutEngine,
    background_color: Color,
}

impl FastRender {
    // Creation
    pub fn new() -> Result<Self>
    pub fn with_config(config: FastRenderConfig) -> Result<Self>

    // Rendering
    pub fn render_html(&mut self, html: &str, width: u32, height: u32) -> Result<Pixmap>
    pub fn render_html_with_background(&mut self, ..., background: Color) -> Result<Pixmap>

    // Step-by-step access
    pub fn parse_html(&self, html: &str) -> Result<DomNode>
    pub fn layout_document(&mut self, dom: &DomNode, width: u32, height: u32) -> Result<FragmentTree>
    pub fn paint(&self, fragment_tree: &FragmentTree, width: u32, height: u32) -> Result<Pixmap>

    // Component access
    pub fn font_context(&self) -> &FontContext
    pub fn font_context_mut(&mut self) -> &mut FontContext
    pub fn layout_engine(&self) -> &LayoutEngine
    pub fn background_color(&self) -> Color
    pub fn set_background_color(&mut self, color: Color)
}

pub struct FastRenderConfig {
    pub background_color: Color,
    pub default_width: u32,
    pub default_height: u32,
}

impl FastRenderConfig {
    pub fn new() -> Self
    pub fn with_default_background(self, color: Color) -> Self
    pub fn with_default_viewport(self, width: u32, height: u32) -> Self
}
```

### Test Coverage

The test suite covers:

1. **Creation Tests** (passing)
   - `test_fastrender_new` - Basic instantiation
   - `test_fastrender_with_default_config` - Default configuration
   - `test_fastrender_with_custom_config` - Custom configuration

2. **Configuration Tests** (passing)
   - `test_config_default_values` - Default config values
   - `test_config_builder_pattern` - Builder pattern works

3. **HTML Parsing Tests** (passing)
   - `test_parse_html_simple` - Simple HTML parsing
   - `test_parse_html_full_document` - Full document parsing
   - `test_parse_html_with_style` - HTML with embedded CSS
   - `test_parse_html_empty` - Empty HTML handling

4. **Component Access Tests** (passing)
   - `test_font_context_access` - FontContext access
   - `test_font_context_mut_access` - Mutable FontContext access
   - `test_layout_engine_access` - LayoutEngine access
   - `test_background_color_get_set` - Background color get/set

5. **Validation Tests** (passing)
   - `test_render_html_invalid_dimensions` - Zero dimensions error

6. **Re-export Tests** (passing)
   - `test_reexports_from_lib` - Crate root re-exports
   - `test_fragment_tree_type_reexport` - FragmentTree accessible
   - `test_css_color_available` - Color type accessible

7. **Rendering Tests** (ignored - pending pipeline integration)
   - Full rendering pipeline tests (16 tests)
   - Marked with `#[ignore = "Full rendering pipeline integration pending"]`
   - Matches pattern used in `integration_test.rs`

### Design Decisions

1. **Separate from Legacy Renderer**
   - Created new `FastRender` API separate from existing `Renderer`
   - Allows gradual migration without breaking existing code

2. **Debug Implementation**
   - Custom `Debug` impl for `FastRender` since `FontContext` and `LayoutEngine` don't implement `Debug`
   - Shows only `background_color` with `finish_non_exhaustive()`

3. **Error Handling**
   - All methods return `Result<T>` for proper error handling
   - Validates dimensions (rejects zero width/height)

4. **Configuration Pattern**
   - Builder pattern for `FastRenderConfig`
   - Sensible defaults (white background, 800x600 viewport)

5. **Test Organization**
   - Ignored tests for functionality requiring full pipeline integration
   - Follows same pattern as `integration_test.rs`

### Dependencies

- `FontContext` from `src/text/font_loader.rs`
- `LayoutEngine` from `src/layout/engine.rs`
- `FragmentTree` from `src/tree/fragment_tree.rs`
- `DomNode` from `src/dom.rs`
- `Color` from `src/css/mod.rs`
- `Pixmap` from `tiny_skia` crate

### Known Limitations

1. **Full rendering pipeline not integrated**
   - Layout fails for complex documents ("box does not establish a formatting context")
   - Rendering tests are ignored until pipeline integration is complete
   - This is expected and matches the state of `integration_test.rs`

2. **No image format encoding in API**
   - Returns raw `Pixmap` which can be saved via `pixmap.save_png()`
   - Users can use `image` crate for other formats if needed

### Verification

```bash
# Build verification
cargo build  # SUCCESS

# Test verification
cargo test api  # 9 passed, 5 ignored (lib)
cargo test --test test_public_api  # 17 passed, 16 ignored
```

### Usage Example

```rust
use fastrender::FastRender;

let mut renderer = FastRender::new()?;

let html = r#"
    <!DOCTYPE html>
    <html>
        <head>
            <style>
                body { background: #f0f0f0; }
                h1 { color: navy; }
            </style>
        </head>
        <body>
            <h1>Hello, FastRender!</h1>
        </body>
    </html>
"#;

let pixmap = renderer.render_html(html, 800, 600)?;
pixmap.save_png("output.png")?;
```

## Future Work

1. **Pipeline Integration** - Once W6.T02 (integration module) is complete, enable ignored tests
2. **Additional Formats** - Consider adding `render_to_png()`, `render_to_jpeg()` convenience methods
3. **Streaming API** - Consider adding streaming/incremental rendering support
4. **Resource Loading** - Add methods to configure resource loading (fonts, images)
