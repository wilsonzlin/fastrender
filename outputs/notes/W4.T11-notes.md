# W4.T11: Text Justification - Implementation Notes

## Overview

Implemented text justification following CSS Text Module Level 3 specification. The implementation distributes extra horizontal space in a line to make text flush with both margins.

## Files Created/Modified

### New Files
- `src/text/justify.rs` - Main justification module with algorithms and types
- `tests/text_justify_test.rs` - Comprehensive test suite (57 tests)

### Modified Files
- `src/text/mod.rs` - Added module declaration and re-exports

## Core Types

### GlyphPosition
Represents a positioned glyph in a line:
```rust
pub struct GlyphPosition {
    pub glyph_id: u16,
    pub x: f32,
    pub y: f32,
    pub x_advance: f32,
    pub y_advance: f32,
    pub is_word_boundary: bool,
    pub cluster: usize,
}
```

### JustificationOptions
Configurable options for justification behavior:
- `min_fill_ratio` (default: 0.75) - Minimum line fill before justifying
- `max_word_spacing_ratio` (default: 3.0) - Maximum extra space per word
- `use_letter_spacing_fallback` (default: true) - Use letter spacing when no word boundaries
- `max_letter_spacing` (default: 2.0) - Maximum extra space between letters
- `justify_last_line` (default: false) - Whether to justify the last line

### JustificationResult
Reports details of justification applied:
- `extra_space_added` - Total extra space distributed
- `space_per_word` - Extra space at each word boundary
- `space_per_letter` - Extra space between each letter (if used)
- `word_boundaries_used` / `letter_spaces_used` - Count of expansion points
- `is_justified` - Whether justification was applied

## Main Functions

### justify_line
Simple entry point using default options:
```rust
pub fn justify_line(
    glyphs: &mut [GlyphPosition],
    target_width: f32,
    current_width: f32,
)
```

### justify_line_with_options
Advanced entry point with configurable options:
```rust
pub fn justify_line_with_options(
    glyphs: &mut [GlyphPosition],
    target_width: f32,
    current_width: f32,
    options: &JustificationOptions,
) -> JustificationResult
```

### justify_lines
Multi-line justification with support for last-line handling:
```rust
pub fn justify_lines(
    lines: &mut [Vec<GlyphPosition>],
    target_width: f32,
    options: &JustificationOptions,
) -> Vec<JustificationResult>
```

## Algorithm

The justification algorithm follows these steps:

1. **Calculate extra space**: `extra_space = target_width - current_width`

2. **Check minimum fill ratio**: If `current_width < target_width * min_fill_ratio`, skip justification (line is too short)

3. **Count word boundaries**: Glyphs marked with `is_word_boundary = true`

4. **Distribute space**:
   - If word boundaries exist: Distribute evenly among word boundaries
   - If word spacing would be excessive: Use combined word + letter spacing
   - If no word boundaries: Use letter spacing as fallback (for CJK text)

5. **Apply offsets**: Adjust x positions cumulatively for all glyphs

## Helper Functions

### mark_word_boundaries
Marks word boundaries based on text content:
```rust
pub fn mark_word_boundaries(glyphs: &mut [GlyphPosition], text: &str)
```

### mark_word_boundaries_by_glyph_id
Marks word boundaries based on space glyph IDs:
```rust
pub fn mark_word_boundaries_by_glyph_id(glyphs: &mut [GlyphPosition], space_glyph_ids: &[u16])
```

### detect_justification_mode
Analyzes text to determine appropriate justification mode:
```rust
pub fn detect_justification_mode(text: &str) -> JustificationMode
```

Returns:
- `WordSpacing` - For Latin/Western text
- `LetterSpacing` - For CJK text
- `Combined` - For mixed content

### apply_alignment
Applies left/right/center alignment by shifting glyphs:
```rust
pub fn apply_alignment(
    glyphs: &mut [GlyphPosition],
    line_width: f32,
    available_width: f32,
    alignment: TextAlignment,
) -> f32
```

## CJK Support

The implementation includes CJK-aware functionality:

- `is_cjk_character(ch: char) -> bool` - Detects CJK characters
- Automatic mode detection for mixed scripts
- Letter spacing fallback for scripts without word spaces

## TextAlignment Enum

Corresponds to CSS `text-align` property:
```rust
pub enum TextAlignment {
    Left,
    Right,
    Center,
    Justify,
}
```

Includes `from_css()` parser supporting "left", "right", "center", "justify", "start", "end".

## Test Coverage

The test suite (74 total tests: 17 unit + 57 integration) covers:

- GlyphPosition construction and methods
- JustificationOptions builder pattern
- Basic word-spacing justification
- Letter-spacing fallback
- Combined spacing for extreme cases
- Minimum fill ratio thresholds
- Multi-line justification
- Last line handling
- Word boundary detection
- CJK character detection
- Text alignment application
- Edge cases (empty lines, single glyph, very small spaces)

## Integration Points

The justify module integrates with:

1. **Line Breaking (W4.T09)**: Receives shaped glyphs after line breaking
2. **Text Shaping**: Uses GlyphPosition for positioned glyph data
3. **Fragment Tree**: Final positions are used to create text fragments
4. **ComputedStyles**: Respects `text-align` property values

## CSS Compliance

Implements CSS Text Module Level 3 justification semantics:
- Word spacing distribution (primary)
- Letter spacing as fallback
- Last line handling (`text-align-last` via options)
- Minimum fill thresholds to avoid over-justified short lines

## Performance Considerations

- Single pass O(n) algorithm for each line
- No allocations during justification (in-place modification)
- Efficient word boundary counting
- Stateless design allows parallel line processing

## Future Enhancements

Potential improvements for future tasks:
1. Integration with hyphenation (W4.T10)
2. Support for `text-justify` CSS property (inter-word, inter-character, auto)
3. BiDi-aware justification for RTL text
4. Kashida insertion for Arabic script
5. Ruby annotation handling for CJK
