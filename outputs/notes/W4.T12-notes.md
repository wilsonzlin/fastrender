# W4.T12 - Inline Layout: Notes

## Overview

This task implements the Inline Formatting Context (IFC) layout algorithm as specified in CSS 2.1 Section 9.4.2 and CSS Inline Layout Module Level 3.

## Implementation Summary

### Files Created

1. **`src/layout/contexts/inline/mod.rs`** - Main IFC implementation
   - `InlineFormattingContext` struct implementing `FormattingContext` trait
   - Inline item collection from box tree
   - Line breaking coordination
   - Fragment tree generation

2. **`src/layout/contexts/inline/line_builder.rs`** - Line building algorithm
   - `InlineItem` enum (Text, StartInlineBox, EndInlineBox, Atomic, SoftBreakOpportunity, HardBreak)
   - `TextRun` struct for styled text segments
   - `Line` struct for line boxes
   - `LineBuilder` for breaking items into lines

3. **`src/layout/contexts/inline/baseline.rs`** - Baseline alignment
   - `ItemMetrics` for item dimensions
   - Baseline computation functions
   - Vertical alignment helpers (baseline, top, bottom, middle)

### Files Modified

- **`src/layout/contexts/mod.rs`** - Added inline module and re-export

## Algorithm Details

### Phase 1: Build Inline Items

The algorithm traverses the box tree and creates a flat list of inline items:
- Text runs are split at word boundaries for line breaking
- Inline box boundaries are marked with start/end items
- Atomic inline boxes (inline-block, replaced elements) are handled as unbreakable units
- Soft break opportunities are inserted between words

### Phase 2: Break Into Lines

The line builder distributes items across lines:
- Items are collected until a soft break opportunity is encountered
- At soft breaks, pending items are committed if they fit on the current line
- If items don't fit, a line break occurs and a new line starts
- Hard breaks (e.g., `<br>`) force immediate line breaks
- Long words that exceed line width overflow (no hyphenation)

### Phase 3: Baseline Alignment

For each line:
- Compute maximum ascent (above baseline) and descent (below baseline)
- Line height = max_ascent + max_descent
- Baseline position = max_ascent from top of line box
- Position each item so its baseline aligns with the line baseline

### Phase 4: Fragment Generation

- Create line box fragments containing positioned text/inline fragments
- Each line box has a baseline offset stored in `FragmentContent::Line`
- The containing block fragment wraps all line boxes

## Key Design Decisions

### Text Segmentation

Text is split at whitespace boundaries to enable proper line breaking:
```rust
"Hello world test" -> ["Hello", " ", "world", " ", "test"]
```

Each segment gets a soft break opportunity between words.

### Estimated Text Metrics

When no `FontContext` is provided, text width is estimated as:
```rust
width = text.len() * font_size * 0.5
baseline = font_size * 0.8
```

This allows the algorithm to work without font loading while still producing reasonable layouts.

### Line Breaking Strategy

Uses a greedy algorithm:
1. Collect items until break opportunity
2. If items fit on current line, commit them
3. If items don't fit and line is non-empty, start new line
4. If line is empty, commit anyway (overflow)

This matches browser behavior for basic text wrapping.

## API Usage

```rust
use fastrender::layout::contexts::InlineFormattingContext;
use fastrender::layout::LayoutConstraints;

// Create IFC (with or without font context)
let ifc = InlineFormattingContext::new();
// or: let ifc = InlineFormattingContext::with_font_context(font_ctx);

// Layout inline content
let constraints = LayoutConstraints::definite(800.0, 600.0);
let fragment = ifc.layout(&box_node, &constraints)?;
```

## Intrinsic Sizing

- **MinContent**: Width of the longest unbreakable word
- **MaxContent**: Total width without any line breaks

## Test Coverage

64 tests covering:
- Basic text layout
- Line wrapping at word boundaries
- Multiple text nodes
- Inline boxes (nested and flat)
- Baseline alignment with different font sizes
- Intrinsic size computation (min/max content)
- Edge cases (empty text, whitespace-only, very long words)
- Error handling (missing width constraint)

## Dependencies Used

- **W2.T07**: BoxNode types (Text, Inline, Block, Replaced)
- **W3.T18**: FontContext.measure_text() for accurate text measurement
- **Fragment Tree**: FragmentNode constructors (new_text, new_line, new_inline, new_block)
- **Constraints**: LayoutConstraints for available space

## Future Enhancements

Not implemented in this task (per spec):
- Full vertical-align support (only baseline alignment implemented)
- Bidirectional text (RTL, bidi reordering)
- Complex script shaping (handled by FontContext when available)
- Hyphenation
- First-line/last-line handling
- Text-indent

## CSS Compliance

References:
- CSS 2.1 Section 9.4.2: Inline Formatting Contexts
- CSS 2.1 Section 10.8: Line Height Calculations
- CSS Inline Layout Module Level 3 (partial)
