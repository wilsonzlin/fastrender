# W3.T13: Absolute Positioning Algorithm - Implementation Notes

## Task Summary

Implemented the complete CSS absolute positioning algorithm as a dedicated module that handles the constraint equations from CSS 2.1 Sections 10.3.7 (width) and 10.6.4 (height).

## Implementation Details

### Files Created

1. **`src/layout/absolute_positioning.rs`** - Core absolute positioning module (~500 lines)
   - Complete constraint equation implementation
   - All offset combinations (left, right, top, bottom)
   - Static position fallback
   - Auto margin centering support
   - Comprehensive documentation

2. **`tests/layout/test_absolute.rs`** - Integration test suite (35+ tests)
   - Basic positioning tests
   - Constraint equation tests
   - Percentage value tests
   - Edge case tests
   - Fragment creation tests

### Key Types

```rust
/// Result of absolute layout calculation
pub struct AbsoluteLayoutResult {
    pub position: Point,      // Computed position relative to CB origin
    pub size: Size,           // Computed size
    pub margins: ResolvedMargins, // Resolved margins
}

/// Input for absolute layout
pub struct AbsoluteLayoutInput {
    pub style: ComputedStyle,
    pub intrinsic_size: Size,
    pub static_position: Point,
}

/// The absolute layout engine
pub struct AbsoluteLayout;
```

### Constraint Equation Implementation

The CSS 2.1 constraint equations are:

**Horizontal (Section 10.3.7):**
```
left + margin-left + border-left + padding-left + width +
padding-right + border-right + margin-right + right = CB width
```

**Vertical (Section 10.6.4):**
```
top + margin-top + border-top + padding-top + height +
padding-bottom + border-bottom + margin-bottom + bottom = CB height
```

### Cases Handled

1. **All three specified (overconstrained)** - Ignore right (LTR) / Ignore bottom
2. **left + width specified** - Compute position from left
3. **right + width specified** - Compute left position
4. **left + right specified (width auto)** - Stretch to fill
5. **Only left specified** - Use intrinsic width
6. **Only right specified** - Use intrinsic width
7. **Only width specified** - Use static position
8. **None specified** - Use static position and intrinsic size

### Static Position Fallback

When offset properties are `auto`, the element uses its "static position" - where it would have been placed in normal flow. This is crucial for elements like:

```css
.modal {
  position: absolute;
  width: 300px;  /* left/right auto -> use static position */
  height: 200px;
}
```

### Auto Margin Centering

The implementation includes support for centering via auto margins:

```rust
pub fn compute_centered_horizontal(&self, style, cb_width, width) -> (x, margin_left, margin_right)
pub fn compute_centered_vertical(&self, style, cb_height, height) -> (y, margin_top, margin_bottom)
```

This enables centering patterns like:
```css
.centered {
  position: absolute;
  left: 0; right: 0;
  margin-left: auto;
  margin-right: auto;
  width: 200px;
}
```

### Integration with Existing Code

The module integrates with:
- `ContainingBlock` from `positioned.rs` (W3.T12)
- `ComputedStyle` and `LengthOrAuto` from style module
- `FragmentNode` and `Rect` from tree/geometry modules
- `LayoutError` from formatting_context module

### Module Exports

Added to `src/layout/mod.rs`:
```rust
pub mod absolute_positioning;
pub use absolute_positioning::{
    AbsoluteLayout, AbsoluteLayoutInput, AbsoluteLayoutResult, ResolvedMargins
};
```

## Test Coverage

### Unit Tests (25 tests in absolute_positioning.rs)
- Basic layout calculations
- All constraint equation cases
- Percentage resolution
- Static position usage
- Containing block offset handling
- Overconstrained cases
- Edge cases (zero CB, negative sizes, large values)

### Integration Tests (35+ tests in test_absolute.rs)
- Basic absolute positioning
- Right/bottom positioning
- Stretch width/height
- Intrinsic size usage
- All constraint equation combinations
- Static position fallback
- Percentage values
- Containing block offsets
- Edge cases
- Fragment creation
- Static method validation

### Test Count Summary
- **Unit tests**: 25
- **Integration tests**: 35+
- **Total**: 60+ tests

## CSS Specification Compliance

The implementation follows:
- **CSS 2.1 Section 10.3.7**: Absolutely positioned, non-replaced elements (width)
- **CSS 2.1 Section 10.6.4**: Absolutely positioned, non-replaced elements (height)
- **CSS 2.1 Section 10.1**: Definition of "containing block"

### Overconstrained Rule

Per CSS 2.1, when all three values (left + width + right or top + height + bottom) are specified:
- **LTR direction**: Ignore `right`
- **Vertical**: Ignore `bottom`

## Design Decisions

1. **Stateless Engine**: `AbsoluteLayout` is stateless (`Default`, `Clone`) for easy sharing across threads
2. **Separated Input/Output**: Clear separation via `AbsoluteLayoutInput` and `AbsoluteLayoutResult`
3. **Static Position as Input**: Caller provides static position (computed during normal flow layout)
4. **Margins in Result**: Returns resolved margins for debugging and further calculations
5. **Fragment Creation Helper**: Convenience method to create `FragmentNode` from result

## Usage Example

```rust
use fastrender::layout::{AbsoluteLayout, AbsoluteLayoutInput, ContainingBlock};
use fastrender::geometry::{Point, Size};
use fastrender::style::ComputedStyle;

let layout = AbsoluteLayout::new();

let input = AbsoluteLayoutInput::new(
    style,
    Size::new(100.0, 80.0),  // intrinsic size
    Point::new(50.0, 100.0), // static position
);

let cb = ContainingBlock::viewport(Size::new(800.0, 600.0));
let result = layout.layout_absolute(&input, &cb)?;

// Result contains position, size, and margins
let fragment = layout.create_fragment(&result, children);
```

## Relationship to W3.T12

This task (W3.T13) builds on W3.T12 (Positioned Layout Base):

- **W3.T12**: Provided `ContainingBlock`, `StickyConstraints`, `PositionedLayout` with basic methods
- **W3.T13**: Adds complete `AbsoluteLayout` engine with full constraint equation handling

The two modules complement each other:
- `positioned.rs` handles position scheme detection, containing block determination, relative/sticky positioning
- `absolute_positioning.rs` focuses on the complete absolute positioning algorithm

## Future Considerations

1. **Replaced Elements**: CSS 2.1 Sections 10.3.8 and 10.6.5 have different rules for replaced elements
2. **RTL Support**: Currently assumes LTR; RTL would ignore `left` instead of `right`
3. **Min/Max Constraints**: Integration with `min-width`, `max-width`, `min-height`, `max-height`
4. **Percentage Heights**: Special handling when containing block height is auto

## Verification

```bash
# Build
cargo build  # Success, no warnings

# Tests
cargo test layout::absolute  # 25 passed
cargo test test_absolute     # 35+ passed

# Clippy
cargo clippy  # No warnings for fastrender
```

All tests pass and the implementation is ready for integration with the layout engine.
