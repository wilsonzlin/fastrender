# W3.T13: Absolute Positioning Algorithm - Implementation Notes

## Summary

This task implements the CSS 2.1 absolute positioning algorithm for non-replaced elements, following CSS 2.1 Sections 10.3.7 (horizontal) and 10.6.4 (vertical).

## Implementation Details

### New Module: `src/layout/absolute_positioning.rs`

#### Core Functions

1. **`layout_absolute(box_node, containing_block) -> AbsoluteLayoutResult`**
   - Main entry point for laying out absolutely positioned boxes
   - Combines horizontal and vertical constraint solving
   - Returns a `FragmentNode` positioned within the containing block

2. **`compute_absolute_horizontal(style, cb_width) -> HorizontalResult`**
   - Implements CSS 2.1 Section 10.3.7 constraint equation:
   ```
   left + margin-left + border-left + padding-left + width +
   padding-right + border-right + margin-right + right = cb_width
   ```
   - Handles all 8 cases based on which values are auto/specified

3. **`compute_absolute_vertical(style, cb_height) -> VerticalResult`**
   - Implements CSS 2.1 Section 10.6.4 constraint equation
   - Mirrors horizontal logic for vertical dimension

4. **`compute_centered_horizontal(style, cb_width) -> Option<HorizontalResult>`**
   - Special case: when `left: 0`, `right: 0`, `width: specified`, and margins are auto
   - Returns equal margins for centering

5. **`compute_centered_vertical(style, cb_height) -> Option<VerticalResult>`**
   - Vertical centering counterpart

6. **`is_out_of_flow(position) -> bool`**
   - Returns true for `position: absolute` or `position: fixed`

7. **`get_initial_containing_block(viewport_size) -> Rect`**
   - Returns the viewport as the initial containing block

#### Result Types

```rust
pub struct HorizontalResult {
    pub x: f32,           // Content box x position
    pub width: f32,       // Content box width
    pub margin_left: f32,
    pub margin_right: f32,
}

pub struct VerticalResult {
    pub y: f32,           // Content box y position
    pub height: f32,      // Content box height
    pub margin_top: f32,
    pub margin_bottom: f32,
}

pub struct AbsoluteLayoutResult {
    pub fragment: FragmentNode,
    pub horizontal: HorizontalResult,
    pub vertical: VerticalResult,
}
```

### Case Analysis

The algorithm handles 8 cases for each dimension based on which of `left/top`, `width/height`, `right/bottom` are specified:

| Case | left | width | right | Resolution |
|------|------|-------|-------|------------|
| 1 | ✓ | ✓ | ✓ | Overconstrained: ignore right (LTR) |
| 2 | ✓ | ✓ | - | Compute right |
| 3 | - | ✓ | ✓ | Compute left |
| 4 | ✓ | - | ✓ | Compute width |
| 5 | - | ✓ | - | Use static position for left |
| 6 | ✓ | - | - | Use shrink-to-fit width |
| 7 | - | - | ✓ | Use shrink-to-fit width, compute left |
| 8 | - | - | - | Use static position, shrink-to-fit width |

### Stub Functions

The following use placeholder values pending integration with content measurement:

- `compute_shrink_to_fit_width()` - Returns 50% of available width or 100px minimum
- `compute_auto_height()` - Returns 100px

## Integration Points

### Style Properties Used

From `ComputedStyles`:
- `left`, `right`, `top`, `bottom`: `Option<Length>` (None = auto)
- `width`, `height`: `Option<Length>` (None = auto)
- `margin_left/right/top/bottom`: `Option<Length>` (None = auto)
- `padding_left/right/top/bottom`: `Length`
- `border_left/right/top/bottom_width`: `Length`
- `position`: `Position` enum

### Geometry Types Used

- `Point`, `Rect`, `Size` from `crate::geometry`

### API for Downstream Tasks

```rust
use fastrender::layout::absolute_positioning::{
    layout_absolute,
    compute_absolute_horizontal,
    compute_absolute_vertical,
    compute_centered_horizontal,
    compute_centered_vertical,
    is_out_of_flow,
    get_initial_containing_block,
};
```

## Test Coverage

42 tests covering:
- Basic positioning with all specified values
- Auto width/height computation
- All 8 constraint equation cases (horizontal and vertical)
- Percentage values
- Centering with auto margins
- Padding and border handling
- Offset containing blocks
- Edge cases (zero width, negative values clamped)

## Known Limitations

1. **No child layout**: `layout_absolute` creates empty fragments; child layout requires integration with formatting contexts
2. **Shrink-to-fit width**: Uses placeholder; real implementation needs intrinsic size computation
3. **Auto height**: Uses placeholder; real implementation needs content height measurement
4. **Static position**: Always uses (0, 0); real implementation should use hypothetical box position
5. **RTL support**: Overconstrained cases assume LTR; should ignore left for RTL

## Downstream Dependencies

- **W3.T14 (Fixed Positioning)**: Can reuse most logic; only differs in containing block (viewport)
- **Block/Inline Layout**: Will need to collect absolutely positioned descendants during normal flow layout
- **Containing Block Resolution**: Will need to traverse ancestors to find nearest positioned element

## CSS References

- CSS 2.1 Section 10.3.7: https://www.w3.org/TR/CSS21/visudet.html#abs-non-replaced-width
- CSS 2.1 Section 10.6.4: https://www.w3.org/TR/CSS21/visudet.html#abs-non-replaced-height
- CSS 2.1 Section 10.1: https://www.w3.org/TR/CSS21/visudet.html#containing-block-details
