# W5.T02: Display List Builder Implementation Notes

## Overview

This task implements the Display List Builder, which converts the Fragment Tree (positioned boxes) into a flat list of paint commands. This is an intermediate representation between layout and painting that enables optimizations like viewport culling, deduplication, and caching.

## Implementation Structure

### Module Organization

```
src/paint/
  mod.rs                  - Paint module with exports
  display_list_builder.rs - Display list types and builders
  painter.rs              - Direct fragment tree painter (legacy)
```

### Key Types

#### Display Item Types

- `DisplayItem` - Enum of all paint operations (FillRect, DrawBorder, DrawText, DrawImage, PushClip, PopClip, PushOpacity, PopOpacity)
- `FillRect` - Fill a rectangle with solid color
- `DrawBorder` - Draw border with per-side width/color
- `DrawText` - Draw text at position with color and font size
- `DrawImage` - Draw image into rectangle
- `PushClip` / `PopClip` - Clipping region stack operations
- `PushOpacity` / `PopOpacity` - Opacity layer stack operations
- `BorderSide` - Helper for individual border side (width, color)

#### Display List

- `DisplayList` - Container for display items with utility methods
  - `push()` - Add item
  - `iter()` - Iterate items
  - `len()` / `is_empty()` - Size queries
  - `optimize()` - Remove transparent/empty items
  - `cull()` - Viewport culling

#### Builders

- `DisplayListBuilder` - Basic builder that walks fragment tree
- `StyledDisplayListBuilder` - Builder with explicit background/border styling
- `ClippingDisplayListBuilder` - Builder with PushClip/PopClip for overflow:hidden

## Algorithm Flow

### Pipeline

```
Fragment Tree → Display List Builder → Display List → Rasterizer → Pixels
```

### Paint Order (CSS 2.1 Appendix E)

For each fragment, the builder emits commands in this order:
1. Background color (if any)
2. Border (if any)
3. Content (text or replaced element)
4. Recurse to children (depth-first)

### Position Accumulation

Each fragment's position is relative to its parent. The builder tracks a cumulative offset:

```rust
fn build_fragment(&mut self, fragment: &FragmentNode, offset: Point) {
    let absolute_rect = Rect::new(
        Point::new(
            fragment.bounds.origin.x + offset.x,
            fragment.bounds.origin.y + offset.y,
        ),
        fragment.bounds.size,
    );
    // ... emit display items with absolute_rect

    for child in &fragment.children {
        self.build_fragment(child, absolute_rect.origin);
    }
}
```

### Clipping Support

For fragments with `overflow: hidden`, the ClippingDisplayListBuilder emits:
1. `PushClip` with the fragment's bounds
2. Child content
3. `PopClip`

This allows the rasterizer to maintain a clip stack.

## Display List Optimizations

### optimize() Method

Removes items that have no visible effect:
- FillRect with transparent color
- DrawBorder with no visible sides (zero width or transparent)
- DrawText with empty string or transparent color

### cull() Method

Viewport culling removes items completely outside the visible area:
- FillRect: Check if rect intersects viewport
- DrawBorder: Check if rect intersects viewport
- DrawText: Approximate text bounds and check intersection
- DrawImage: Check if rect intersects viewport
- Stack operations (PushClip/PopClip, PushOpacity/PopOpacity): Always preserved

## CSS Specification References

- CSS 2.1 Appendix E - Elaborate description of painting order
  https://www.w3.org/TR/CSS21/zindex.html
- CSS 2.1 Section 11.1.1 - Overflow: the 'overflow' property
  https://www.w3.org/TR/CSS21/visufx.html#overflow

## Integration Points

### Dependencies

- **W5.T01 (Display List Types)**: Display item definitions (inline since W5.T01 not yet complete)
- **W2.T03 (Fragment Tree)**: FragmentNode, FragmentContent, FragmentTree

### Produces

- `DisplayList` ready for rasterization
- Stack-based clipping/opacity regions

### Consumed By

- **W5.T07 (Rasterizer)**: Executes display list commands
- **W6.T02 (Rendering Pipeline)**: Converts layout result to pixels

## Test Coverage

Total: 23 tests in `paint::display_list_builder::tests`

### DisplayList Tests (8 tests)
- `test_display_list_new` - Empty list creation
- `test_display_list_push` - Adding items
- `test_display_list_with_items` - Creating with initial items
- `test_display_list_iter` - Iteration
- `test_display_list_optimize_removes_transparent` - Optimization removes transparent fills
- `test_display_list_optimize_removes_empty_text` - Optimization removes empty text
- `test_display_list_cull_removes_outside_viewport` - Viewport culling
- `test_display_list_cull_preserves_stack_ops` - Stack ops preserved during culling

### DisplayListBuilder Tests (6 tests)
- `test_builder_empty_fragment` - Empty block produces no items
- `test_builder_text_fragment` - Text fragment produces DrawText
- `test_builder_image_fragment` - Image fragment produces DrawImage
- `test_builder_nested_fragments` - Nested fragments all visited
- `test_builder_position_offset` - Child positions are absolute
- `test_fragment_tree_wrapper` - Can build from FragmentTree

### StyledDisplayListBuilder Tests (3 tests)
- `test_styled_builder_with_background` - Background color emits FillRect
- `test_styled_builder_with_border` - Border emits DrawBorder
- `test_styled_builder_transparent_background_skipped` - Transparent skipped

### ClippingDisplayListBuilder Tests (2 tests)
- `test_clipping_builder_no_clips` - No clips when not requested
- `test_clipping_builder_with_clip` - PushClip/PopClip emitted

### BorderSide Tests (2 tests)
- `test_border_side_none` - Zero-width border not visible
- `test_border_side_visible` - Visible border detection

### Integration Tests (2 tests)
- `test_complex_fragment_tree` - Real-world nested structure
- `test_deeply_nested_position_calculation` - Deep nesting position correctness

## Design Decisions

### Three Builder Variants

1. **DisplayListBuilder** - Basic traversal, emits text/image content only
   - Used when fragments don't carry style information
   - Background/border methods are stubs (require ComputedStyle)

2. **StyledDisplayListBuilder** - Accepts explicit styling
   - Takes background_color and border as parameters
   - Used when caller has access to style information

3. **ClippingDisplayListBuilder** - Handles overflow clipping
   - Takes a set of box_ids that should clip
   - Emits PushClip/PopClip around clipped content

This separation allows flexibility depending on available style information.

### Fragment Content Handling

The FragmentContent enum determines what content to draw:
- `Text` → DrawText command
- `Replaced (Image)` → DrawImage command
- `Block`, `Inline`, `Line` → No direct content (children handle their own)

### Default Values

When style information is unavailable:
- Text color defaults to BLACK
- Font size defaults to 16.0px

These defaults allow the builder to function without full style integration.

## Performance Notes

1. **Single Pass**: Tree is traversed once in depth-first order
2. **No Allocations in Hot Path**: Display list pre-allocates with `Vec`
3. **Viewport Culling**: Can significantly reduce work for large documents
4. **Optimization Pass**: Optional post-processing to remove no-ops

## Future Improvements

1. **Full Style Integration**: Access ComputedStyle for backgrounds/borders
2. **Stacking Context Sorting**: Handle z-index properly (W5.T03)
3. **Layer Compositing**: Identify layers for GPU acceleration
4. **Display List Caching**: Cache parts between frames for animations
5. **Gradient Support**: DrawGradient command
6. **Box Shadow Support**: DrawBoxShadow command
7. **Border Radius**: Rounded corners in DrawBorder/DrawRect

## Files Created/Modified

- Created `src/paint/display_list_builder.rs` (~700 lines including tests)
- Modified `src/paint/mod.rs` - Added module export and re-exports
