# Task W3.T16 Output Notes: Font Metrics Extraction

## Implementation Summary

Font metrics extraction is implemented in `src/text/font_db.rs` as part of the comprehensive font system that also handles font loading and database management.

The implementation provides:

1. **FontMetrics struct** - Font dimensional data in design units (ascent, descent, line_gap, line_height, x-height, cap-height, underline/strikeout metrics, and style flags)

2. **ScaledMetrics struct** - Pixel-scaled metrics for a specific font size, with descent converted to positive for easier layout calculations

3. **Extraction methods**:
   - `FontMetrics::from_font(&LoadedFont)` - Extract from loaded font
   - `FontMetrics::from_data(&[u8], u32)` - Extract from raw font data
   - `FontMetrics::from_face(&ttf_parser::Face)` - Extract from parsed face
   - `LoadedFont::metrics()` - Convenience method on loaded fonts

The implementation uses ttf-parser 0.25 API, extracting data from the hhea, OS/2, and post font tables.

## API Contracts

### Core Types

```rust
/// Font metrics in font design units
pub struct FontMetrics {
    pub units_per_em: u16,           // Design resolution (typically 1000 or 2048)
    pub ascent: i16,                 // Max height above baseline (positive)
    pub descent: i16,                // Max depth below baseline (negative)
    pub line_gap: i16,               // Extra line spacing
    pub line_height: i16,            // Calculated: ascent - descent + line_gap
    pub x_height: Option<i16>,       // Height of lowercase 'x'
    pub cap_height: Option<i16>,     // Height of uppercase letters
    pub underline_position: i16,     // Underline position (negative = below)
    pub underline_thickness: i16,    // Underline stroke width
    pub strikeout_position: Option<i16>,
    pub strikeout_thickness: Option<i16>,
    pub is_bold: bool,
    pub is_italic: bool,
    pub is_monospace: bool,
}

/// Scaled font metrics in pixels
pub struct ScaledMetrics {
    pub font_size: f32,              // Font size used for scaling
    pub scale: f32,                  // Scale factor (font_size / units_per_em)
    pub ascent: f32,                 // Ascent in pixels (positive)
    pub descent: f32,                // Descent in pixels (positive - converted)
    pub line_gap: f32,               // Line gap in pixels
    pub line_height: f32,            // Total line height in pixels
    pub x_height: Option<f32>,       // x-height in pixels
    pub cap_height: Option<f32>,     // cap-height in pixels
    pub underline_position: f32,     // Underline position in pixels
    pub underline_thickness: f32,    // Underline thickness in pixels
}
```

### Key Methods

```rust
// Extraction from loaded font
FontMetrics::from_font(font: &LoadedFont) -> Result<Self>
FontMetrics::from_data(data: &[u8], index: u32) -> Result<Self>
FontMetrics::from_face(face: &ttf_parser::Face) -> Result<Self>

// Scaling to pixel size
FontMetrics::scale(&self, font_size: f32) -> ScaledMetrics
FontMetrics::normal_line_height(&self, font_size: f32) -> f32

// ScaledMetrics helpers
ScaledMetrics::baseline_offset(&self) -> f32  // = ascent
ScaledMetrics::total_height(&self) -> f32  // = ascent + descent
ScaledMetrics::with_line_height_factor(&self, factor: f32) -> Self
ScaledMetrics::with_line_height(&self, line_height: f32) -> Self
```

## Decisions Made

### Decision 1: Descent Sign Convention
**Choice:** Raw FontMetrics keeps descent negative (as in font), ScaledMetrics converts to positive
**Rationale:** Font files store descent as negative, but layout code is cleaner with positive descent.

### Decision 2: Line Height Pre-calculation
**Choice:** FontMetrics stores pre-calculated `line_height` field
**Rationale:** Line height (ascent - descent + line_gap) is frequently needed, so compute once.

### Decision 3: Fallback Values for Missing Underline Metrics
**Choice:**
- underline position fallback: -10% of units_per_em
- underline thickness fallback: 5% of units_per_em

**Rationale:** Industry-standard approximations when font lacks post table.

## Spec Interpretations

### CSS Line Height
The CSS spec's "normal" line-height is implemented as:
```
line_height = ascent - descent + line_gap  (in font units)
```
This matches CSS 2.1 Section 10.8.1.

## Discoveries & Gotchas

### Gotcha 1: ttf-parser API
The ttf-parser 0.25 API uses `underline_metrics()` and `strikeout_metrics()` which return `LineMetrics` structs with `position` and `thickness` fields.

### Gotcha 2: OS/2 Table Version
`x_height()` and `capital_height()` return `None` for fonts with OS/2 table version < 2.

### Gotcha 3: Descent Sign
In raw font data, descent is negative (e.g., -200). In ScaledMetrics, it's positive.

## Test Coverage

**30 tests in tests/font_metrics_test.rs covering:**
- FontDatabase creation and queries
- Font fallback chains
- Metrics extraction from loaded fonts
- Scaling to different font sizes
- Baseline offset and total height
- Line height with factors and absolute values
- Font caching and cache clearing
- FontContext operations
- FontWeight and FontStyle defaults
- ttf-parser Face direct access

## Files Modified/Created

1. `src/text/font_db.rs` - FontMetrics and ScaledMetrics implementation
2. `src/text/font_loader.rs` - FontContext with metrics access
3. `src/text/mod.rs` - Module exports
4. `tests/font_metrics_test.rs` - Comprehensive tests (30 tests)
5. `outputs/notes/W3.T16-notes.md` - This file

## Verification Results

```
✅ cargo build - SUCCESS
✅ cargo test --test font_metrics_test - 30/30 tests passed
✅ cargo clippy -- -D warnings - No warnings
✅ cargo fmt --check - Properly formatted
```

---

**Task:** W3.T16 - Implement Font Metrics Extraction
**Status:** ✅ COMPLETE
**Last Updated:** 2025-11-23
