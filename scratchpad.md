# Scratchpad – rendering engine session notes

## Context
- Project: Rust HTML/CSS renderer (`fastrender`); current harness: danger-full-access FS, network enabled, approval policy `never`.
- Taffy is vendored in `vendor/taffy/` and must not be updated via Cargo.
- Goal: make the renderer spec-faithful (tables, text shaping, painting) and remove site-specific hacks.

## Recent changes (this branch)
- Row group heights act as minimums: `height`/`min-height` on row groups distribute extra height to member rows with cap-aware weighting (respecting row max-heights), percent heights resolve against a definite table height; added regressions for fixed and percent row-group minimums.
- Spanning cell minimum distribution now prefers available headroom: min-width growth weights by each column’s remaining max - min before falling back to current widths, so wide-headroom columns absorb more of a spanning cell and totals stay within the requested max (regression `distribute_spanning_prefers_existing_headroom`).
- Spanning cell maximum distribution now prefers available headroom before pushing past existing maxima: extra max-width is first absorbed by columns with spare max - min, then falls back to width weighting to reach the requested span max (regression `distribute_spanning_max_uses_headroom_before_busting_caps`).
- Column percentages now honor a definite table width (specified or containing block): percent column hints feed into auto layout distribution instead of being ignored when width is auto but the containing width is known; spans and explicit column counts are respected during distribution and intrinsic sizing.
- Rowspans now distribute required height with headroom awareness: spanning cells subtract existing non-target row floors, then split the remaining height using a shared helper that prefers rows with available cap headroom and redistributes any capped overflow to uncapped rows. Layout-time distribution ignores current content heights when weighting auto rows so spanned content doesn’t all pile into rows that already have tall non-spanning cells (new regression `calculate_row_heights_respects_headroom_for_rowspans`).
- Definite table height expansion respects row max-heights: leftover height after percent/fixed rows is distributed with cap-aware weights so capped rows stop at their max and overflow shifts to uncapped rows. A new regression (`extra_table_height_respects_row_max_when_distributing`) locks the headroom-aware redistribution and ensures computed heights derive from the final metrics.
- Percent rows that over-commit a definite table height are shrunk headroom-first: reductions weight each percent row by available headroom (current height minus min cap) rather than naive proportional scaling, keeping rows above their min-height/min-percent caps while meeting the target height when headroom allows.
- Percentage column allocations no longer clamp to max-content or short-circuit when columns are empty: the auto distributor skips the early max-width return when percentages are present and doesn’t cap percentage widths to the column max, so percent cells with zero intrinsic width still consume their share of a definite table width (regression `percentage_columns_apply_with_definite_available_width`).
- Fixed-layout percentage columns aren’t scaled down when they exceed 100%: percent columns now take their full share of the table width even when they overrun the available space, allowing the table to expand; redundant total-width clamping in the fixed distributor was dropped and a regression locks the overflow case.
- Auto table layout now clamps the final table width to authored min/max constraints even when `width: auto`, so min-width can expand and max-width can cap the border box; regressions cover both limits.
- Table min/max width is applied before column distribution when width is auto: the content box is expanded/clamped up front so column calculations use the same final content width as the fragment, eliminating mismatches between column sums and table bounds.
- Captions now contribute to table width: caption intrinsic/min widths expand the available table content during layout and intrinsic sizing, so wide captions don’t overflow; new regressions cover layout width expansion and intrinsic min-width.
- Caption-driven expansion respects table max-width: caption width requirements are clamped by the table’s max constraint, so oversized captions can’t force the table beyond its maximum; regression added.
- Caption sizing uses caption max-content: caption width budgeting now uses max-content rather than min-content when expanding tables and still clamps against table max-width to avoid overflow.
- Row-spanning baseline alignment prefers to keep below-baseline content in later rows before charging the first row; the baseline for spanning cells is computed from the cell height (not the current row share) so baseline cells no longer collapse when the first-row share is tiny. Added unit coverage for the baseline split helper.
- Percent row heights now resolve against any definite table height (including containing block height when the table’s height is auto); percentage rows honor the available height while auto rows share the remainder. Added regression `percent_rows_use_available_height_when_table_auto`.
- Percent rows that over-commit the available height are scaled down proportionally (respecting min-heights) instead of overflowing; new regression `percent_rows_scale_down_when_over_budget` covers the shrink path.
- Spanning cell width distribution now respects fixed columns: min/max growth prefers flexible, then percentage columns, and fixed columns stay locked when spans demand extra width (regression `distribute_spanning_respects_fixed_columns`).
- Spanning distributions weight by existing column sizes: min-width allocation across spans uses current column widths as weights, and spanning percentages split proportionally to column minima rather than evenly; regressions `distribute_spanning_weights_minimums_by_current_widths` and `distribute_spanning_percentage_weights_by_widths` cover the proportional splits.
- Row-group height caps participate in table height fill: when a definite table height leaves extra space, distribution now respects row-group max-heights (plus per-row caps), and leftover flows to uncapped groups. Regression `row_group_max_caps_extra_table_height` locks cap honoring.
- Percent height bases for rows and row-groups now consistently require a definite table height; percentage rows collapse when the table height is auto. The legacy extra-space distributor was removed in favor of group-aware expansion.
- Table row order now follows CSS: header groups (`<thead>`) are ordered before body groups/loose rows, and footers (`<tfoot>`) are forced to the end; row source indices remain DOM-based for styling while layout order follows the spec. Percentage row heights no longer resolve when the table height is auto (rows collapse instead of consuming the available block height), realigning with CSS2.1 expectations.
- Row reordering handles multiple headers/footers and loose rows: new regression asserts headers stay first and footers last while preserving DOM order in the grid mapping, and the redundant row index map allocation in TableStructure was removed.
- Row `height` now acts as a minimum even without a definite table height, and new regression `row_groups_reordered_header_body_footer` confirms header/body/footer ordering in layout output.
- Row-group ordering bookkeeping simplified: header/body/footer row indices are tracked directly while preserving DOM-based source indices for styling; grid mapping uses the reordered indices.
- Table intrinsic sizing now honors column hints even without rows: fixed/percent column widths feed min/max constraints, spans expand intrinsic width, and new regressions cover empty tables with column hints and span-driven intrinsic width expansion.
- Column and column-group spans now expand table column counts: `span` attributes on `<col>`/`<colgroup>` inflate `column_count`, grow ColumnInfo vector, and propagate widths/visibility across each spanned column even when no rows exist. Added regressions for colgroup children, empty colgroups, and col span expansion.
- Table structure now accounts for explicit columns: `TableStructure::from_box_tree` sets column_count to the max of inferred grid columns and `<col>/<colgroup>` declarations (including empty colgroups), extending column info when colgroups add more columns than rows imply. Added regressions to ensure explicit columns expand the count even with fewer cells or with empty colgroups.
- text-align-last now feeds per-line alignment: the line fragment builder applies the resolved line alignment (including text-align-last) and respects text-justify when deciding to expand gaps. The last-line justify path now honors `text-justify: none` and a regression locks the non-justified last line.
- Table fixup now counts colspan when inferring column count: column inference sums `debug_info.colspan` for cells so first-row colspans expand the inferred grid width instead of assuming 1 per cell. Added a regression to lock column counting with a spanning cell.
- Box shadows now rasterize with a true gaussian blur: outset shadows expand rect+radii by spread, render into a padded offscreen, blur via `apply_gaussian_blur`, and composite without clipping; inset shadows shrink the inner rect by spread/offset, blur, clip to the box to keep the shadow inside, and draw back at the element origin. Legacy multi-layer blur helpers remain gated with `allow(dead_code)` for now.
- CSS `border-image` implemented: styles hold source/slice/width/outset/repeat, longhands/shorthand parse, painter nine-slices images (URL only) honoring repeat/round/space, border widths, and outsets; device scale respected. Fixed painting bug where border tiles were drawn at the origin (edges overwriting corners) by using absolute device coordinates for each patch. Added a regression covering nine-slice painting.
  - Space repeat now follows the spec: tiles are counted to avoid clipping and the leftover space is distributed between tiles (centered when only one fits). New regression checks both axes for gaps.
  - Border images now accept gradients: linear/radial/conic and repeating variants are rasterized into a generated image sized to the border area before slicing. Added a regression to ensure gradient sources paint and the border interior stays empty when fill is false.
- Background gradients now honor `background-size`/`background-repeat`: gradients are rasterized to the computed tile size and tiled like images (including round/space handling), so sized gradients repeat instead of always stretching to the painting area. Regression ensures a sized linear gradient repeats horizontally.
- CSS global keywords now apply: `inherit`/`initial`/`unset`/`revert` are handled in `apply_declaration` across all supported properties using the parent or initial style as the source (revert follows initial until cascade layers are modeled). Logical properties carry over their logical values, backgrounds merge layer components, and apply_declaration takes the parent style explicitly for global resolution. Regression tests cover inheriting non-inherited `width`, `unset` on inherited `color`, `unset` resetting border styles, and `initial` clearing background color.
- `all` shorthand now honors only global keywords; it resets all properties (except `direction`/`unicode-bidi`) against the correct source: parent for inherit, UA defaults for initial/unset, and UA baseline for revert. Logical order bookkeeping is bumped so `all` overrides earlier logical mappings. Regressions cover initial reset while keeping direction, inherit copying display, and revert dropping inherited author colors.
- Cascade now computes a UA-only baseline per element (including pseudos/markers) and uses it as the revert source so `revert` drops author-origin values—even inherited ones—and falls back to UA defaults. New regressions cover `display: revert` restoring UA block display and inherited `color: revert` ignoring an author-set parent color. Pseudos reuse UA baselines and propagate root font size for property copies.
- CSS cascade layers implemented: @layer parsing (blockless, named, anonymous) records layer order, cascade sorting includes layer rank between origin and specificity, and `revert-layer` resets to the pre-layer snapshot while `all` respects layer baselines. Unlayered rules outrank layered ones. Regressions cover layer ordering, blockless prelude ordering, unlayered override, and `revert-layer` restoring earlier layer values.
- Added coverage for dotted layer names (nested paths) and nested revert-layer to ensure child layers override parent declarations and revert-layer snapshots use the nearest layer base.
- CSS `image-orientation` implemented (initial `from-image`, inherited): parses none/from-image/angle+flip with quarter-turn quantization, cascades via `all`, and resolves decorative images to `from-image` when angles are authored. ImageCache now records EXIF orientation (via `kamadak-exif`), exposes oriented RGBA buffers/dimensions, and intrinsic sizing + object-fit/background tiling use oriented sizes. Painter and display-list paths orient content/background/list images; `image-orientation:none` bypasses metadata. Added fixture `tests/fixtures/image_orientation/orientation-6.jpg` plus parsing/orientation/exif regressions.
- CSS `image-resolution` implemented (initial 1dppx, inherited): parses from-image/explicit resolutions/snap, resolves EXIF DPI to dppx, and uses the property in intrinsic sizing, background tiling, and object-fit. Raster images compute CSS sizes from resolution (vector images unaffected), display-list items carry natural CSS sizes, and snapping rounds to integer device-pixel mappings. Added parsing/snap regression and an intrinsic-size test that shrinks a 4×2 PNG to 2×1 when authoring 2dppx.
- Line-height keeps percentages distinct from numbers: parsing stores CSS percentages (unit_value × 100) into a dedicated `Percentage` variant, computed/inline line-height resolution handles the variant against font-size, and font shorthand parsing no longer converts percentages to numbers. Parsing now rejects negative values, normalizes percentage lengths, and accepts calc/min/max/clamp() line-height values (including in the font shorthand) while ignoring invalid negative calcs.
- Font-size now rejects negative values and accepts calc/min/max/clamp() lengths in both the longhand and font shorthand, resolving percentage calcs against the parent size and keeping invalid negative calcs from overriding the previous size.
- `font-style: oblique` enforces the spec angle range (-90deg..90deg) for both longhand and font shorthand; out-of-range angles invalidate the declaration, while valid angles are preserved.
- Computed font-style now retains oblique angles end-to-end (into positioned styles and font-relative length resolution) and variable fonts map CSS oblique/italic angles onto the `slnt` axis (default 14deg), clamped to the font’s axis range and skipped when authors set `font-variation-settings: 'slnt' ...`.
- Font axis mapping now prefers the correct variation axis: oblique maps to `slnt` (without toggling `ital`), italic uses `ital` when present and falls back to `slnt` when not, and synthetic slanting is suppressed whenever a font variation axis can provide the requested slant.
- Font slope matching now follows CSS fallbacks: oblique requests try oblique then italic then normal faces; italic requests try italic then oblique then normal, so slanted fonts are selected even when only one slope variant exists. A helper documents the slope preference order.
- FontContext’s get_font/get_font_full now apply the same slope fallback order, so callers that request italic/oblique still get a face when only an upright font exists; a regression covers the italic fallback using the embedded Roboto regular font.
- Font matching now falls back across font-stretch as per CSS closest-distance rules: queries order stretch variants by absolute difference (narrower wins ties) and combine with slope fallback in both font lookup and per-character fallback. A regression ensures an italic request with missing stretch still resolves using the embedded fallback font.
- Font matching now also falls back across weight: we order weights by distance to the requested value (bias toward heavier for ≥400, lighter for <400), and combine with slope/stretch searches for both per-character fallback and FontContext lookups. Added regression expecting bold-italic requests to resolve against the embedded normal-weight font.
- Minor cleanup: removed an unused weight variable in the FontContext weight-preference loop; `cargo test --all --locked` passing.
- Bidi reordering now respects paragraph boundaries: `BidiAnalysis` records paragraph byte ranges, shaped runs are reordered per paragraph instead of across the entire text, and regressions cover paragraph extraction and boundary-aware reordering (preventing runs from multiple paragraphs from swapping when they share the same level).
- Itemization now splits runs at bidi paragraph boundaries before font matching/shaping, so no run crosses a paragraph separator and per-paragraph reordering stays well-defined.
- `unicode-bidi: plaintext` now seeds the line builder’s base level from the paragraph’s first-strong direction (derived from the pending inline items) instead of defaulting to LTR, so paragraph base direction is honored during layout when plaintext is used.
- Plaintext paragraphs now propagate their resolved base direction into the inline items they layout: text/tab/inline-box children have their shaping base direction updated so shaping and bidi controls use the first-strong paragraph base rather than the authored `direction`. Added a regression to confirm item directions are rewritten when plaintext is active.
- Root unicode-bidi contexts now participate in bidi reordering: line builder carries the container’s unicode-bidi/direction and seeds the paragraph reorder with the appropriate embedding/isolate controls so outer isolates/overrides aren’t dropped for inline content.
- Inline item collection now threads a unicode-bidi/direction stack through inline text/item construction, including inline-box recursion; text item creation deduplicates the current context and receives the stack for future bidi-aware shaping. Tests still pass with the new plumbing.
- Inline text shaping now wraps content with ancestor unicode-bidi controls derived from the inline stack, runs bidi analysis/shaping with those wrappers, then strips the control spans from shaped runs while remapping clusters so advances/breaks stay aligned with the author text.
- Added a regression to ensure bidi wrappers are stripped post-shaping and clusters stay within authored text bounds.
- Bidi wrappers now respect the explicit depth limit when building control prefixes and recompute run advance after stripping while preserving glyph offsets so positions stay consistent with shaped kerning.
- Conic gradients parse/paint (including `from` angles and `at` positions) in both painter and display list; stop positions stay unclamped for correct repeating periods and the display-list renderer now samples relative to the target rect instead of the canvas origin.
- Inline layout now preserves block-level children instead of dropping them: mixed inline/block content is segmented into inline runs and block fragments laid out in flow order (with float-aware flushing), and inline segments restart first-line indentation around block intrusions.
- Block fragments inside inline layout now honor margins: vertical flow advances by margin-top/height/margin-bottom and horizontal extents include margins when computing max width; tests cover margin-induced spacing.
- Srcset selection treats non-positive slot widths as absent, falling back to viewport-driven width descriptor resolution so zero-width placeholders still pick the correct candidate (new regression in box_tree).
- DisplayListBuilder now defaults its viewport to the root fragment/stacking bounds, so viewport-relative lengths (e.g., object-position vw/vh) resolve correctly without manual configuration; the viewport-unit image positioning test now relies on the automatic viewport.
- Inline IFC float placement keeps floats on the current line: we no longer flush inline runs before placing an inline float, so a float encountered after text starts at the first line and immediately shortens available line space.
- DisplayListBuilder respects the fragment tree's viewport size when building from a FragmentTree; the object-position viewport-units test now wraps the fragment in a viewported FragmentTree to resolve vw correctly.
- `font-variant-emoji` now influences font selection: emoji-dominant runs honor `emoji` by preferring emoji fonts (including the emoji generic and system emoji faces) and honor `text` by avoiding emoji fonts; helper detection identifies emoji-dominant text and emoji fonts by family naming heuristics. Added unit coverage for emoji dominance detection and emoji font classification.
- Font fallback is now per-character: we walk the author/generic family list for each codepoint, split runs when font faces change, avoid emoji fonts when `font-variant-emoji: text`, inject the emoji generic when requested, and keep the earliest family match as a last-resort fallback instead of erroring when no glyph is found. Variation selectors and ZWJ now stay in the current run so emoji/text presentation selectors don't force a font swap, and emoji preference honors the authored variant (`emoji`, `text`, `unicode`, `normal`) per character.
- Bidi control codepoints inserted for unicode-bidi handling are stripped from shaped glyph output so they no longer contribute advance; shaping still uses them for ordering, but zero-width controls no longer risk synthetic glyph widths.
- Replaced image rendering now tries an ordered fallback list (selected srcset candidate, base src, remaining candidates, posters) in both painter and display list. If the preferred source fails to decode, we walk the list before falling back to alt text/placeholder, matching HTML’s permissive image fallback story.
- `font-variation-settings` parses/inherits, resets via the font shorthand, and propagates to shaping: font runs carry variation tuples into rustybuzz via `Face::set_variations`. A new RobotoFlex variable-font fixture exercises the `wdth` axis and asserts advances shrink/grow when variation settings change (`tests/fixtures/fonts/RobotoFlex-VF.ttf`).
- Automatic font axis mapping: variable fonts with `wght`/`wdth`/`opsz`/`ital` axes now pick up CSS `font-weight`/`font-stretch`/font size/font-style unless an authored `font-variation-settings` overrides that axis. Added regressions showing stretch-driven wdth variation and author overrides holding precedence.
- `font-optical-sizing` is parsed/inherited (default `auto`), reset by `font`, and gates opsz auto-mapping: opsz variations apply only when optical sizing is auto. A regression checks opsz is skipped when `font-optical-sizing: none`.
- `font-variation-settings` now inherits through cascade; regression covers parent → child propagation of authored axis tuples.
- `font-language-override` is parsed/inherited (normal | "<tag>"), not reset by `font`, and feeds HarfBuzz language tags for shaping. Cascade + shaping regressions cover inheritance and override application; font shorthand leaves feature/variation/language overrides intact per CSS Fonts 4 note.
- `font-synthesis` now includes position; longhands `font-synthesis-{weight,style,small-caps,position}` parsed, and shorthand covers position too. Shorthand no longer resets low-level controls; tests lock parsing of new keywords.
- `font-variant-emoji` parses/inherits (normal/emoji/text/unicode); property tests added. Behavior mapping to emoji fonts still TODO.
- Radial gradients now follow the CSS default ellipse/farthest-corner sizing: painter builds an elliptical shader via transforms, display-list items carry per-axis radii (instead of a single radius), the renderer applies the same transform-based ellipse, and regressions cover equalized edge colors plus corner reach.
- Radial gradients honor CSS shape/size/position syntax: parsing handles circle/ellipse, closest/farthest side/corner keywords, explicit radii (length/%), and `at <position>`; background images carry shape/size/position into painter/display-list geometry so centers, sizes, and corner touch match the spec. Added parse + paint regressions for size/position.
- FastRender now resolves `@import` during layout: `CssImportFetcher` fetches imports over HTTP(S) with a 30s timeout, reads `file://` imports (handling directory bases without trailing slashes), and decodes `data:` CSS with percent/base64 support and charset detection (UTF-8 preferred, Latin-1 fallback). `layout_document` always wires the loader into cascade, and API tests cover file-based imports via `base_url` and inline data-URL imports.
- Stylesheet fetching now honors CSS encoding rules: BOM > `@charset` > `Content-Type` charset > UTF-8. A new `css::encoding` module centralizes decoding, `fetch_and_render` fetches text using it (including file URLs), and import resolution uses it for data/file/http sources. Tests cover BOM, `@charset`, and content-type charsets.
- fetch_and_render fetches resources as bytes and decodes HTML via BOM/Content-Type charset (UTF-8 fallback) while decoding CSS through the CSS sniffer; HTTP headers are kept for charset detection and link/inlined CSS use the new decode paths. Added regression to ensure HTML decoding honors content-type charset.
- HTML fetch now sniffs `<meta charset>` and falls back to Windows-1252 when no BOM/header/meta is present (per HTML spec); BOM and Content-Type override meta. Charset detection is confined to the first 4KB, ignoring comments. Regression added for HTML charset in Content-Type.
- Added HTML charset regression coverage for meta-declared encodings and the Windows-1252 default (pound sign decoding) to lock the sniffing order.
- Block intrinsic inline width calculation now clamps against resolved min/max width for the border box, so shrink-to-fit respects authored constraints during intrinsic measurement.
- Added regressions to ensure block intrinsic width computations obey min/max constraints (`tests/layout/test_factory.rs`).
- Logical box properties now resolve per writing-mode/direction: margin/padding/border inline/block/start/end shorthands defer until the final writing mode is known, respecting cascade order against physical sides. Added regression coverage for inline directionality, vertical writing modes, and cascade precedence (`tests/style/logical_properties_test.rs`).
- Logical sizing/inset properties now map to physical axes with cascade-aware ordering: inline/block sizes (and min/max variants) route to width/height based on writing-mode, and inset logical shorthands map to the correct physical sides honoring later physical overrides. Additional regressions cover inline-size in vertical writing modes and logical inset mapping (`tests/style/logical_properties_test.rs`).
- Logical border radii are supported (`border-start/end-*-radius`), mapped through writing-mode/direction to physical corners with cascade-aware ordering. Physical radius properties now share the same ordering machinery, and regressions cover RTL and vertical-rl corner mapping (`tests/style/logical_properties_test.rs`).
- `<object>` without a `data` attribute now renders its fallback children instead of producing a replaced box; regression ensures the fallback text is present and no object replacement is emitted (`src/tree/box_generation.rs`).
- Audio elements are treated as replaced elements: added `ReplacedType::Audio`, box generation recognizes `<audio>`, and a default intrinsic size of 300×32px is applied with regression coverage (`src/tree/box_generation.rs`).
- Inline `<svg>` content is serialized into the replaced box so resvg can render the authored markup; regression asserts the serialized content includes child elements (`src/tree/box_generation.rs`).
- ImageCache URL resolution now delegates to the `url` crate so relative paths (including `..`, `./`, protocol-relative sources, and file:// directory bases without trailing slashes) resolve per RFC 3986 rather than string concatenation.
- `fetch_and_render` now resolves `<link rel="stylesheet">` hrefs with the `url` crate (including protocol-relative, root-relative, relative, and file:// bases) instead of ad-hoc string concatenation; regression tests cover the resolution paths.
- `fetch_and_render` also rewrites `url(...)` references inside fetched stylesheets against the stylesheet’s own base URL so inlined CSS retains correct resource bases (backgrounds/fonts); added regression for url() absolutization.
- `fetch_and_render` now inlines `@import` rules (recursively), fetching imported stylesheets, absolutizing their urls against their own base, and wrapping in @media when media queries are present; includes regression for media-wrapped import inlining.
- Import inlining replaces the original @import rules instead of duplicating them, and loops are avoided by tracking visited import URLs per fetch run.
- CSS cascade now evaluates media queries against the actual viewport requested by `layout_document`/`render_html` (MediaContext built from the passed width/height instead of a fixed desktop size), so responsive rules track the real render target.
- FastRender keeps the configured default viewport and `render()` uses those dimensions (not a baked-in 800×600); new API tests cover viewport-aware media queries and default-render sizing.
- Image-set selection is now device-pixel-ratio aware: cascade sets the current DPR from the media context, `FastRender` exposes/configures DPR, and `image-set()` chooses the best candidate for that DPR across backgrounds, list-style images, cursors, etc. Added property/cascade/regression tests plus a builder test for DPR plumbing.
- HTML `<img srcset>` is parsed into density candidates, stored on `ReplacedType::Image`, and both painter and display-list selection choose the best source for the current device pixel ratio (builder carries `device_pixel_ratio` with setters). Regression covers DPR=2 picking the 2x candidate from data URLs.
- Srcset now understands width descriptors and the `sizes` attribute: candidates store density or width, selection uses device pixel ratio plus either the fragment width or the evaluated sizes list (defaulting to the last sizes entry, falling back to the viewport width when width descriptors are present and no sizes/slot). Sizes lengths parse full CSS lengths (including calc/min/max/clamp), intrinsic loading chooses sources using viewport/sizes, and painter/display-list builder thread viewport + font size into selection. Regressions cover width-descriptor selection via sizes, last-entry fallback, and viewport fallback when sizes are omitted.
- Painting now happens directly at device scale: the painter allocates a DPR-scaled canvas, scales all geometry/lengths (backgrounds, borders, text, filters/shadows, replaced content), and composites stacking contexts in device coordinates instead of post-upscaling. API regression covers integer DPR output sizing and a new fractional (1.5) DPR case.
- Display list regression added for video replaced elements: builder now covered by a test that writes a temporary PNG poster and asserts the display list uses it for `ReplacedType::Video`, cleaning up the temp file afterward.
- Collapsed-border conflict resolution now follows CSS 2.1 ordering: style priority wins before width, then origin, then later source order; tie-breaks no longer depend on cell position/direction. Updated regressions reflect style-over-width and source-order ties.
- `empty-cells` only hides borders/backgrounds in the separate border model; collapsed borders always participate in conflict resolution even for visually empty cells, so `empty-cells: hide` no longer strips collapsed borders. Layout still strips borders for the separate model.
- Percentage column/cell widths now honor any definite table width (specified or available); they’re ignored only when the table width is indefinite. Regression now checks an 80/20 split when the containing block width is known.
- FormattingContextFactory now carries the nearest positioned containing block and threads it into block/inline/flex/grid contexts; flex and newly updated grid contexts lay out out-of-flow abs/fixed children against the inherited containing block when the container itself isn’t positioned, and new regressions cover ancestor CB fallback for both flex and grid.
- Table formatting context now inherits the nearest positioned containing block and positions out-of-flow abs/fixed children accordingly; positioned tables use their padding box as the CB, and empty tables still lay out positioned descendants. Added a regression for CB inheritance through table layout.
- Inline formatting context now drops out-of-flow abs/fixed children from line building and places them after layout against the inherited containing block (or the inline’s padding box when positioned), matching block/flex/grid behavior.
- Inline static positions for abs/fixed descendants now seed from the first line box (including indent/alignment, RTL starts, rotation for vertical writing modes, and baseline offsets) instead of the containing block origin, so positioned inlines default to their natural text start. When no lines exist on a positioned inline, static positions fall back to the inline content start (inline axis) with block-axis padding applied. Added regressions for indented LTR and RTL right-aligned cases plus the empty-inline fallback.
- Absolute/fixed fragments now use the absolute-positioning solver’s coordinates directly; block and flex callers stopped reapplying the containing-block origin, fixing over-shifted abs/fixed children (e.g., flex padding containing blocks). Added a flex regression for padding-box positioning.
- Relative positioning now applies after block placement so offsets move fragments without inflating layout metrics; percentage offsets resolve against the parent’s containing block. Absolute/fixed containing blocks in block layout now honor the nearest positioned ancestor (padding box) or the viewport instead of always using the immediate parent, absolute children translate back into the parent coordinate space, out-of-flow candidates carry their CB source through absolute layout, and static positions for abs/fixed defaults are derived from the hypothetical in-flow position using block width resolution (auto margins). Added regressions for px/percentage relative offsets.
- Stacking contexts with filters in the display-list renderer now expand by filter outsets but defer masking to the original border box, keeping blur/drop-shadow visible while rounding is applied only on composite.
- Stacking context filter masking now aligns to the element’s original bounds in both painter and display-list paths: filter layers expand by outsets, but radii/clips are applied at the original border box so rounded corners mask correctly without clipping the blur region. Added regression that blur spills outside the context bounds.
- Backdrop filters in the display-list renderer now expand by filter outsets so blur/drop-shadow samples include pixels outside the element bounds; masked copy-back ensures the effect remains clipped to the element. Added a regression for blur sampling outside the filtered region.
- CSS `image-set()` is parsed for background images; candidates with dppx/dpi/dpcm/`x` density descriptors are parsed and the best match for 1.0dppx is selected (smallest ≥1, else largest <1). Regression tests cover 1x preference, dpi conversion, and sub-1x fallback.
- `image-set()` is now accepted for `list-style-image`, selecting the best candidate and resolving to a URL just like other image properties; regression added for 1x selection.
- Background shorthand now recognizes `image-set()` so `background: image-set(...) no-repeat` selects the best candidate and carries the repeat; regression added for shorthand parsing.
- `content: image-set(...)` now parses and selects the best-density URL for generated content, so image-set works for generated replaced content (pseudos, markers). Regression added to ensure the 1x candidate is chosen.
- Cursor property now parses keywords and custom cursor images (including `image-set(...)` and hotspots), storing image fallbacks and the final cursor keyword; regressions cover keyword parsing, url+hotspot+fallback, and image-set selection.
- Cursor inherits: cascade copies cursor keyword and image list from parents so unset descendants inherit as per spec; added regression for inherit/override.
- Cursor parser accepts comma-separated fallbacks per CSS syntax, allowing multiple images and a final keyword; tests updated to include comma separators.
- Blend-mode regressions now check HSL component preservation (hue/saturation/luminance) instead of exact RGB matches to allow for tiny-skia rounding while still enforcing the CSS compositing semantics.
- `will-change` parses into computed styles (non-inherited); stacking context detection treats hints that would form stacking contexts (transform/opacity/filter/backdrop/mix-blend/etc.) as SC creators. Added cascade + stacking context regression coverage.
- Display-list renderer now captures `PushBlendMode` into layers and manually composites Hue/Saturation/Color/Luminosity modes via HSL component blending so the advanced blend modes preserve the expected hue/saturation/luminance components (regressions cover the HSL blend expectations).
- Painter mix-blend/background-blend Hue/Saturation/Color/Luminosity now composite via manual HSL blending for stacking contexts and background layers to mirror the display-list behavior; painter regressions cover hue mix-blend and color background-blend.
- Computed/positioned stacking-context detection now mirrors the paint logic: transform/filter/backdrop/mix-blend/isolation/will-change and positioned overflow clipping all trigger stacking contexts in both computed helpers and positioned layout tests.
- CSS `contain` now parses (`none|strict|content|layout|paint|style|size|inline-size` combos), stores containment flags, and paint stacking contexts are created when paint containment is present; property and stacking tests cover parsing and SC creation.
- Size/inline-size/layout containment now establishes BFCs (blocking margin collapse/float leakage) and zeroes intrinsic inline contributions; size containment also prevents child height from inflating auto heights. Added regression for intrinsic sizing.
- Flow-root/inline flex/inline grid now explicitly establish BFCs so margins don’t collapse through them and floats stay contained; coverage added in margin collapse tests.
- Absolutely positioned children now get laid out after normal flow: we build their fragments, resolve positioned styles from computed values against the parent padding box, and run the absolute positioning solver so they appear within their containing block; regression covers padding-box offsets.
- Paint containment now clips stacking contexts: painter treats contain: paint like overflow clip, and the display-list builder wraps paint-contained contexts in a padding-box clip (with radii) so renderers keep painting inside the element bounds; regression covers the emitted PushClip/PopClip.
- Image cache resolves relative URLs against the configured base URL; added a regression that loads a file:// PNG via base URL resolution.
- Display-list builder exposes a base-URL setter and now resolves background image URLs against the configured base; regression covers loading a relative PNG through the base URL.
- Added HSL reference helpers and blend-mode regressions (hue/saturation/color/luminosity) in the display-list renderer to ensure advanced blend modes follow the CSS compositing definitions.
- Canvas blend mode conversion now maps Hue/Saturation/Color/Luminosity to tiny-skia equivalents so PushBlendMode honors the full CSS set; regression asserts `color` blend preserves destination luminance while keeping source hue.
- `unicode-bidi: plaintext` no longer forces the entire paragraph to first-strong when only inline isolates are present; bidi reordering keeps the paragraph base direction while FSI/PDI isolates handle inline plaintext content. Added a regression for inline plaintext followed by LTR text.
- Var() resolution is property-aware: the resolver now parses substituted values using the destination property grammar (e.g., background layers keep commas/gradients) instead of a generic parser that flattened complex values.
- Invalid var() references now drop declarations per spec: `resolve_var_for_property` reports unresolved/not-found/recursion cases and `apply_declaration` ignores the declaration when a var() can’t be resolved, preventing bogus values from entering computed styles.
- Custom properties now store raw token strings (`PropertyValue::Custom`) rather than lossy parsed forms; declaration handling preserves authored text for `--*` values so cascading variables retain exact input for later substitution.
- Declaration fixtures now carry the new `raw_value` field so custom-property text survives through parsing/cascade; parser populates `raw_value` for authored values and the suite compiles (`cargo test` green).
- Color parsing now follows modern CSS color syntax: unified parser handles space/comma rgb()/hsl() with slash alpha and hue angles, adds hwb(), clamps channels, fixes the `green` keyword (#008000), and all color properties funnel through the shared parser while preserving `currentColor` keywords.
- Gradients now reuse the shared color parser (space/slash rgb/hsl, hwb, currentColor), keep color stops as `Color` values, and resolve `currentColor` against the element color at paint/display-list time; border/background colors also honor `currentColor` instead of dropping the declaration.
- `color-mix()` is parsed for srgb/srgb-linear spaces, stored as a deferred `Color::Mix`, and resolved at paint time with linear-light mixing (using currentColor when present); weights default to even splits and normalize percentages.
- Lab/LCH and Oklab/Oklch are parsed and converted to sRGB with proper D50↔D65 adaptation; color-mix now accepts lab/lch/oklab/oklch spaces and mixes in the appropriate space (hue-aware for polar spaces).
- CSS `color()` function parses srgb, srgb-linear, and display-p3; channels accept numbers/percent with slash alpha, converting through the correct color space (display-p3 mapped to sRGB for rendering).
- `color()` now accepts lab/lch/oklab/oklch spaces as well, parsing hue dimensions/percentages, preserving channel percentages, and converting through Lab/Oklab (with D50↔D65 adaptation) to sRGB; channel parsing now handles hue dimensions in polar spaces and rejects trailing tokens.
- `color()` now covers a98-rgb, prophoto-rgb, rec2020, and xyz-d50/xyz-d65 spaces: channels decode with the correct transfer functions, matrices convert through the right white points (D50 adapted to D65), and outputs map to sRGB with clamping at the end. Basic regressions guard neutral greys and white points.
- Background tokenization is comma-safe: layer splitting now respects parentheses/brackets/braces and quoted strings, so `color-mix()`/calc commas inside backgrounds or gradients no longer split layers. Added a regression ensuring layered backgrounds with nested commas parse correctly.
- Background layers now have painter regressions for spec order/clip: layers are validated to paint top-to-bottom (first layer on top) and to honor per-layer clips (content-clipped tops leave padding to lower layers), ensuring painting matches the CSS Backgrounds spec.
- Display-list builder mirrors the painter’s background semantics: new display-list regressions assert layers emit in bottom→top order (first layer last item) and per-layer `background-clip` yields correct rects (content vs border box) so the display-list renderer paints backgrounds like the painter.
- Display-list renderer now maps the full CSS blend-mode set (Hue/Saturation/Color/Luminosity) to tiny-skia blend modes instead of falling back to normal, aligning compositing with painter behavior.
- CSS lengths accept all units case-insensitively across manual and cssparser-driven paths (px/pt/pc/in/cm/mm/q/em/rem/ex/ch/vw/vh/vmin/vmax/%), and `calc()` is parsed/evaluated when units are compatible (sums/products collapse to concrete Length/Percentage). Percentage tokens now normalize to 0–100 values for cssparser-based parsing. Var() calc resolution now returns computed Lengths.
- Length parsing now accepts all standard units (px/pt/pc/in/cm/mm/q/em/rem/ex/ch/vw/vh/vmin/vmax/%) case-insensitively across both string- and cssparser-based paths, with regressions covering the units.
- `calc()/min()/max()/clamp()` now parse/evaluate when units are compatible (including percentages), producing concrete lengths/percentages during value parsing and cssparser-backed longhand parsing; percentage tokens normalize to 0–100 from cssparser.
- CSS `background-blend-mode` now parses as a per-layer list, repeats/truncates alongside background images, and flows into `BackgroundLayer` so both painter and display-list paths honor per-layer blend modes (push/pop blend around backgrounds). Added regressions for layer repetition, painter multiply compositing, and display-list blend emission.
- Table cells no longer default to `white-space: nowrap`; UA defaults keep cells wrapping unless styles request nowrap. Presentational `align`/`valign` hints now map to text-align/vertical-align at low specificity.
- Added `background-position-x`/`background-position-y` longhands: parsed as per-layer lists, merged with existing positions, and repeated/truncated to match layer counts. Grammar follows the axis-specific keywords/lengths/percentages, with regressions covering vertical-first keyword orders and longhand combinations.
- Two-value `background-position` now follows spec disambiguation: “center left” maps to left/center, “center bottom” centers horizontally and aligns vertically, and mixed keyword orders honor their axes. New regressions lock the swapped-axis cases.
- Background-position parsing now matches the full 1–4 value grammar: two-value forms always map horizontal then vertical (even when the second is a length/percentage), swapped keyword orders (e.g. `top left`) resolve to their axes, and 3/4-value pairs attach offsets to the correct axis (including vertical-first pairs). Added regressions covering vertical-first and offset pairs.
- `text-decoration-skip-ink` now distinguishes `all` from `auto`: the underline segment builder always carves out glyph intervals when `all` is authored (even if the underline band sits away from ink), while `auto` keeps a continuous line when there’s nothing to skip. Tests updated to lock the behavior.
- Display list now emits text decoration items and the display-list renderer paints underline/overline/line-through (solid/double/dotted/dashed/wavy) with skip-ink carve-outs in line with the painter, so decorations render in both rasterization paths. Added a regression covering decoration emission and rendering.
- Display-list text decoration gaps are now explicitly tested: decoration items with segmented underlines leave gaps unpainted while rendering spans, ensuring skip-ink segment carving persists in the display-list renderer.
- Default `content_value` now starts at `normal`, and marker/pseudo generation synthesizes structured content from the legacy `style.content` string when `content_value` is unset, so authored `content` on ::marker works even in hand-built styles while preserving the structured ContentValue pipeline.
- Pseudo-element content now uses structured ContentValue: styles parse `content`, inherit `quotes`, and box generation resolves attr()/counter()/counters()/quotes plus url images using CounterManager snapshots and element attributes. Pseudo boxes skip when content is none/normal, emit text and replaced children, and respect authored `quotes` pairs (`quotes` property now parsed, defaults initialized, and quote list inherits).
- Parsed `content` into structured `ContentValue` and generate pseudo-element text through the content generator with counter snapshots, element attributes, and authored quotes. Added `quotes` property support (auto/none/pairs), per-style quote inheritance, and ensured open-quote/close-quote follow authored pairs. Pseudo content now skips when empty instead of relying on raw strings.
- Added additive counter styles for Armenian (upper + lower) and Georgian: `list-style-type`/`counter()` parsing accepts the new keywords, markers format using the additive alphabets with decimal fallback outside the allowed ranges, and tests cover formatting/markers. Updated the over-100% percentage column regression to expect normalized percentages rather than overflowing widths.
- Counter formatting matches CSS fallbacks: roman counters now fall back to decimal outside the defined range (≤0 or >3999) and decimal-leading-zero preserves the sign while padding the absolute value, so negative counters render as `-01`/`-09` instead of dropping the leading zero.
- Ordered lists now honor HTML `start` and `reversed`: default counter-reset derives from the start attribute or the list’s own item count, reversed lists set the default increment to -1, and nested list items are excluded from the parent’s count so markers enumerate 5/6/7 or 3/2/1 as per spec. Tests cover start, reversed, and nested reversed defaults.
- Ordered list defaults are now spec-correct (start at 1), the HTML `value` attribute on `<li>` sets the list-item counter for that entry (forward and reversed), and `type` presentation hints map to `list-style-type` with proper cascade/override behavior.
- Presentational hints now cover legacy `align`/`valign` attributes on table content: `align` on table/tr/td/th maps to `text-align`, and `valign` on tr/td/th maps to `vertical-align`, at low specificity and overridable by CSS. Added regressions for mapping and author override.
- Selector parsing now uses cssparser’s full An+B micro-syntax and supports :nth-of-type/:nth-last-of-type plus :first/last/only-of-type and :empty. DOM matching filters siblings by type, honors :empty only when no element/text children are present (whitespace text now prevents :empty), and new unit tests cover nth parsing and pseudo-class matching.
- Added :lang() pseudo support: parser accepts language ranges (comma-separated), ToCss serializes lists, and DOM matching inherits lang/xml:lang down the ancestor chain with prefix + wildcard matching. Tests cover inheritance, prefix matches, and list disjunction.
- Added :dir() and :any-link pseudos: :dir() parses ltr/rtl and matches inherited dir/xml:dir attributes (defaulting to ltr, ignores auto); :any-link matches anchors with href like :link. Tests cover direction inheritance and any-link behavior.
- Link-state detection now treats <a>, <area>, and <link> elements with href as links for :link/:any-link matching; tests cover non-anchor linkables.
- :target support: selector parsing/ToCss includes :target, DOM matching consults a thread-local target fragment (stripped of '#'), matches id or anchor name, and API derives the fragment from the configured base_url (preserved on FastRender). apply_styles gains a target-aware entry point; layout uses it so page fragments can highlight targets.
- :scope pseudo added: parsing/serialization covers :scope and matching treats the document root as scope (ancestor-less ElementRef). Tests assert only the root matches.
- dir attribute now acts as a presentational hint: dir=rtl/ltr injects direction plus unicode-bidi: isolate as a low-specificity author rule, so bidi base direction follows the HTML attribute while remaining overridable by CSS or inline styles.
- :dir() matching now honors dir=auto: selector direction resolution walks subtree for the first strong character (skipping script/style) so :dir(rtl/ltr) reflects the HTML dir=auto heuristic; inherited dir=auto also resolves to its computed direction.
- Cascade honors !important and origin ordering: rules are tagged with their origin (UA vs. author/inline), declarations flatten into a shared cascade that sorts by importance → origin → specificity → source order, and inline styles get an inline specificity boost. Added regressions covering important vs. normal, author important beating inline normal, and inline important outranking author important.
- Rowspan height distribution now follows CSS 2.1 intent: extra height from a spanning cell distributes proportionally to the spanned rows’ existing heights (or equally if none), rather than a flat split, so larger rows absorb more of the span. Regression added for the proportional split.
- Auto-row height allocation now respects fixed/percent rows before sharing leftover space: specified rows contribute their authored sizes to the fixed budget and span-driven growth falls back to equal weights when targeted rows have zero baseline, so auto rows receive the remaining height instead of being diluted by zero minima.
- Column percentage widths now normalize to the available content box: fixed widths are applied first, percentage targets scale down when they overrun the post-fixed budget (respecting min/max), and fixed-layout percentages no longer clamp to zero because their max widths aren’t capped. Added coverage for over-100% spans and fixed-layout first-row sizing.
- Rowspanning cells now share their height across the spanned rows even when the total is already satisfied: intrinsic sizing keeps proportional splits, while the full layout path allocates the span remainder across auto rows (equal shares) so later rows don’t collapse under tall first-row content. Tests cover both the proportional intrinsic case and the layout-sharing case.
- Display list renderer now treats opacity groups as isolated layers: `PushOpacity` renders into an offscreen canvas and composites back, so overlapping content in the group stays uniformly translucent instead of darkening with multiple primitives. Added a regression to lock the grouped compositing.
- Display list stacking contexts now carry mix-blend-mode, isolation, and transforms: builder emits push/pop for stacking contexts with those properties, and the renderer composites them via offscreen layers with the correct blend/isolation while applying the authored transform matrix around the context origin. Added a regression to ensure blended content groups before applying the blend.
- Display list builder now emits background color fills honoring background-clip; rounded corners are mapped to FillRoundedRect with resolved radii and padding/border insets so backgrounds show up in display-list rendering. Added a regression to ensure styled fragments emit a background fill.
- Display list builder now emits background images/gradients and per-side border styles: layers honor background-origin/clip/attachment/repeat/size/position with rounded clips and src-rect cropping for tiles, and borders flow through a dedicated display-list item that preserves per-side styles/widths/colors (dotted/dashed/double/groove/outset/inset). Added regressions for gradient/background-image and border emission.
- Display list renderer now paints the new border items using the painter’s edge semantics (dotted/dashed/double/groove/ridge/inset/outset) and clips rounded borders via the rect+radii to avoid leaking past curved corners.
- Box shadows now flow into the display list: builder emits inset and outset shadows from computed styles with resolved lengths/radii, respecting padding-box geometry for inset shadows; tests cover emission. Renderer already rasterizes shadows via the shared box-shadow path.
- Stacking contexts in the display-list path now carry resolved filter/backdrop-filter stacks and radii; renderer applies filters to the offscreen layer and backdrop-filters to the parent pixmap before compositing so filter effects match the painter path.
- Backdrop filters in the display-list renderer now respect border radii via a rounded mask, and drop-shadow filters render from a dedicated shadow buffer instead of cloning the whole pixmap.
- Added display-list renderer regressions to lock filter/backdrop behavior (invert filters on content and backdrop inversion region).
- Display list optimizer now accounts for box-shadow offsets/blur when culling, and keeps shadows that land in the viewport via offset; added optimizer regression for offset shadows.
- Backdrop filter masking in the display-list renderer now draws the rounded mask at the backdrop's offset within the copied region so partially visible radii clip correctly when the context is clipped to the viewport.
- Display-list drop-shadow filters now follow the painter path: shadows tint with the filter color, support spread via max-alpha dilation, blur via Gaussian, and composite shadow + source back into the layer instead of cloning the whole pixmap.
- Display list builder now initializes an `ImageCache` by default so replaced images decode even when callers forget to opt in; added a regression (`default_builder_decodes_images_without_explicit_cache`) that data-URL SVGs render as image items rather than placeholders.
- Display list images now carry sampling quality; builder maps `image-rendering: pixelated/crisp-edges` to nearest-neighbor and renderer honors the quality, with a regression covering nearest vs. linear resampling.
- Display list renderer now respects `ImageItem::src_rect`, cropping the source before scaling; regression covers sprite-like cropping to ensure sub-rectangles map to the destination instead of the full image.
- Background-repeat `space` now centers a single tile instead of pinning to the start, matching the spec fallback when only one image fits; added a regression to lock the centered placement (offsets still apply).
- Background properties now keep author lists per longhand and rebuild layers from them; the background-image count defines the layer count, shorter lists repeat their last value, and extra values are dropped. `background:none` and color-only shorthands reset the lists to initials. Painting still clips color to the last layer. Added list-repetition/truncation coverage alongside repeat/size/origin/clip tests.
- Background color clipping now follows the first layer’s `background-clip` (after list repetition), with a regression ensuring border areas stay unpainted when the top layer clip is padding-box across multiple clip values.
- Remaining background follow-ups: validate multi-layer painting order/clip per spec and harden comma tokenization for complex values.
- `<video>` replaced elements now carry the `poster` attribute; intrinsic sizing uses the poster image when no explicit dimensions are provided, and both the painter and display-list builder render the poster before falling back to placeholders. Added unit tests for poster-driven intrinsic size, display-list decoding, and paint output.
- Styled-tree box generation now honors `display: contents`: contents elements no longer create boxes; their ::before/::after/marker boxes are spliced into the parent child list, matching DOM-path behavior. Added a regression to ensure children are adopted instead of wrapping.
- Text nodes are no longer dropped when they contain only whitespace; box generation now preserves whitespace-only text boxes so whitespace is handled by layout/white-space instead of being stripped.
- Display list optimizer now defers stacking-context culling until PopStackingContext: it collects child bounds, expands them by filter/backdrop outsets, respects transforms by disabling per-item culling while transforms are active, and drops entire contexts only when their expanded bounds miss the viewport. Added regressions for filter spillover, offscreen filtered contexts, transform-aware culling, and kept renderer drop-shadow coverage.
- Clip-aware culling: the display list optimizer now skips subtrees clipped entirely outside the viewport when no transforms/effects could pull them back in, and clipped children no longer contribute bounds to ancestor stacking contexts. This keeps clip-driven invisibility from surviving optimization while leaving transformed/filtered clips untouched.
- Clip culling now defers the decision: clip pushes outside the viewport are tentatively kept and only dropped at PopClip if no transforms/filters appear inside; transforms/effects clear pending clip culls and context clip flags refresh accordingly. Added a regression to ensure clip + transform content isn’t culled prematurely.
- Text indent now honors negative values when computing available inline space and offsets, allowing hanging/outdented indents instead of clamping to zero.
- text-align-last start/end now have explicit coverage for directionality: tests assert RTL start/right and LTR end/right mapping on the final line so logical alignment follows line direction.
- text-align-last overrides non-justify base alignment: regression added to ensure last-line alignment applies even when `text-align` is center/etc., not just justify.
- ::marker styles now inherit from the list item (not its parent), and both pseudo-derived and fallback marker styles are sanitized through the shared marker reset, preventing disallowed layout/paint properties from leaking into markers. Added a regression to lock marker inheritance.
- Fallback markers still clone the list-item color but now always run through the marker reset to clear padding/margins/backgrounds; added a regression to ensure marker boxes get zeroed edges even without ::marker rules.
- Pseudo-element selector matching uses the stateless pseudo matching mode so `::marker` rules actually apply; marker property filtering now whitelists `text-combine-upright` and inherited text styling while rejecting non-text box properties, and `text-indent` is no longer allowed on markers. Added a regression to assert text-combine upright/letter-spacing are honored and visibility is ignored.
- Tightened ::marker allowed declarations to match CSS Lists 3: only content/bidi/text-combine/animations plus inheritable text styling are accepted, while alignment/indent remain ignored. Added a regression to ensure text-align/text-indent authored on ::marker are dropped.
- UA defaults for markers now follow CSS Lists 3: unicode-bidi isolates the marker, tabular numbers are forced, white-space defaults to pre, and text-transform resets to none. Regression covers the defaults.
- ::marker now accepts inherited text-emphasis properties (style/color/position) while still rejecting non-inherited decoration/shadow. Regression added to lock emphasis application.
- Marker UA defaults are now applied at low priority (author styles can override white-space/unicode-bidi/text-transform), with regressions confirming overrides. Allowed properties now include text-emphasis; text-decoration/text-shadow remain filtered out.
- Flex/grid formatting contexts now pass computed `aspect-ratio` through to Taffy (via the `aspect_ratio` field) and grid containers forward `align-items`, so flex/grid items derive missing dimensions from authored ratios. Added regressions for flex (width↔height) and grid items (height from width and width from height) to lock the behavior.
- CSS alignment properties now flow through to layout: `align-self`/`justify-self` are parsed (auto → fallback) and mapped onto Taffy for flex and grid items, and `justify-items` is inherited and forwarded for grids. Added flex/grid regressions to verify align-self overrides parent alignment and justify-items/justify-self position grid items correctly.
- Alignment parsing now accepts the full start/end family (`start`/`end`/`self-start`/`self-end`) plus left/right/normal and maps them to Taffy’s start/end variants; align/justify self handle `auto` correctly. A parsing regression locks the start/self-end/right/auto/center combinations.
- Added CSS Box Alignment shorthands: `place-items`, `place-self`, and `place-content` parse to align/justify pairs, and align-content now supports `space-evenly`. Parsing tests cover the shorthands.
- Writing-mode now parses/inherits and flex-direction is mapped through writing-mode: row/column resolve to physical axes based on the flow direction (vertical writing maps row to columns, block axes flip when inline is vertical). Regression locks vertical-rl row behaving as a column.
- Align/justify start/end now respect axis direction: flex/grid mapping flips start/end based on the writing-mode-derived axis direction, and flex tests cover vertical-rl aligning to the block-start edge.
- Grid justify-content now participates in the same axis-aware alignment mapping, threading inline-direction start/end into Taffy; alignment conversions use axis signs for both block and inline axes.
- Grid template/auto tracks, gaps, areas, auto-flow, and placements now transpose when the inline axis is vertical (writing-mode), so inline tracks map to vertical layout and block tracks to horizontal. Added a regression to assert template lengths swap under vertical-rl.
- Grid item axis mapping now follows the containing grid: placements and align-self/justify-self use the parent’s writing-mode/direction, not the item’s own. Regressions cover placement swapping and row/column auto-flow under vertical writing modes.
- Still pending: inline layout/painting remains physical-direction only (no vertical text shaping or logical line progression yet).
- Flex items now inherit axis direction from the containing flex container for alignment: start/end align-self/justify-self map through the parent’s writing-mode/direction rather than the item’s own, with a regression covering vertical-rl containers and mismatched child writing-modes.
- Flex container gaps and justify-content now honor writing-mode and flex-direction directionality: column/row gaps follow inline/block axes, and start/end justification flips when the main axis is reversed by writing-mode or row/column-reverse. Regression locks vertical-rl row alignment to top/bottom on inline axis.
- CSS `text-orientation` is parsed (mixed/upright/sideways/sideways-right), stored in computed styles (non-inherited), and covered by parsing regressions.
- Sideways text in vertical writing modes is flagged during shaping and painted rotated 90° to show orientation; vertical line progression remains horizontal pending a full inline-layout rewrite.
- Vertical text-orientation now follows Unicode Vertical_Orientation data (via unicode-vo): mixed splits runs so upright/Tu stay upright while rotated/Tr rotate 90° clockwise; upright/sideways modes force all runs accordingly. Shaping tests cover mixed/upright behavior.
- CSS `text-combine-upright` is parsed (none/all/digits with limits), inherits, and IFC will combine short digit runs in vertical writing, scaling glyph geometry to fit 1em and suppressing soft wraps; unit tests lock parsing and layout compression.
- Inline fragments are rotated when the container uses vertical writing modes: horizontal line layout is transposed into vertical coordinates so line stacking follows the block axis for vertical-rl/lr containers (approximate, pending full inline flow redesign).
- Grid template names no longer inherit: cascade keeps `grid-template-*` line names/maps local to the grid container instead of copying them to descendants, and a regression test locks the non-inheritance so children reset to the initial empty templates.
- CSS `image-rendering` is parsed/stored (auto/smooth/crisp-edges/pixelated plus legacy aliases), stays non-inherited, and painter now maps it to filter quality: pixelated/crisp-edges use nearest-neighbor while auto/smooth stick with bilinear for replaced elements and background images.
- Grid track parsing now supports `minmax()`, `min-content`/`max-content`, `fit-content()`, percentages, and integer `repeat()` patterns with inline line names; grid track sizing maps the new variants through to Taffy and parsing tests cover the expanded syntax.
- Gap parsing now honors the spec shorthand: `gap` accepts one or two <length-percentage> values (including percentages and `normal`), splits into row/column gaps, and unit tests cover mixed px/% plus `row-gap`/`column-gap` semantics.
- Grid auto-repeat syntax (`repeat(auto-fit|auto-fill, ...)`) is parsed into dedicated GridTrack variants and converted to Taffy repeat components with auto-fit/auto-fill counts so layout can expand tracks to available space; placement-name maps stay empty to avoid invalid line resolution, and parsing tests cover auto-fit/fill detection.
- Grid repeat parsing now retains per-line names in patterns and threads them into Taffy’s `GridTemplateRepetition`; grid line placements are converted from raw authored strings to Taffy named/numbered placements (including span/named-span) so named lines survive to layout instead of being flattened to integers.
- Grid template parsing now preserves the full line-name vectors (tracks+1) and stores them in computed styles; layout forwards them to Taffy’s `grid_template_*_names` so named lines (including those in repeats) participate in placement resolution rather than being dropped.
- Grid line placement parsing now honors CSS grammar ordering: named lines accept integer selectors in any order (`foo 2` or `2 foo`), and `span` accepts name/count permutations (`span foo 3` / `span 3 foo`), with layout tests covering the permutations.
- `grid-template-areas` now parse into validated rectangular area matrices (rejecting mismatched column counts and non-rectangular names), feed Taffy’s `grid_template_areas`, and generate the implicit -start/-end line names used by placement resolution.
- `grid-template-areas` now seed auto track definitions when no explicit tracks are provided: parsed matrices populate auto-sized columns/rows (with empty line-name vectors), and areas are ignored when explicit row/column counts conflict with the matrix, aligning with the spec’s coupling between the area matrix and explicit tracks.
- `grid-template` shorthand is parsed: pure track-list (`rows / cols`) form sets explicit tracks with line-name vectors, and area form (`"a" ... / cols`) parses quoted row templates with optional per-row track sizes plus optional column track list. Area mode defaults rows/cols to auto tracks when sizes are omitted and rejects invalid matrices.
- Track-list `grid-template` form now enforces the required slash-delimited columns list; `none` resets rows/cols/areas, and tests lock invalid/missing-column handling.
- Grid auto-placement properties are now parsed and wired through: `grid-auto-rows`/`grid-auto-columns` accept track lists (minmax/fr/percent/etc.), `grid-auto-flow` maps row/column+dense flags, and layout forwards them to Taffy. `grid-area` shorthand is supported (including named area mapping to -start/-end lines), populating raw placements for resolution.
- `grid` shorthand is parsed: template form delegates to `grid-template` handling, `auto-flow` form sets auto rows/cols/flow (row/column + dense), and `none` resets tracks/areas/auto tracks to initial values. Tests cover auto-flow and template forms.
- `grid` shorthand now resets related longhands per spec: template form also resets auto rows/cols/flow to initial values, auto-flow form resets template rows/cols/areas to none and defaults unspecified auto tracks/flow to their initials.
- Grid placement finalization now defers all authored placements (numeric and named) to Taffy for resolution, avoiding premature decisions with auto-fit/auto-fill or named lines; only the raw values persist and line-name vectors still flow to layout.
- Painter now respects float stacking order: non-positioned floats render between in-flow blocks and inline content, and positioned boxes bypass float stacking. Added painter regression to lock the block → float → inline → positioned order and aligned child bucketing in the stacking walk to honor float/inline/positioned separation.
- Stacking context layer classification now honors the `float` property: non-positioned floats populate layer 4 between blocks and inlines, while absolutely/fixed positioned elements ignore float for stacking; added regressions to lock float classification and paint-order placement.
- `z-index` now carries authored `auto` vs. numeric state (Option). Positioned boxes with explicit `z-index: 0` create stacking contexts per spec, while `auto` does not. Parsing accepts `auto`, stacking/painter ordering unwraps `None` to 0, and tests were updated accordingly.
- ::marker styling now filters declarations to the spec-allowed set (fonts, color, text/emphasis/decorations, content, white-space, bidi) so layout-affecting properties like float/transform/opacity are ignored even if authored. Marker tests now assert floats/transforms/opacity stay at defaults despite authored values.
- Floats/clear now flow through computed styles and block layout: floating boxes use shrink-to-fit sizing, are placed via the BFC float context with `clear` handling, and extend BFC height; inline formatting still skips floating inline boxes for now. Added a block regression to lock float height/clearance behavior. Parsing tests already cover float/clear.
- Inline floats now place the float into a cloned context at the current line offset and then flush buffered inline content against that updated context (clearing the buffer), so the float shapes the current segment without duplicating earlier lines or altering prior segments.
- Float placement now accounts for the float's full height when searching for a slot in the float context, scanning the entire vertical range so new floats drop below overlapping bands instead of overlapping lower floats that begin later.
- Bidi shaping now accepts an explicit base direction: the shaping pipeline uses `shape_with_direction` to seed bidi analysis with the caller-supplied paragraph direction (while respecting `unicode-bidi`), and a regression locks RTL base resolution even when the style defaults to LTR.
- Inline layout now derives the paragraph base direction before shaping (respecting `unicode-bidi: plaintext`) and threads it through text shaping/splitting so runs honor the resolved base rather than defaulting to element direction.
- Inline text creation/splitting/fallback shaping now forward the resolved base direction into every shaping call (including tabs, hyphenation, and whitespace runs), keeping bidi levels consistent across re-shaping paths and test helpers.
- Inline intrinsic width measurement now reuses the resolved paragraph base direction when collecting items, so min/max-content sizing reflects plaintext-resolved bases instead of always using the element’s authored direction.
- Small-caps shaping now honors an explicit base direction: the small-caps path threads optional paragraph direction through its segment shaping so `shape_with_direction` keeps bidi levels aligned when synthetic small-caps are used.
- Inline lines now consult the float context: line widths/boxes are shortened per float coverage via InlineFloatIntegration, and a regression asserts inline text adjacent to a float uses the reduced width.
- Float-wrapping lines now carry float-aware offsets: line boxes include the float-determined left edge and any vertical displacement, bounding boxes shift accordingly, and line-breaking inside float space subtracts positive text-indent so text no longer overlays floats or starts at x=0 when narrowed by floats.
- Added an inline formatting regression to assert float-driven line offsets/width shortening are visible via line metadata, guarding the float-aware offsets path.
- Inline-level floats are now collected inside the inline formatting context: inline children with `float` create floating boxes, are laid out shrink-to-fit, inserted into the shared FloatContext (with clearance), and returned as fragments alongside line boxes. Inline runs are split around floats so float placement updates the float context before later lines, and max height accounts for added floats.
- Inline floats now anchor to the current line instead of being deferred: the inline FC premeasures the segment, places the float at the last line’s top in a cloned FloatContext, relayouts against the updated float space (iterating if needed so the float isn’t above those lines), and commits the float fragment plus float-aware lines. New regression keeps a preceding-text float at y=0 with shortened line width.
- Inline floats now stay on the same line as preceding text without relayout shifting earlier lines: pending text is flushed, the float is placed at the last emitted line’s top, and subsequent items wrap next to it using the updated float context so line 1 text and the float share y=0 instead of forcing later lines down.
- Inline floats now leave earlier lines intact and wrap subsequent content against the new float: we flush pending items to finished lines, place the float at that line’s top in a cloned FloatContext, and continue layout with the updated context so previous text is unchanged while following content wraps correctly.
- Added `float`/`clear` to computed styles with parsing and regression coverage, so float metadata now flows through style resolution in preparation for a full float layout implementation.
- Inline intrinsic sizing in block formatting contexts now splits inline runs around intervening block-level children; min/max-content widths take the widest run rather than concatenating text across forced breaks, aligning shrink-to-fit math with anonymous block box generation.
- `visibility: collapse` now prunes table rows/columns from TableStructure, keeps source indices for mapping, trims spans, drops collapsed cells, and maps row/column backgrounds/borders using source→visible lookup; regressions cover collapsed rows and columns. Row/column group collapse is propagated to child tracks so entire groups vanish from layout and painting.
- Table column distributor leaves authored percentages intact even when they exceed available width, reporting over-constraints and honoring per-column mins/maxes; new regressions cover over-budget percentage pairs and min clamping under overflow.
- Inline bidi reordering now builds explicit embedding/isolate control streams from ancestor `unicode-bidi` settings, enforcing max explicit depth and closing contexts deterministically before running UAX#9 reordering for each paragraph of lines, reducing reliance on heuristic control sharing; dead helper pruned.
- Bidi control insertion now counts one embedding depth per context (rather than per control codepoint) so isolate-override’s dual controls still consume a single depth step, skips depth bumps when no controls are emitted, and shares the helper for box/leaf controls to keep paragraph text balanced.
- Paragraph base levels now downgrade to first-strong when any `unicode-bidi: plaintext` leaf or ancestor participates in the paragraph: plaintext detection happens during logical-text construction, the bidi base is set to `None` for those paragraphs only, and a regression covers mixed paragraphs where only the plaintext paragraph resets its base while others retain the authored base direction.
- Explicit embedding/isolate contexts that would exceed `MAX_EXPLICIT_DEPTH` are now ignored entirely (no placeholder stack entries), so overflowed contexts don’t skew stack-sharing or closers; the control helper returns None on overflow and callers skip pushing context metadata.
- Added regression to ensure over-depth isolate chains are ignored rather than skewing reordering: a nest deeper than `MAX_EXPLICIT_DEPTH` still reorders to the logical text without crashing or misordering.
- Unicode line/paragraph separators (NEL U+0085, LS U+2028, PS U+2029) now follow CSS Text segment-break handling: in `normal/nowrap` they collapse to spaces, in `pre-line` they emit mandatory breaks with space collapsing, and in `pre/pre-wrap/break-spaces` they produce forced breaks. Added unit coverage for normal, pre-line, and pre paths.
- `white-space: pre-line` now trims spaces/tabs before segment breaks so collapsible runs don’t leave a pre-break space; CRLF/LS/PS/NEL forced breaks drop preceding collapsible runs and retain only the line content with mandatory break offsets. Regression added.
- Trailing collapsible spaces in `pre-line` now behave like `normal`: trailing runs set `trailing_collapsible` instead of emitting a space, so pending spaces merge across text nodes and are dropped at block end; added regression for a trailing space and adjusted CRLF/LS/PS expectations.
- CSS `line-break` parses/inherits with support for `auto/loose/normal/strict/anywhere`; `line-break:anywhere` injects break opportunities at every cluster boundary so min-content sizing and line breaks can split long tokens without overflow, with a regression verifying long-word breaking.
- `line-break` now inherits through cascade, and `anywhere` runs add cluster-boundary breaks after shaping (without affecting nowrap). Cascade regression ensures inheritance.
- Table colspan distribution now prefers flexible columns: spanning-cell min/max growth first consumes headroom from flexible columns before inflating fixed/percent tracks, falling back to all columns only if necessary so fixed widths stay stable unless unavoidable.
- Added regression to lock the flexible-first spanning growth: a span over a fixed and a flexible column leaves the fixed min width unchanged while the flexible column absorbs the extra.
- Spanning percentage widths now propagate to the covered columns: percentage widths on colspan cells split evenly across the spanned columns, turning them into percentage tracks instead of treating the span as purely intrinsic. Added a regression for percentage splitting.
- Spanning percentage assignment now preserves authored fixed/percentage columns and only allocates the remaining percentage to auto columns in the span; if authored percentages already cover the target, constraints are left untouched, with regressions for authored+auto and fixed/percent-only spans.
- `word-break: break-word` now follows the spec alias to `overflow-wrap:anywhere`, injecting break opportunities at every character boundary and shrinking min-content widths accordingly; inline tests updated.
- Break-all/anywhere break opportunities now align to grapheme cluster boundaries via `unicode-segmentation` instead of per-scalar splits, so combining marks/ZWJ sequences remain intact; regression covers avoiding intra-grapheme breaks for both break-all and break-word.
- Break deduplication now preserves mandatory breaks when additional anywhere/break-all opportunities occur at the same byte offset, so forced breaks survive added emergency breakpoints; regression covers newline + break-word.
- Table row extra-height distribution now matches CSS expectations: rows start from their intrinsic/content minimums, and when the table has a definite height, only auto rows receive extra space (proportional to their current heights; percent/fixed rows stay at their targets), with regressions for proportional and fixed/percent cases.
- Percentage row heights now resolve against the table’s content box even in collapsed border model: outer table borders are subtracted from the base for percent rows so they size to the available content height instead of including collapsed border thickness.
- Table padding is now honored in collapsed border model for sizing: padding is resolved even when borders collapse, contributes to available content height for percentage rows, and inflates the overall table box; row/column offsets start after padding in collapsed tables.
- Added regression for collapsed tables with padding: specified table height stays intact while content is inset by padding, ensuring cell rows start after the padding top.
- Column percentage widths now normalize when their sum exceeds 100%, scaling proportionally to stay within the table’s percentage budget; regression ensures over-100% columns are renormalized.
- Absolute/fixed offsets now resolve `em`/`ex`/`ch` using actual font metrics and `font-size-adjust`: AbsoluteLayout carries a FontContext, offset resolution uses metric-aware helpers, and regressions cover ex-based offsets and adjust scaling; PositionedStyle builder exposes `font-size-adjust` and defaults stay intact.
- Relative/sticky offsets now reuse the metric-aware resolver: PositionedLayout carries a FontContext, sticky constraints resolve through font metrics/size-adjust, and relative/absolute helpers use the same path so all positioned flows honor em/ex/ch accurately.
- Added regressions for positioned offsets with font metrics and font-size-adjust in relative and sticky cases to lock the metric-aware behavior.
- Flex and grid formatting contexts now resolve viewport-relative units using the actual viewport during Taffy conversion: contexts store a viewport size, the factory wires it through, and gaps/padding/margins/borders/flex-basis/grid tracks resolve vw/vh/vmin/vmax via the viewport instead of falling back to font-relative px.
- Viewport-relative units now resolve against the actual viewport/initial containing block instead of the local percentage base: the formatting-context factory carries the viewport size from `LayoutConfig`, block/inline contexts store it and pass it into length resolution, and replaced-element sizing uses viewport dimensions for vw/vh/vmin/vmax. Detached contexts default to an 800×600 viewport, and the viewport padding regression now asserts vw/vmin resolve to viewport size.
- Positioning offsets (relative/absolute/fixed/sticky) now resolve vw/vh/vmin/vmax against the viewport size instead of font-relative fallbacks: containing blocks carry an explicit viewport size, offset resolution handles viewport units, and positioning tests now cover viewport-based offsets.
- Font-relative and percentage lengths in layout now resolve against the element font size and the root font size for `rem` across block/inline sizing, padding/borders, margins, replaced sizing, and positioned offsets; root font size is propagated from the computed root element. Offset resolution now honors em/rem instead of dropping to 0, and a regression covers em/rem padding resolution.
- PositionedStyle now carries `root_font_size` so positioned layout can resolve rem/em offsets consistently with computed styles.
- Letter/word spacing now parse `normal`, resolve font-relative units/em/rem/ex/ch and percentages (word-spacing) against the element font size/root size, instead of ignoring relative units or leaving inherited values. Added regression covering normal reset, em resolution, percentage word spacing, and negative values.
- `text-transform` now follows the Level 3 grammar: a structured case transform plus optional `full-width` and `full-size-kana` flags. Transforms apply in spec order (case → full-width → full-size-kana); small kana (hiragana, katakana, halfwidth, phonetic extensions) expand to full-size forms, and full-width still widens via Unicode `<wide>/<narrow>` mappings with preserved-space handling. New regressions cover space behavior, halfwidth ordering, and small-kana expansion.
- `text-transform: capitalize` now uses Unicode word boundaries and uppercases the first codepoint in each word (via word-bound splits), instead of whitespace-only detection; mid-word punctuation/apostrophes follow UAX#29 so foo.bar stays one word while word starts still capitalize. Added tests for apostrophe handling, punctuation boundaries, and multi-letter uppercase glyphs.
- Non-image replaced elements (video/iframe/embed/object/canvas) now render a UA placeholder instead of an empty gray box: both painter and display list paths draw a labeled placeholder rectangle keyed to the replaced type so absent resources are still visible.
- Added regression covering SVG data URLs so the image cache decodes inline data for replaced content instead of silently falling back to placeholders.
- Display-list clipping builder now respects `visibility` like the painter: hidden fragments short-circuit before pushing clips/content, with a regression to lock the behavior.
- `font-synthesis` parses/inherits and controls synthetic small-caps: the shorthand resets to the initial (weight+style+small-caps), and synthetic small-caps are suppressed when authors disable the small-caps flag; a pipeline regression guards the non-synthetic path.
- `font-synthesis` now controls weight/style synthesis too: computed styles carry weight/style flags and the shorthand resets them, shaping only synthesizes bold/oblique when allowed, and `FontRun`/display list/text items propagate synthetic stroke/shear so the canvas/rasterizer can render synthetic bold/oblique when faces are missing (tests cover parsing, shaping, and rasterization).
- `font-size-adjust` parses/inherits (`none` | `<number>` | `from-font`), is reset by the `font` shorthand, and drives x-height-aware sizing: preferred aspects come from the authored value or the first available font, used font sizes scale per font during shaping (synthetic bold thickness scales too), and strut metrics use the adjusted size so layout and paint stay aligned. New regressions cover parsing and adjusted font sizes.
- Inline layout now resolves font-relative lengths (`em`/`ex`/`ch`) from actual font metrics and the adjusted used font size: ex pulls the scaled x-height, ch measures the “0” advance from the chosen font, and font-size-adjust influences the used size; inline padding/borders/markers/tabs/text-indent use these metric-aware values instead of fixed 0.5em fallbacks.
- Block layout now uses the same metric-aware font-relative resolution: padding/borders/margins and intrinsic widths resolve em/ex/ch against the selected font with font-size-adjust applied, and tests cover ex/ch correctness and adjustment scaling via a shared resolver in `layout::utils`.
- `text-transform: full-width` now maps characters using the Unicode `<wide>/<narrow>` compatibility decompositions (ASCII, currency, halfwidth kana/Hangul, arrows/box symbols, etc.). Spaces widen only when the white-space mode preserves them (pre/pre-wrap/break-spaces), matching the CSS Text transform ordering; new regressions cover collapsed vs preserved spaces and halfwidth katakana.
- Removed duplicated `overflow`/`overflow-x`/`overflow-y` parsing arms to silence unreachable-pattern warnings while keeping clip keyword handling intact.
- `text-underline-position` now parses/inherits (auto/from-font/under/left/right combinations), handles space-separated inline values, propagates with decorations, and the painter respects it by pushing underlines below descenders when authored; regression covers parsing, inheritance, and paint positioning.
- `text-underline-offset` now inherits per spec so descendant underlines default to ancestor offsets; cascade regression added alongside the underline-position coverage.
- CSS text emphasis added: `text-emphasis-style`/`color`/`position` parse/inherit (string or filled/open dot/circle/double-circle/triangle/sesame), shorthand is supported, and painter renders emphasis marks per glyph above/below text using currentColor fallback; regressions cover parsing, inheritance, and paint placement.
- Display-list path now carries text emphasis: Text items include emphasis metadata, the builder resolves mark positions/colors and shapes string marks, and the renderer paints emphasis marks/shaped strings so display list output matches painter. Added renderer regression for emphasis mark placement.
- `text-decoration-skip-ink` now parses to computed styles, inherits, and painter builds underline segments by subtracting glyph bounding boxes from the decoration band so descenders stay unpainted; regression compares decoration vs text color to ensure skip-ink gaps, and underline offset test warning cleared.
- Text decorations now propagate per spec instead of being confined to the element that declares them: cascade accumulates ancestor decorations unless an explicit `text-decoration: none` clears them, descendants can add additional lines, and the painter renders all propagated decorations with their own style/color/thickness/offset/skip-ink settings. Added cascade regressions for propagation, suppression, and additive decoration.
- `text-decoration-skip-ink` accepts the spec `all` keyword and treats it like auto (carving out underline segments wherever glyph ink intersects); painter/propagation support and a regression cover the behavior.
- Skip-ink carving now inflates glyph bounds by a small 0.5px tolerance instead of scaling with line thickness, and when exclusions would erase the line entirely we fall back to a single full-span segment so decorations still render; regressions cover both descender carving and `skip-ink: all` parity with auto.
- Table captions are now spec-compliant: `caption-side` parses/inherits (default `top`), `<caption>` defaults to `display: table-caption`, and table layout wraps the table box with a wrapper that positions captions above/below the table while keeping backgrounds/borders on the table box only. Caption width follows the table width and new regressions lock top/bottom placement.
- `empty-cells` parses/inherits (default `show`); when set to `hide`, empty cells with transparent backgrounds drop their borders in both separate and collapsed border models. Collapsed border resolution skips hidden empty cells, and cell fragments zero out borders/background when hidden; regressions cover both models.
- Table cell intrinsic widths no longer double-count padding/borders: intrinsic measurement strips padding/borders before sizing content and then adds edges once. Regression locks a padded fixed-width child at min-content 70px (50px content + 10px padding on each side).
- Table row and row-group background fragments are only emitted when they actually paint (background color/image, non-hidden borders with width, or box-shadows) to avoid inflating fragment counts and mispositioning cells when rows are visually empty.
- Column-group and column backgrounds now paint as dedicated fragments before rows/cells: colgroups span their covered columns, columns use their own styles, collapse/separate spacing is respected, and empty styles are filtered out. Regression asserts paint order and presence.
- Table decoration fragments strip borders for columns/column-groups/rows/row-groups before painting so column/row borders don’t render in separate border model or double-paint in collapsed. Gating now ignores borders when deciding whether to emit these fragments. Regression updated to ensure column borders are removed.
- `visibility` property now parses/inherits (visible/hidden/collapse) and painter/display-list/stacking builders skip hidden/collapsed fragments; regressions cover hidden/collapse paint suppression and display-list omission.
- `outline` longhands/shorthand parse/inherit: defaults invert/medium/none (shorthand resets to initial), supports `outline-style: auto` (paints solid) and `outline-color: invert` (painted via difference blend); negative widths ignored. Painter/display list emit outline strokes outside the border box using offset + half-width expansion; regressions cover paint, display-list emission, shorthand reset, currentColor fallback, and invert handling.
- Display list strokes now carry blend modes so outline invert can render as Difference; renderer and canvas support per-stroke blend overrides, stroke helpers/tests/benches updated.
- Outlines are no longer clipped by overflow/clip boxes: stacking bounds don’t clamp to overflow clips, outlines stay in the unclipped paint bucket, and build_with_clips emits outlines after pop_clip so they sit outside clipping. Added regressions for overflow-hidden outlines and clipped display-list builds.
- Stacking-context bounds now clip non-outline content to overflow clip axes while still letting outlines extend outside; layer bounding boxes stay tight for clipped content but preserve outline overflow. Regression updated.
- `box-sizing` now parses (`content-box`/`border-box`) and defaults to content-box; width/height/min/max resolve against the correct box in block layout, inline-block shrink-to-fit, replaced sizing, and positioned/absolute layout. Border-box widths subtract padding/borders from content, and new regressions cover block widths and replaced sizing under border-box.
- Flex/grid wrappers now honor `box-sizing: border-box` when feeding Taffy: absolute width/height/min/max lengths are converted to content-box lengths before padding/border are added, keeping border-box sizing consistent for flex/grid items. Added flex and grid regressions to assert border-box items retain their authored outer widths.
- CSS `overflow` now accepts the spec `clip` keyword; parsing sets overflow-x/y to Clip and the painter/stacking context logic treats it like a non-scrollable clip. Added stacking and parsing regressions to cover overflow: clip.
- `font-variant-alternates` now parses/inherits (historical-forms, stylistic/ styleset/ character-variant sets, swash, ornaments, annotation), resets via `font` shorthand, and maps to OpenType features (`hist`, `ssXX`, `cvXX`, `swsh`, `ornm`) during feature collection; regression added for alternates emission.
- Small-caps shaping now prefers native OpenType features when available (`smcp`/`c2sc` via font_db::font_has_feature), synthesizing only when the chosen face lacks them (covers all-small-caps too).
- `font-variant-east-asian` now parses/inherits (jis78/83/90/04, simplified/traditional, proportional/full-width, ruby), maps to OpenType toggles (`jp78/jp83/jp90/jp04/smpl/trad/fwid/pwid/ruby`), and resets via `font` shorthand alongside ligatures/numeric/kerning/feature overrides.
- `text-shadow` paints from computed styles: offsets/blur resolve relative lengths, shadows rasterize from glyph outlines before the fill, and a painter regression checks horizontal offsets render separate colored shadows.
- Display list path now carries resolved text shadows on `TextItem`, the renderer rasterizes shadows from glyph outlines (respecting opacity/transform/clip), and new display-list tests assert shadow offsets alongside the painter coverage.
- `text-underline-offset` parses (auto | length | percent), is stored on computed styles, and painter applies it to underline positioning (positive offsets push the line farther from the text). Added a regression asserting offsets move the underline by the authored length.
- Shaping collects OpenType features from computed styles, applies ligature defaults, and maps numeric/east-asian variants plus kerning into feature tags; `font-feature-settings` still overrides. New regressions cover numeric+EA feature emission.
- `font-variant-numeric` and `font-kerning` now parse/inherit and map to OpenType features: numeric figure/spacing/fraction variants drive `lnum/onum`, `pnum/tnum`, `frac/afrc`, plus `ordn`/`zero`, and kerning toggles `kern` (auto leaves defaults). `font` shorthand resets numeric, ligatures, kerning, and custom feature overrides.
- Shaping collects OpenType features from computed styles, applies ligature defaults, and lets `font-feature-settings` override/disable them; features flow through `FontRun` into HarfBuzz shaping and are covered by a regression.
- Line-height normal now uses actual font metrics when available: inline strut/text/replaced/inline-block computations pull scaled metrics from the shared FontContext and compute line-height from the font’s ascent/descent/line-gap instead of a hardcoded 1.2× font size. Added regression for metric-aware normal line-height.
- Painter and display-list builder now resolve scaled font metrics for alt text and compute line-height from those metrics, keeping fallback text alignment consistent with layout metrics instead of the 1.2× heuristic.
- API alt intrinsic sizing uses the same metric-aware line height, so alt-driven intrinsic sizes/aspect ratios align with layout/painter metrics.
- `font-variant-caps` parses/inherits (small/all-small/petite/all-petite/unicase/titling), is stored in computed styles, reset by `font` shorthand, and maps to OpenType features (`smcp/c2sc`, `pcap/c2pc`, `unic`, `titl`). Collect-opentype-features regression added, and synthetic small-caps now treats all-small-caps by scaling uppercase too.
- `font-variant-ligatures` now parses/inherits and maps to OpenType toggles (`liga`/`clig`/`dlig`/`hlig`/`calt`), `font-feature-settings` parses comma-separated tags with on/off/numeric values (rejects malformed tags), and `font` shorthand resets ligatures/feature overrides to initial.
- Shaping collects OpenType features from computed styles, applies ligature defaults, and lets `font-feature-settings` override/disable them; features flow through `FontRun` into HarfBuzz shaping and are covered by a regression.
- `font-weight` relative keywords now resolve against the parent per CSS Fonts 4's table (100/400/700/900 breakpoints), numeric weights are clamped to the valid 1-1000 range during cascade, and out-of-range values are ignored; cascade/pseudo paths resolve weights before inheritance is used downstream and new regressions lock the mapping.
- `font` shorthand now parses font-style/weight/size/line-height/family (with absolute/relative size keywords and line-height percentages), rejects missing family, and line-height percentages resolve to multipliers in both shorthand and longhand.
- `font-stretch` is parsed (keywords + percentages, clamped 50-200%), inherited, stored in computed styles, carried through font selection (painter, display list, inline struts), and respected by font shorthand; shaping now requests fonts with stretch via FontContext.
- `font-size` longhand now accepts CSS keywords, percentages, and em/rem (relative to parent/root), matching shorthand behavior and covered by regressions.
- `font-style: oblique <angle>` is parsed (angle optional), stored in computed styles, handled in font resolution, and supported in font shorthand; UA defaults for `i/em` switch to oblique(None).
- `font-variant: small-caps` is parsed/inherited and handled in font shorthand; shaping synthesizes small caps by uppercasing lowercase letters and scaling their font size to 80% while leaving uppercase at full size, with regression covering split run sizing.
- Rowspan height distribution now allocates spanning overflow to auto rows first (falling back to even splits), keeping fixed/percent rows stable; baseline reservation for spanning cells is clamped to the first row’s share to avoid monopolizing height, and a regression asserts rowspans leave later rows with real height in the full layout pipeline.
- Rowspan distribution now considers row floors (content + fixed/percent targets when definite) before deciding how much extra to spread, avoiding over-allocation when some rows already satisfy the span. Legacy row-height calculator got the same floor-aware, auto-preferred distribution plus regressions for fixed/percent rows.
- Inline RTL placement now positions visual fragments from the right edge using the resolved paragraph direction, so start/end alignment and indentation respect RTL flow; added regression for multi-fragment RTL lines.
- Replaced media without explicit dimensions now pick HTML default intrinsics (300×150, 2:1 ratio) for canvas/video/iframe so layout has a definite size when authors omit width/height; generation tests cover the defaults.
- Embed/object replaced elements now use dedicated types, preserve src/data, and also default to 300×150 with 2:1 aspect ratio when no intrinsic dimensions are provided.
- Embed/object (and iframe/video sources when image-like) now render actual image/SVG content through the shared ImageCache in both painter and display-list paths, with regressions covering inline-SVG embed/object decoding and paint.
- Embed/object/iframe intrinsic sizes now probe their data/src (including inline SVG) via ImageCache so layout picks correct intrinsic dimensions/aspect ratios instead of falling back to the 300×150 default when resources are resolvable; added intrinsic sizing regressions.
- Bidi analysis now keys levels by character, not byte offsets, preventing multi-byte text from misclassifying levels; unicode-bidi overrides force all characters to the element direction and skip reordering. Added tests for char-index handling and overrides.
- `unicode-bidi: plaintext` in the shaping pipeline now derives the paragraph base direction from first-strong content instead of always using the element direction, keeping shaping in sync with layout’s plaintext handling.
- Inline bidi reorder now tracks opened/closed embedding controls with a stack when constructing the logical text to reduce control leakage across nested inline boxes.
- Added regression for nested isolates and tightened control stack handling during inline bidi flattening to keep embeddings balanced.
- Bidi analyzer now keys levels to character starts (not byte slices), so multi-byte codepoints map to correct levels in the standalone text::bidi path as well; base handling unchanged.
- Inline bidi flattening now keeps embedding closers aligned to the active box stack (opens on entry, closes on exit) so isolates no longer close after each leaf; isolates tests restored.
- Inline bidi control emission now clamps to the Unicode max explicit depth, skipping additional embedding/isolating controls once the limit is hit, with a regression covering excessively deep inline stacks.
- Inline bidi context tracking now skips closing controls for contexts that emitted none (e.g., when depth-limited), preventing unbalanced control sequences during paragraph flattening.
- Inline bidi flattening now avoids pushing stack frames when both opens/closes are suppressed, and skips empty leaf wrappers, so the logical text stays minimal when controls are elided.
- Paragraph direction now resolves from first-strong content for `unicode-bidi: plaintext`: line records carry the resolved bidi base direction from UAX#9, start/end alignment and text-indent mapping use the per-line direction, and plaintext blocks align to RTL/LTR starts per their content. Tests cover RTL/LTR plaintext alignment.
- `unicode-bidi: plaintext` now wraps content with FSI/PDI isolates so paragraph base directions stay stable while plaintext spans choose their own first-strong direction; bidi control insertion always runs so isolates/embeds for other runs aren’t dropped, and a regression guards plaintext isolates not flipping the paragraph.
- Canvas now maintains clip masks (including rounded radii) and applies them to all primitives/text; display list renderer uses the clip radii, keeps transforms scoped with save/restore, avoids shrinking images to the clip rect, and has a regression for transform stacking plus clip-mask coverage in Canvas tests.
- `<img>` alt text now flows through the pipeline: ReplacedType::Image carries alt, intrinsic sizing falls back to shaped alt text when image loading fails/`src` is empty, and painter renders alt text instead of the gray placeholder. Tests cover both sizing and paint fallback.
- Display list builder now shapes text with the shared font context (using existing shaped runs when present) and emits alt text when images fail instead of gray placeholders, so display-list output matches painter fallback semantics.
- Display list text items now preserve font identity per shaped run (family/weight/style) and emit one item per run with correct bidi-aware glyph offsets; glyphs inherit the run’s direction/advance instead of flattening to a single anonymous font.
- Display list renderer grows feature coverage: respects linear/radial gradients via tiny-skia shaders, uses the canvas’ current blend mode for image/gradient draws, and clips gradients through the mask-aware Canvas path; regression tests cover transforms scoping and basic gradient rendering.
- Display list renderer now draws box shadows via the rasterizer (honoring opacity/blend/clip) and scopes stacking contexts through save/restore so nested clips don’t leak; added regressions for shadows and clip restoration.
- Display list optimizer now respects filter/backdrop/transform outsets: stacking contexts cull using filter/backdrop bounds, per-item culling is bypassed when a transform/filter could move paint into the viewport, and drop-shadows don’t get culled away. Added optimizer regressions for filter spillover, offscreen filtered contexts, and transform-aware culling, plus a display-list renderer regression for drop-shadow filters.
- CSS gradients (linear/radial) now parse through the CSS value parser and paint as background images in the main painter, including stop normalization and clip-radius masking; gradient parsing/paint regressions added.
- Repeating gradients parsed and painted: repeating-linear/radial-gradient now map to background images, using repeat spread in the painter; parsing and paint regressions added.
- Display list gradients carry spread modes (pad/repeat/reflect) and the renderer maps them to tiny-skia; tests updated to set spreads and cover repeating linear gradients. Background cover offset test now matches the spec default `background-position: 0% 0%`.
- Background-repeat now supports the full grammar (repeat/space/round/no-repeat pairs): parsing builds per-axis keywords, painter rounds tile sizes for `round`, spaces tiles for `space` (first/last touch edges, background-position only when a single tile fits), and repeats patterns into the paint area. Added tiling helpers/tests for space and round.
- Added parsing coverage for background-repeat keywords/pairs to ensure style application maps shorthands and pair syntax correctly.
- `list-style-image` is parsed/inherited, resets via shorthand, and markers now carry either text or image content. Marker boxes load intrinsic sizes through the image cache, and inline layout positions image markers with outside/inside semantics (outside markers paint with negative offsets, inside markers consume a 0.5em gap). Box/debug printers and tests updated accordingly.
- Inline replaced elements now honor padding/borders in their inline box dimensions: layout accounts for padding/border in advance/width, marker images inherit the larger box, and inline fragment positions respect margins; added regression to guard inline replaced sizing.
- Bidi reordering now runs at paragraph scope: line builder aggregates paragraph text, feeds paragraph-level BidiInfo into each line, and preserves explicit embeddings across soft wraps. Added regression for unclosed RTL embeddings spanning lines.
- Table colspans now water-fill minimum widths: spanning cells first consume per-column headroom up to max widths, then grow all spanned columns evenly if needed; max widths expand evenly when spans exceed current sums. This keeps colspan constraints from unfairly flattening flexible columns.
- Colspan max expansion now favors columns with available headroom before falling back to even splits, so spanning cells don’t inflate already-tight columns unnecessarily; regression added for headroom-aware max distribution.
- Colspan width attributes (including percent when a base exists) now participate in column constraint construction even for multi-column cells: specified widths raise the spanned columns’ min/max targets before distribution, and a regression covers fixed-width spanners increasing column minima.
- Background-attachment parsed and respected: scroll/fixed/local stored in computed styles, and painter positions backgrounds relative to the viewport for `fixed` while clipping to the element. Gradients now use the positioning area separately from the paint area. Added regression covering fixed anchoring.
- `background-attachment: local` now anchors images to the scrollable overflow area (padding box) and treats `background-clip: border-box` like padding-box for scroll containers; clipping radii follow the adjusted box. Regression ensures border areas stay clear while padding paints.
- Background-size matches the CSS grammar: per-axis components accept length/percent/auto, single values default the second to auto, and cover/contain remain keywords. Painter resolves mixed auto/length pairs using intrinsic size/ratio (falling back to 100% when none) and rounding now checks explicit auto-auto. Parsing and paint regressions added.
- Background-position supports offset keywords per Images 3 syntax: components store alignment + offset, parse four-value forms like `right 10px top 25%` (with end offsets negated), default the missing axis to center, and painter resolves offsets against the available positioning area minus image size. Regression added for offsets/defaults.
- Background shorthand now resets all background fields to their initial values when set (including `none` and gradient/color shorthands) so stale repeat/position/size/attachment/origin/clip state doesn’t leak across declarations; regression covers reset.
- Background shorthand regression updated to expect authored repeat keywords (e.g. `no-repeat`) rather than default repeat after reset.
- Background shorthand now handles single-value forms (e.g. `background: red` or `background: none`) while still resetting all other background fields to their initial values.
- Background initial position now matches the spec default (0% 0% instead of center).
- Text decoration now matches CSS Text Decoration: line/style/color longhands are parsed, the shorthand resets unspecified parts, currentColor is honored, and painter draws solid/double/dotted/dashed/wavy lines with per-line positions.
- Text-decoration thickness is supported: longhand and shorthand accept lengths/keywords, defaulting to auto/from-font when unspecified; painter resolves authored thickness (including font/viewport-relative units) for underline/overline/line-through.
- list-style properties parsed and reset via shorthand (type/position), defaulting to `disc outside`.
- CSS counters parsed (`counter-reset`, `counter-increment`, `counter-set`), default list counters are scoped with CounterManager (default reset on `ol/ul`, default increment on `list-item` unless overridden), list markers format from counter values, and `lower-greek` is supported.
- List markers are dedicated marker boxes: markers no longer consume inline width when `list-style-position: outside`, paint from a negative offset to sit left of the content, and a regression checks marker/text positioning.
- Marker offsets use resolved marker margins (defaulting to 0.5em) and respect direction for outside positioning (RTL pushes markers right of the text start).
- Marker text ignores `text-transform` (styled from list-style type only) and skips hyphenation/breaking logic to stay atomic.
- ::marker pseudo support wired into cascade/box generation: selector parsing handles `::marker`, marker styles inherit list-style values with box-model resets, counter properties run during styled box generation, and marker boxes use pseudo `content` when provided. List-style now inherits, and styled pipeline uses counters for numbering. Added tests for list-style inheritance and marker styling.
- ::marker property restrictions tightened: marker styles are forced inline, box-model/layout effects are reset, and inline styles still inherit text properties; regression ensures authored display/padding/margins/background on ::marker are neutralized.
- ::marker text-transform forced to none in cascade to keep marker glyphs unaltered even if authors set transforms on the pseudo or list item; regression covers transform neutrality.
- Stacking-context display list path no longer double-emits descendants: stacking-context roots paint shallowly, child layers inherit the context origin for offsets, and stacking-tree construction keeps only direct children in layers while hoisting nested stacking contexts.
- Replaced content paints inside the content box: canvas images/SVGs now respect padding/border space during painting, dynamic images convert to premultiplied RGBA instead of BGRA to avoid channel swapping, and a regression covers padding isolation for replaced elements.
- Overflow clipping now applies in paint: stacking contexts generated for overflow hidden/scroll/auto clip descendants to the padding box with radius-aware masks and a hard pixel clip (prevents filter bleed); backgrounds/borders are left unclipped, and partial-axis overflow (x hidden / y visible) keeps visible axis unmasked. Regression updated accordingly.
 - Added per-axis overflow clipping regression for `overflow-y: hidden` with horizontal overflow visible; painter respects axis-specific clipping.
- Stacking-context bounds now include transforms and filter/backdrop outsets, and layer offsets come from the visual bounds so translated/rotated children aren't clipped by ancestor offscreen buffers. Added regression to ensure transformed children remain visible through parent stacking contexts.
- Overflow clips now shrink stacking-context layer bounds before filters/backdrop filters are applied: descendant bounds are intersected with the authored clip axes while keeping the root background/border uncut, preventing massive offscreen buffers and backdrop sampling beyond the padding box. Regression added to guard clipped bounds.
- Table row heights now honor row `height` (px/em/%): row-specified lengths become minimums, percentage rows resolve against a definite table height, and tables with `height`/`min-height` stretch rows to meet that target. New tests cover specified table height and percentage row heights with a definite table height.
- Table `max-height` now clamps the table’s used height (rows may overflow), ensuring bounding boxes respect author caps; regression added.
- Percentage row heights now resolve against the table height minus border-spacing gaps in separate border model, so row percent shares exclude spacing and spacing consumes its own slice of the table height. Added regression for percentage rows with vertical spacing.
- Row `min-height`/`max-height` are honored (px/em/%): author constraints are applied per row with percent bases tied to the table’s definite height (minus spacing), and row heights are clamped accordingly.
- Row percentage heights now resolve only when the table height is definite (specified height or containing block height); table `min-height` alone no longer triggers percentage resolution. Added regression for percent rows with only min-height.
- Percent rows now clamp to their target percent share when a definite table height exists (after subtracting spacing), so percentage rows are guaranteed their authored share instead of relying on later distribution. Regression still covers spacing/min-height behaviors.
- Specified table height now drives the used table height (clamped by min/max) rather than collapsing to content when provided.
- Percent rows fill the remaining height when mixed with auto rows: any leftover space after percent targets is distributed to non-percent rows (falling back to percent rows if needed), ensuring the sum of row heights matches the table height.
- Row distribution no longer shrinks rows below their laid-out content: percent/auto scaling is clamped to content-driven minimums so over-100% percentage mixes don’t overlap cells. Added regression `percent_rows_overflow_do_not_shrink_content`.
- Percent rows that total more than 100% are no longer scaled down to the table height; they keep their targets (respecting content minima) even if that overflows the specified height. Regression `percent_rows_over_100_percent_do_not_scale_down` covers the over-100% case with empty rows.
- Table boxes now honor padding and borders in separate border model: children are offset by padding+border, total bounds include those edges, and percentage row bases remain the content box. Collapsed tables still ignore padding per CSS 2.1. Regressions cover padding offsets and border expansion of bounds.
- Percentage row bases now exclude padding/borders and spacing (content box) when the table height is definite, keeping author percentages tied to the usable content height while the specified height remains a border-box.
- Column widths now subtract padding/borders from the available content width in the separated border model, intrinsic widths add padding/border edges, and when a definite table width is present (auto layout) flexible columns expand to fill the remaining content width after spacing/edges. Column distributor behavior for standalone use stays capped at max widths.
- Legacy `calculate_row_heights` now honors percentage/fixed row heights when an available height is provided, distributes remaining space to auto rows, and spreads rowspan contributions; added a percent-height regression for the legacy path.
- Cell baseline fallback now uses the bottom border edge when no text/line is present, ensuring empty cells still provide a baseline for row alignment; collapsed-spacing tests also cover legacy row-height distribution.
- Display list builder now decodes replaced images using `ImageCache` (including inline SVG), falling back to a placeholder only when decoding fails. Added regression for inline SVG decoding in the display list path.
- Display list builder now applies `object-fit/object-position` to image/SVG display items, using the same sizing semantics as paint. SVG sources (`ReplacedType::Svg`) are rasterized through the image cache too, so inline SVGs reach the display list with correct fitting. Added regression for contain centering.
- Object-position percentages in the display list builder now resolve as stored fractions (no double `/100`) and length-based components honor percentage resolution helpers; keyword handling uses the shared `PositionKeyword`.
- Object-fit/object-position math is centralized in `paint::object_fit` and alignment space is no longer clamped to zero, so oversized images can align with negative offsets; both painter and display list share the helper and tests cover overflow alignment/percent positioning.
- Default object-position now lives in the shared helper and display list falls back to CSS initial values when a fragment lacks style, keeping painter/display list defaults aligned.
- Object-position length components now resolve font-relative units using the element font-size (via shared helper), and helpers accept viewport size when available; painter supplies viewport/pixmap size while display-list builder degrades gracefully without one.
- Display list builder can now take a viewport size so `vw`/`vh` in object-position resolve per CSS Values; added regression to confirm viewport-relative alignment through the display list path and shared helper coverage for viewport units.
- Anonymous fixup now splits inline boxes that contain block-level descendants so the blocks participate in the parent's block flow; inline fragments keep their styles, replaced elements with inline display stay inline-level in the fixup checks, and regressions cover inline/block descendants and inline-block immunity.
- `text-indent` now matches CSS Text semantics: hanging no longer indents the first line (even with `each-line`), subsequent lines shift by the indent, intrinsic inline-size accounting matches the layout behavior, and regressions cover hanging/each-line combinations and hanging intrinsic widths.
- Negative `text-indent` no longer expands the available line width; line breaking now attempts to split breakable items even on empty lines (choosing the earliest break when none fit), preventing over-wide first items from swallowing following words. Regression added.
- Replaced SVGs now rasterize via resvg for both inline content and URL/data sources: painter draws SVGs with `object-fit/object-position`, and intrinsic sizes/aspect ratios are populated from rendered SVGs. Inline SVG rendering and intrinsic resolution are covered by new tests.
- Image loader now decodes SVG files/HTTP responses by MIME/extension/sniffing `<svg` text so external SVGs no longer fail rasterization; `ImageCache::render_svg_to_image` is public for reuse, and loaders/tests cover inline SVG rendering and intrinsic resolution via `FastRender`.
- `text-align-last` now applies per paragraph (forced breaks/newlines): the last line before a hard break uses `text-align-last`, not only the final line of the block. Regression added.
- `text-align-last: justify` now falls back to start when a line/paragraph has no justification opportunities (no spaces/clusters to expand), preventing over-justifying single-word lines while keeping paragraph-aware last-line handling.
- `text-align: justify-all` is parsed to justify all lines (including the last via `text-align-last: justify`), justification opportunity checks now probe split text items (so single text nodes with spaces still justify), and inter-word justification falls back to explicit space boundaries when the break finder misses them.
- `text-align: match-parent` is supported: parsing produces a match-parent value that resolves at cascade time to left/right based on the parent’s direction, and inline layout tests cover RTL inheritance.
- `text-align-all` shorthand supported: parsed values map to text-align, reset `text-align-last` to auto for non-justify-all/match-parent cases, and justify-all sets last-line justification.
- `match-parent` resolution now follows CSS Text: resolves to start/end based on parent direction (not left/right).
- `text-align` shorthand now resets `text-align-last` to auto (except justify-all → justify), with cascade tests validating reset/justify-all behavior.
- `match-parent` now inherits parent alignment fully (including non-start/end values) and maps start/end to physical alignment using the parent’s direction; cascade tests cover both inheritance and directional mapping.
- Image cache now keys entries by resolved URLs, preventing duplicate fetches when base URL resolution changes the concrete request.
- Collapsed-border conflict resolution now has added regression coverage for style precedence (double vs lower styles) and top-edge bias; CJK auto-justify test explicitly sets `text-align-last: justify` so forced breaks still justify under paragraph-aware last-line handling.
- Added regression to ensure justify-last fallback for space-less lines; paragraph-aware alignment remains intact.
- Collapsing border conflict resolution now follows CSS 2.1 ordering (hidden suppression, width before style ranking, cell/row/col/table precedence, and left/top bias honoring `direction`), with new coverage for width-vs-style and LTR/RTL tie cases.
- `tab-size` is parsed/inherited (number or length, default 8); preserved tabs (`white-space: pre/pre-wrap`) become explicit tab items that advance to the next stop based on the space advance or length, participate in bidi/script analysis, and have regression coverage for parsing/preservation/stop alignment.
- CRLF pairs are normalized to single segment breaks across whitespace modes: pre/pre-wrap emit one mandatory break per CRLF, pre-line keeps one hard break with collapsed whitespace, and normal/nowrap treat CRLF as a single collapsible space. Tests cover the CRLF handling for pre/pre-line.
- Segment breaks now cover VT/FF too: pre/pre-wrap emit mandatory breaks for form-feed/vertical tab, pre-line and normal/nowrap treat them as collapsible whitespace. Added regressions for FF in pre and VT collapsing in normal.
- `normalize_text_for_white_space` now returns a struct with normalized text, forced breaks, soft-wrap eligibility, and leading/trailing collapsible flags (CR/LF/VT/FF-aware). IFC callers/tests updated; edge flags are ready for cross-node whitespace collapsing.
- Collapsible whitespace between adjacent inline/text boxes now survives DOM splits: trailing collapsible runs are carried as pending spaces, realized before the next inline item (including inline boxes/replaced/inline-block), and dropped at line end. Tests cover text-to-text, text-to-inline box, and trailing suppression.
- Added `white-space: break-spaces`: parsed and normalized to preserve all spaces/tabs, emit mandatory breaks for CR/LF/VT/FF, allow wrapping, and avoid collapsible flags so sequences persist. Parsing test + normalization regression added.
- Refined `word-break: break-word` and `overflow-wrap: break-word`: removed eager per-character breaks from default opportunities, keep min-content sizing unchanged, and add emergency character-boundary fallback only when a token overflows and wrapping is allowed. Tests cover overflow splitting, nowrap suppression, and min-content parity for both properties.
- Column span constraints distribute minimums using existing headroom (max-min) before evenly inflating all spanned columns; max constraints inflate evenly. New tests cover headroom-preferred splits and no-headroom fallback (`src/layout/contexts/table/column_distribution.rs`).
- Rowspan height distribution now uses weighted expansion (preferring existing row heights/baseline requirements) instead of equal splits, and baseline-aligned spanning cells reserve their baseline offset in the first row so baseline positioning has room (`src/layout/table.rs`).
- Auto table distribution now preserves min-content when over-constrained: available < total min keeps min widths and flags overflow. Percentage columns shrink (but not below their min) when fixed+percent would starve flexible columns, leaving room for flexible mins; percent columns still honor their mins if that means over-constraint. Added targeted tests for both behaviors (`src/layout/contexts/table/column_distribution.rs`).
- Percentage-only tables over 100% now scale percents proportionally (respecting min/max) when no flexible columns exist; if mins alone over-constrain, we keep them and expose overflow. Added tests for over-100% percent tables with/without min over-constraint (`src/layout/contexts/table/column_distribution.rs`).
- Over-constraint integration tests now expect min widths to be preserved (no proportional scaling) with explicit overflow reporting; fixed-width overflow test updated accordingly (`tests/table_columns_test.rs`).
- Inline bidi reordering now uses byte indices (not char counts) when selecting run directions, walks all paragraphs in the line, and has a regression for multi-byte RTL followed by LTR text to prevent incorrect run reversal (`src/layout/contexts/inline/line_builder.rs`).
- Inline bidi reordering now slices mixed-direction text items into per-run fragments before visual ordering, so RTL/LTR content within a single text node reorders correctly; added regression for a single mixed-direction text run and preserved synthetic test widths without reshaping (`src/layout/contexts/inline/line_builder.rs`).
- Inline boxes are flattened into bidi leaves so descendants reorder with siblings; inline box edges (padding/border) are reapplied to the first/last visual fragment of each box after reordering to keep backgrounds/borders aligned with visual start/end (`src/layout/contexts/inline/line_builder.rs`).
- `unicode-bidi: plaintext` now forces first-strong paragraph direction regardless of the builder base level (effective base set to None when any plaintext leaf is present); regression added (`src/layout/contexts/inline/line_builder.rs`).
- Bidi isolation now respects ancestor `unicode-bidi` settings: inline box stacks emit the appropriate embedding/isolation controls (embed/override/isolate/isolate-override) based on their direction, so isolated spans no longer disturb surrounding runs. Added isolate regression (`src/layout/contexts/inline/line_builder.rs`).
- Plaintext on ancestors now triggers first-strong paragraph direction (box stack considered, not just leaves), and isolation regression added for `unicode-bidi:isolate` inline boxes (`src/layout/contexts/inline/line_builder.rs`).
- Plaintext leaves/ancestors now drop inserted isolation controls and derive the paragraph base level via first-strong analysis of the concatenated logical text before running bidi (so plaintext isn’t skewed by LRI/RLI wrappers); added RTL-first plaintext regression (`src/layout/contexts/inline/line_builder.rs`).
- Bidi logical-text construction now balances embedding/isolation controls across shared ancestor stacks instead of emitting opens/closes per leaf; contexts are opened/closed only when the stack changes, preventing unbalanced sequences. Added regression for multi-leaf isolate inline boxes (`src/layout/contexts/inline/line_builder.rs`).
- Inline bidi context management now keeps ancestor isolates/embeddings open across leaves (opens/ closes only on stack transitions) so multi-leaf isolates share one context and neutrals resolve across sibling leaves; added regression covering multi-leaf isolate neutral resolution (`src/layout/contexts/inline/line_builder.rs`).
- Added rowspan vertical-align regression to ensure spanning cells don't collapse subsequent rows and heights remain positive (`src/layout/table.rs` test).
- Baseline-aligned rowspans now explicitly reserve baseline space in the first row; added regression to guard the baseline reservation for spanning cells (`src/layout/table.rs`).
- Collapsed border model now covered by a bounds regression: table fragments include collapsed stroke widths even with empty cells (`src/layout/table.rs` test).
- Collapsed border row offsets covered by regression: total height accounts for collapsed top/bottom strokes plus minimal row height (`src/layout/table.rs` test).
- Collapsed border positioning regression ensures cell fragments are offset by collapsed border widths and overall table width reflects stroke thickness (`src/layout/table.rs` test).
- Percent columns are treated as auto when the table inline size is indefinite (auto/max-content/min-content without a definite containing block); regression added (`src/layout/table.rs`).
- Collapsed border + rowspan vertical-align regression asserts placement under collapsed borders (`src/layout/table.rs` test).
- Auto layout now keeps percentage columns at their authored percentages (clamped to min/max) even if they over-constrain the table; flexible columns take their mins and over-constraint is reported instead of shrinking percents. Updated tests to reflect CSS2.1 behavior (`src/layout/contexts/table/column_distribution.rs`).
- Removed HN-specific hacks (vote arrow injection, navigation text forcing) from `src/tree/box_generation.rs`.
- Default font size restored to 16px (`src/style/mod.rs`); table margins stripped back to zero in defaults.
- Fixed BGRA → RGBA conversion during image encoding (`src/image_output.rs`).
- Inline text fragments now carry computed styles; painter uses shaping pipeline and real glyph outlines instead of box approximations (`src/paint/painter.rs`).
- Table layout rewritten to use computed display values, default border-spacing 2px 2px, column constraints via `column_distribution`, `<col>/<colgroup>` width handling, min/max from IFC, fallback equal widths if zero; cells laid out with BFC using computed column widths (`src/layout/table.rs`).
- Added `FragmentNode::new_inline_styled` convenience (`src/tree/fragment_tree.rs`).
- Inline FC now shapes with `ShapingPipeline`, keeps shaped runs on fragments, and uses real font metrics for struts/baselines; painter reuses those runs with pen advance and rudimentary RTL handling (`src/layout/contexts/inline`, `src/paint/painter.rs`).
- Added embedded Roboto Regular fallback for fontless environments and generic fallbacks now pick the first available face when generic lookup fails (`resources/fonts`, `src/text/font_loader.rs`, `src/text/font_db.rs`).
- Block FC now buffers inline-level children (including inline replaced/inline-block) and lays them out with `InlineFormattingContext`; inline-blocks get laid out through their own formatting context as atomic inline items (`src/layout/contexts/block/mod.rs`, `src/layout/contexts/inline/mod.rs`).
- Tests currently pass (`cargo test`).
- Replaced elements now resolve intrinsic sizes from actual images via `ImageCache` (using base URL from API/bin), reuse those sizes in inline/block layout, and the painter renders decoded images instead of gray placeholders (`src/api.rs`, `src/layout/utils.rs`, `src/layout/contexts/{block,inline}`, `src/paint/painter.rs`).
- Inline text breaking now aligns break opportunities and splits to cluster boundaries using shaped glyphs; `TextItem` tracks cumulative cluster advances so wrapping and mandatory breaks no longer slice through ligatures/combining marks (`src/layout/contexts/inline/line_builder.rs`).
- Inline line finalization now performs bidi visual reordering per line with the Unicode algorithm, treating non-text inline items as object replacements; x-positions are reassigned in visual order so mixed-direction lines place RTL runs correctly (`src/layout/contexts/inline/line_builder.rs`).
- CSS `direction` is now parsed/inherited (initial `ltr`), carried through computed styles, and used as the base paragraph direction for bidi analysis and per-line reordering (`src/style/{types,mod,properties,cascade}.rs`, `src/text/pipeline.rs`, `src/layout/contexts/inline/mod.rs`).
- Added CSS `unicode-bidi` support (normal/embed/override/isolate/isolate-override/plaintext), plumbed through computed styles and applied during inline line reordering via appropriate UBA control characters; per-item direction comes from computed style and non-text items still participate via object replacement markers (`src/style/{types,mod,properties,cascade}.rs`, `src/layout/contexts/inline/line_builder.rs`).
- Inline splits now preserve shaped glyphs instead of reshaping: splitting uses existing runs at cluster boundaries, adjusts glyph offsets/advances without re-running HarfBuzz, so ligatures/kerning survive across line breaks (`src/layout/contexts/inline/line_builder.rs`).
- Non-text inline/replaced items now enter bidi reordering wrapped in directionally isolated control characters (LRI/RLI…PDI) rather than bare U+FFFC, improving structural ordering for mixed-direction lines (`src/layout/contexts/inline/line_builder.rs`).
- Inline boxes now contribute their children’s text into the bidi reorder string instead of collapsing to a single object, so nested inline wrappers reorder according to their actual textual content (`src/layout/contexts/inline/line_builder.rs`).
- Centralized bidi control generation with `bidi_controls`; logical-text construction now wraps inline boxes and atomic inline items per `unicode-bidi` values without auto-isolating inline-block/replaced placeholders when `unicode-bidi` is `normal` (`src/layout/contexts/inline/line_builder.rs`).
- Inline-block sizing now uses CSS 2.1 shrink-to-fit when `width:auto`, deriving preferred and preferred-min widths from intrinsic measurements and adding padding/borders; specified widths avoid over-constrained margins, and padding/border percentages resolve against the available inline size (`src/layout/contexts/inline/mod.rs`).
- Block layout now clamps computed content widths to `min-width`/`max-width` (percentages resolved against containing block) and recomputes margins with the clamped width so the constraint equation still holds when author limits kick in (`src/layout/contexts/block/mod.rs`).
- Inline replaced elements now honor horizontal margins: margins are resolved in the inline context, included in line advance, and their fragments are offset so margins behave as spacing rather than painted area (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Intrinsic sizing for inline content now excludes margins (replaced elements contribute their border-box width to min/max-content sums while layout still accounts for margins separately) to better match CSS sizing definitions (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Inline-blocks now resolve horizontal margins, subtract them from available inline space for shrink-to-fit sizing, and include them in line advance while only the border-box is painted (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Block intrinsic inline-size computation now accounts for inline content, in-flow block children, replaced boxes, and the element’s own padding/borders instead of just explicit widths (`src/layout/contexts/block/mod.rs`).
- Table column intrinsic widths now use the cell’s formatting context (block/flex/grid/inline) instead of forcing inline measurement, so block-only cells contribute widths correctly (`src/layout/table.rs`).
- `border-spacing` is now parsed/resolved from computed style (em/absolute lengths) and table layout pulls spacing from styles rather than a hardcoded 2px default (`src/style/{mod,properties}.rs`, `src/layout/table.rs`).
- Table column constraints now honor percentage widths on cells/cols and carry them through distribution, so percentage-specified columns consume their share of the available table width before auto distribution (`src/layout/table.rs`, `src/layout/contexts/table/column_distribution.rs`).
- Percentage columns remain unscaled even when total percentages exceed 100%, matching current column distribution expectations; over-constraint is flagged and flexible columns collapse to their minima (`src/layout/contexts/table/column_distribution.rs`).
- Colspan contributions now use the spanning-cell constraint distributor so multi-column cells raise min/max widths across the spanned range rather than per-column equal splits (`src/layout/table.rs`, `src/layout/contexts/table/column_distribution.rs`).
- Parsed `border-collapse` into computed styles and table spacing respects collapsed mode by zeroing spacing when collapse is set (`src/style/{types,mod,properties}.rs`, `src/layout/table.rs`).
- CSS `vertical-align` is now parsed/stored (UA default `middle` for `td/th`), and table layout uses baseline-aware row heights plus per-cell alignment for baseline/top/middle/bottom cases (`src/style/{types,mod,properties.rs,user_agent.css}`, `src/layout/table.rs`).
- CSS `table-layout` is parsed and stored; fixed layout now selects the fixed distribution path in the column distributor (`src/style/{types,mod,properties.rs}`, `src/layout/table.rs`).
- Fixed table layout now only inspects the first row for column sizing and ignores later rows when collecting constraints, matching CSS 2.1 fixed layout behavior (`src/layout/table.rs`).
- Explicit table widths (px/%, em/rem) are resolved against the containing block and used as the available table width; column distribution now honors author-specified table widths (`src/layout/table.rs`).
- Table widths respect `min-width`/`max-width` when clamping explicit/containing widths, and intrinsic width calculation for collapsed borders excludes border widths (padding only) so columns aren’t inflated by collapsed borders (`src/layout/table.rs`).
- Border styles now cover hidden/groove/ridge/inset/outset; collapsed-border conflict resolution honors style priority (hidden > double > solid > dashed > dotted > ridge > outset > groove > inset > none), width, and origin order, with new tests for hidden suppression and style vs. width precedence (`src/style/types.rs`, `src/style/properties.rs`, `src/layout/table.rs`).
- Collapsed borders now participate in layout: cell borders are zeroed for layout, collapsed border grid lines carry resolved widths/styles/colors and total table width/height includes them; line-level border fragments are emitted for painting when collapsed, and table border widths are zeroed at paint time to avoid double drawing (`src/layout/table.rs`).
- Layout now shares a single `FontContext` across the pipeline: `LayoutEngine`/`FormattingContextFactory` are built with the caller’s font context, block/inline/table contexts propagate it to child FCs, and `FastRender` constructs layout using the same context it hands to paint. Inline-block/table measurement now uses caller-provided fonts consistently (`src/layout/{engine,contexts/factory,contexts/block,contexts/inline}, src/layout/table.rs`, `src/api.rs`).
- CSS `white-space` behaviors are respected in inline layout: text is normalized per mode (collapse for normal/nowrap/pre-line, preservation for pre/pre-wrap), explicit breaks are inserted for newlines, wrapping is suppressed for `nowrap`/`pre`, and break opportunities are filtered accordingly. New unit coverage for normal/nowrap/pre flows (`src/layout/contexts/inline/mod.rs`).
- CSS text breaking properties added: `word-break` and `overflow-wrap` parsed into computed styles, and inline layout augments/removes break opportunities accordingly (`break-all`/`anywhere` add cluster breaks, `keep-all` prunes non-whitespace breaks) so min/max-content sizing and line breaking respond to author settings (`src/style/{types,mod,properties}.rs`, `src/layout/contexts/inline/mod.rs`).
- Hyphenation support added: `hyphens` parsed into computed styles, soft hyphens are removed while preserving their break points, and `hyphens:auto` uses a default English hyphenator to inject additional break opportunities so wrapped words can hyphenate per author intent (`src/style/{types,mod,properties}.rs`, `src/layout/contexts/inline/mod.rs`).
- Language inheritance from `lang`/`xml:lang` is normalized to lower-case BCP47 strings and passed through to shaping; HarfBuzz buffers now receive the computed language and shaped runs record it for debugging (`src/style/{mod,cascade}.rs`, `src/text/pipeline.rs`).
- Letter- and word-spacing now affect shaped runs and line metrics: spacing is applied after each cluster (word spacing layered on spaces), advances and glyph offsets updated, and unit tests cover the extra advance contributions (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Hyphenation breaks now insert a hyphen glyph at the break point (soft/auto hyphenation), preserving spacing and shaping with the same style; break metadata carries an `adds_hyphen` flag so line breaking can decide when to render the glyph (`src/text/line_break.rs`, `src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Border painting now respects CSS styles: dotted/dashed use dash patterns (round caps for dotted), double splits into parallel strokes, and inset/outset/groove/ridge apply shaded light/dark variants per edge (`src/paint/painter.rs`).
- Text decorations are painted per spec defaults: underline/overline/line-through use font metrics for position/thickness with color from current text (`src/paint/painter.rs`).
- CSS `text-transform` now applies before shaping/whitespace handling, covering uppercase, lowercase, and capitalize in inline layout (`src/layout/contexts/inline/mod.rs` tests added).
- Inline line fragments honor `text-align` (left/center/right/justify/start/end); justification spreads remaining inline space across word gaps on non-final lines, splitting text items at internal spaces and CJK break points so gaps inside a single run expand too (`src/layout/contexts/inline/mod.rs`).
- `text-align` now supports start/end mapped through `direction`; default text-align is `start`. `text-align-last` is parsed/stored and applied: last lines map start/end/left/right/center/justify, `auto` follows CSS defaults (justified paragraphs use start on final line, single-line non-justify uses text-align) (`src/style/{types.rs,mod.rs,computed.rs,properties.rs}`, `src/layout/contexts/inline/mod.rs`).
- Justification honors `text-justify`: parsed values (auto/none/inter-word/inter-character/distribute) feed inline justification. None forces start alignment even on explicit justify, auto/inter-word keep word-gap/CJK expansion, and inter-character/distribute expand at every cluster boundary. Last-line justify now applies when authored via `text-align-last`. TextItem exposes cluster byte offsets for inter-character splitting (`src/style/{types,mod,properties}.rs`, `src/layout/contexts/inline/{line_builder.rs,mod.rs}`).
- `text-indent` is parsed/inherited (length/percentage with hanging/each-line keywords) and applied during inline layout: indentation adjusts first/subsequent line available widths and offsets item placement per writing direction, with coverage for first-line vs. each-line behavior. Line boxes keep full available width when known so indentation doesn't shrink the block, unknown widths include indent extents, and intrinsic inline sizes add positive indent so shrink-to-fit honors offsets (`src/style/{types,mod,properties,cascade}.rs`, `src/layout/contexts/inline/{line_builder.rs,mod.rs}`).
- `text-justify:auto` now resolves heuristically: per-line script analysis picks inter-character when CJK dominates (otherwise inter-word). Fallback splits use per-character offsets when shaping lacks clusters, and CJK auto-justify coverage ensures per-cluster expansion (`src/layout/contexts/inline/mod.rs`, `src/layout/contexts/inline/line_builder.rs` tests).
- Ignoring synthetic mandatory breaks at end-of-text prevents empty justified lines; forced breaks still trigger splitting (`src/layout/contexts/inline/mod.rs`).
- Min-content sizing for inline content now walks the inline stream with shaped cluster advances, respecting hyphen insertion widths and avoiding synthetic end-of-text breaks between adjacent text nodes; forced breaks from normalization are tracked so explicit newlines still split segments. Added unit coverage for hyphen width accounting and cross-node words (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Max-content sizing for inline content now measures shaped clusters and only breaks on mandatory breaks (e.g., preserved newlines), so maximum width reflects the longest forced line rather than naive summing; inline boxes include their edges, and atomic inline/replaced boxes contribute without introducing breaks. New test covers preserved-newline behavior (`src/layout/contexts/inline/mod.rs`).
- Replaced images now honor CSS `object-fit` (fill/contain/cover/none/scale-down) and `object-position` (length/percent/keywords) during painting, centering and scaling content appropriately while keeping layout size unchanged. Added parsing and style defaults plus painter regression test (`src/style/{types,mod,properties.rs}`, `src/paint/painter.rs`).
- CSS parser now preserves space-separated value lists (e.g., `object-position: left 25%`) as `Multiple` so object-position parsing receives both components (`src/css/properties.rs`).
- Background positioning now obeys `background-position`, `background-origin`, and `background-clip` with proper percentage semantics (percentages resolve against the positioning area minus image size). Painter tiles images/clips to the selected box (border/padding/content) and centers/offsets from the chosen origin; defaults now match spec (origin padding-box, clip border-box) (`src/style/{types,mod,properties.rs}`, `src/paint/painter.rs`).
- Inline-level elements now materialize as `InlineBoxItem`s carrying padding/borders, vertical offsets, and styles so backgrounds/borders participate in painting; `vertical-align` from computed styles is resolved (length/percentage) and applied to text, inline boxes, inline-blocks, and replaced elements (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Inline box baselines are derived from their children (falling back to strut when empty) instead of always using the parent strut; padding/border insets adjust ascent/descent so nested inline boxes contribute realistic baselines (`src/layout/contexts/inline/mod.rs`).
- Replaced element sizing now resolves percentage widths/heights/min/max when a containing block size is available; percentage lengths with no base fall back to intrinsic sizes to avoid bogus zeros (`src/layout/utils.rs`, `src/layout/contexts/{block,inline}/mod.rs`).
- Block and inline formatting contexts propagate definite containing-block heights; percentage heights/min-heights/max-heights resolve when a base exists and fall back to auto/0/∞ when not. Vertical padding/border resolution uses the containing width to avoid panics on percentages, inline-block percentage heights honor available block height, and percentage bases for replaced sizing ignore NaN placeholders. Added tests for block/inline-block percentage height resolution (`src/layout/utils.rs`, `src/layout/contexts/{block,inline}/mod.rs`).
- Inline-block baselines now come from the last in-flow line box inside the fragment when present, falling back to the bottom border edge only when no lines exist. Baseline metrics for inline-blocks now use ascent/descent derived from that line instead of treating them as replaced elements (`src/layout/contexts/inline/line_builder.rs`).
- Collapsed table borders are painted as individual border edges using the resolved style/color/width for each grid line instead of flat stripes; vertical/horizontal borders are centered on grid boundaries and drawn with border styles (dotted/dashed/double/inset/outset/etc.) via the painter (`src/layout/table.rs`).
- Collapsed border data now carries per-segment winners (one border resolution per grid line segment), and painting renders each segment with its own style/color/width using boundary-aware positioning based on adjacent perpendicular segment widths so adjoining borders meet cleanly instead of flattening to a uniform line (`src/layout/table.rs`).
- Collapsed border corners now resolve a winner per grid junction and paint a square join using that style/color/width, reducing double-paint overlaps at intersections (`src/layout/table.rs`).
- Display-list construction now walks stacking contexts using `paint::stacking::creates_stacking_context`, emitting commands in stacking order (negative/zero/positive contexts) rather than globally sorting by z-index; backgrounds/borders for each context stay ahead of its content and descendants (`src/paint/painter.rs`).
- Stacking contexts with `opacity < 1` now render into their own layer and composite back into the canvas so opacity applies to the entire subtree instead of per-primitive alpha (`src/paint/painter.rs`).
- Opacity layers are now bounded to the stacking context’s content: commands are translated to a minimal bounding rectangle and composited back with a translation, avoiding full-canvas temporary buffers for translucent contexts (`src/paint/painter.rs`).
- Stacking contexts now honor CSS `transform`: transforms are composed into the context’s layer, applied around the fragment’s top-left, and rendered via a translated offscreen buffer before compositing back. Basic translate/scale/rotate/skew/matrix forms are supported; percentages resolve against the context’s box (`src/paint/painter.rs`).
- CSS `transform-origin` is parsed (length/percentage/keywords), stored in computed styles (default 50% 50%), and respected when composing stacking-context transforms so rotation/scale occur around the authored origin instead of top-left (`src/style/{mod.rs,properties.rs,types.rs}`, `src/paint/painter.rs`).
- CSS `mix-blend-mode` and `isolation` are parsed and stored; stacking contexts are created for non-normal blend modes or isolation, and painter composites layers using the mapped blend mode (`src/style/{types.rs,mod.rs,properties.rs}`, `src/paint/{stacking.rs,painter.rs}`).
- Isolation `isolate` now forces SourceOver when compositing the isolated layer back into its parent to prevent backdrop blending across contexts (`src/paint/painter.rs`).
- CSS `filter` is parsed and stored (blur, brightness, contrast, grayscale, sepia, saturate, hue-rotate, invert, opacity, drop-shadow). CurrentColor is deferred, lengths stay unresolved until paint, and `filter != none` creates a stacking context (`src/style/{types.rs,mod.rs,properties.rs}`, `src/paint/stacking.rs`).
- Painter resolves filters per stacking context, expands layer bounds for blur/drop-shadow outsets, and applies effects in order: color matrix filters, opacity, Gaussian blur, and drop-shadow with spread/blur/offset composited behind content (`src/paint/painter.rs`).
- Added filter parsing unit coverage for multi-function lists and drop-shadow defaults (`src/style/properties.rs` tests).
- CSS `backdrop-filter` is parsed (reusing the filter function set) and forces stacking contexts; painter copies the backdrop within the context bounds, applies the resolved filters (including blur/drop-shadow outsets), and composites it back before drawing the context, so backdrop blur/drop-shadow are visible behind translucent content (`src/style/{types.rs,mod.rs,properties.rs}`, `src/paint/{stacking.rs,painter.rs}`).
- Filters and backdrop-filters now clip to the element’s border box with resolved border radii: stacking layers and backdrop regions are masked by the computed rounded-rect radii before compositing, preventing glow/blur from bleeding outside rounded corners (`src/paint/painter.rs`).
- Background colors and images respect border-radius and `background-clip`: clip radii shrink with border/padding/content edges, fills draw as rounded rects, and image tiling is masked to the clipped rounded box (`src/paint/painter.rs`).
- `text-align-last: auto` now matches CSS Text: justify paragraphs start-align on the last line (even when it is the only line), while other alignments keep the base `text-align`; regression updated to lock the start-aligned single-line behavior (`src/layout/contexts/inline/mod.rs`).
- `text-align-last` now supports `match-parent`: matching values inherit the parent’s computed last-line alignment with start/end converted to physical left/right from the parent direction, and the shorthand `text-align: match-parent` sets last-line alignment accordingly (including on pseudos and markers). Root match-parent computes to `start`. Added cascade regressions (`src/style/cascade.rs`).
- `text-indent` keyword semantics refined: `each-line` now forces indentation on the first line even when `hanging` is present, hanging applies to subsequent lines as before, and regressions cover hanging + each-line behavior and intrinsic sizing with a hanging indent across lines (`src/layout/contexts/inline/mod.rs`).
- List markers respect `list-style-position`: outside markers no longer shift inline layout (painted outside with a gap), inside markers reserve their width+gap in layout. Regression updated to reflect outside marker positioning (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Text decorations now render even when font metrics aren’t available: painter synthesizes underline/strike metrics from the font size instead of skipping decorations when fonts can’t supply metrics (`src/paint/painter.rs`).
- Replaced element sizing now follows the CSS 2.1 replaced-element algorithm: specified width/height pairs win; single-dimension auto derives the other from intrinsic ratio, intrinsic dimensions, or default 300×150; auto/auto handles ratio-only and one-sided intrinsic data gracefully; constraints apply post-solve. Tests lock ratio-only, partial intrinsic, and min-width clamping behavior (`src/layout/utils.rs`).
- CSS `aspect-ratio` is parsed (auto or number/ratio), stored in computed styles, and participates in replaced sizing: authored ratios override intrinsic ratios when resolving missing dimensions, and auto sizing uses the authored ratio when no intrinsic ratio is present. Parsing, inheritance (non-inherited), and sizing regressions cover keyword/number forms and property/ratio interplay (`src/style/{types,mod,properties.rs}`, `src/layout/utils.rs`).
- Block layout now honors `aspect-ratio` when width is auto and height is definite: the content width derives from the authored ratio instead of filling the containing block, and auto heights still expand to satisfy ratios when width is definite. Added regression for the height-auto case (`src/layout/contexts/block/mod.rs`).
- Inline-block layout now honors `aspect-ratio`: auto widths derive from definite heights when a ratio is authored, and auto heights expand to satisfy ratios based on the laid-out width. Regressions cover both width-from-height and height-from-width cases (`src/layout/contexts/inline/mod.rs`).
- Positioned layout now respects `aspect-ratio`: absolutely positioned elements derive missing dimensions from the authored ratio when one dimension is auto, falling back to intrinsic sizes when both are auto. Tests cover width-from-height, height-from-width, and intrinsic fallback (`src/layout/contexts/positioned.rs`, `tests/layout/test_positioned.rs`).

## Current issues / gaps
- Bidi: still relies on injected controls instead of a dedicated embedding/isolate stack; nested isolates/overrides need validation against UAX#9 beyond the FSI/PDI wrapping.
- Justification lacks script-aware expansion (kashida/justification alternates, punctuation stretching) and `text-justify` is still approximated (auto treated as inter-word; no trim/edge handling).
- `text-align-last` currently maps start/end via direction; nuanced interaction with `text-justify` and additional values still pending.
- `text-indent` hanging/each-line semantics are approximate; indentation doesn’t yet handle hanging outdents per spec nuances.
- Max-content sizing now honors mandatory breaks but still ignores anonymous inline box generation and percent-driven height constraints.
- Table layout still partial: row/col spans not fully honored (rowspan baselines, percent/fixed widths still simplified vs CSS 2.1), colspan distribution still heuristic.
- Non-image replaced content (iframe/video/etc.) remains unrendered; need full replaced-element handling beyond images/SVG.
- Painting still lacks 3D transforms/transform-origin z and fuller filter/blend/isolation interplay, and the richer display list module remains partially integrated.
- Root line strut still provides minimum line-height rather than full descendant baseline synthesis.
- Display-list renderer now accepts device-scale rendering: it allocates DPR-sized canvases and scales all geometry/text/filters before rasterization so the display-list path matches painter device outputs. A new constructor allows explicit scale; existing APIs stay CSS-pixel default.
- Stacking-context transforms in the display-list renderer now scale translation components with the device scale so DPR-rendered display lists position layers correctly; `renderer_respects_device_scale` covers the scaled output size and content.
- Display-list filters respect outsets when clipping rounded contexts: blur/drop-shadow layers expand by filter outsets and the clip grows accordingly, so filter glow is no longer chopped by border radii (covered by a new blur spill regression).
- Painter filters now expand clip masks by filter outsets (without inflating radii) and backdrop filters copy an outset-expanded region while clipping to the original radii, preventing blur/drop-shadow from being clipped by rounded stacking contexts; a new painter regression covers blur spill outside a rounded rect.
- Display-list filter clipping now mirrors the painter: the clip rect grows by filter outsets but radii stay unchanged, avoiding over-inflated masks while keeping blur/drop-shadow visible at rounded edges.

## To-do / next steps (spec-oriented)
1. Inline/text:
   - Build bidi-aware flattening of inline boxes so descendants reorder per UAX#9 while maintaining box edges/backgrounds; lift `unicode-bidi: plaintext` to paragraph-scoped handling.
   - Align baseline/line-height calculations with real font metrics across multi-font runs.
   - Harden RTL run positioning and visual reordering in painter/layout so mixed-direction text paints correctly.
2. Tables:
   - Finish CSS 2.1 auto table layout: full border-collapse model including per-segment conflict resolution, style-aware painting (dotted/dashed/double geometry), percent/fixed widths resolved per spec, correct colspan/rowspan distribution (including baseline handling for rowspans), and row height/baseline behavior under collapsed borders.
3. Replaced content:
   - Render images for `ReplacedType::Image` instead of placeholders.
4. General bidi:
   - Ensure visual ordering in layout and paint for RTL/mixed runs.
5. Inline blocks:
   - Generate proper anonymous inline wrappers; validate remaining percentage/min-height edge cases and baseline behavior in nested formatting contexts.
6. Lists/markers:
   - Implement ::marker property restrictions and inside positioning geometry; round out counter style coverage and marker inheritance edge cases.
7. Positioning:
   - Propagate positioned containing blocks through any remaining formatting contexts; derive static positions from hypothetical in-flow placement even when padding box height is unresolved.

## Notes
- Current table code uses `InlineFormattingContext` for cell intrinsic widths; this fails for block/table/replaced content—needs a per-context intrinsic measurement.
- Default font family remains `"serif"`; UA defaults can be revisited when baseline metrics are real.

## Remote branch (cursor/pixel-perfect-news-ycombinator-com-rendering-gpt-5.1-codex-high-b0ad) scan
- Block FC: buffers inline children and runs them through `InlineFormattingContext` as a group, with margin collapse handling. Better than placeholder inline fragments—worth adopting concept.
- Painter: introduces `FontContext` parameter to `paint_tree`/`Painter::new` and uses `TextShaper` + `TextRasterizer` (`shape_text_simple`) with guessed font size; still LTR-only and style-agnostic. We already have a more capable shaping pipeline; don’t regress, but sharing the font context between layout/paint is a good idea.
- Table: adds a simplistic cell-content layout by stacking child fragments or collected text; ignores padding/borders/inline flow—worse than current plan.
- Inline FC: minor guard for mandatory breaks past end-of-text.

Actionable borrowings:
- Integrate the block inline-buffering approach (layout inline groups via IFC, flush on block children).
- Consider passing a shared `FontContext` into paint_tree/painter so paint and layout use the same font state.
