# Scratchpad – rendering engine session notes

## Context
- Project: Rust HTML/CSS renderer (`fastrender`), sandboxed workspace-write; network restricted.
- Taffy is vendored in `vendor/taffy/` and must not be updated via Cargo.
- Goal: make the renderer spec-faithful (tables, text shaping, painting) and remove site-specific hacks.

## Recent changes (this branch)
- Floats/clear now flow through computed styles and block layout: floating boxes are taken out of normal flow, placed with the float context, obey `clear`, and contribute to the BFC height; inline formatting skips floating inline boxes for now. Parsing tests added for float/clear.
- Added `float`/`clear` to computed styles with parsing and regression coverage, so float metadata now flows through style resolution in preparation for a full float layout implementation.
- Inline intrinsic sizing in block formatting contexts now splits inline runs around intervening block-level children; min/max-content widths take the widest run rather than concatenating text across forced breaks, aligning shrink-to-fit math with anonymous block box generation.
- `visibility: collapse` now prunes table rows/columns from TableStructure, keeps source indices for mapping, trims spans, drops collapsed cells, and maps row/column backgrounds/borders using source→visible lookup; regressions cover collapsed rows and columns. Row/column group collapse is propagated to child tracks so entire groups vanish from layout and painting.
- Table column distributor leaves authored percentages intact even when they exceed available width, reporting over-constraints and honoring per-column mins/maxes; new regressions cover over-budget percentage pairs and min clamping under overflow.
- Inline bidi reordering now builds explicit embedding/isolate control streams from ancestor `unicode-bidi` settings, enforcing max explicit depth and closing contexts deterministically before running UAX#9 reordering for each paragraph of lines, reducing reliance on heuristic control sharing; dead helper pruned.
- Bidi control insertion now counts one embedding depth per context (rather than per control codepoint) so isolate-override’s dual controls still consume a single depth step, skips depth bumps when no controls are emitted, and shares the helper for box/leaf controls to keep paragraph text balanced.
- Paragraph base levels now downgrade to first-strong when any `unicode-bidi: plaintext` leaf or ancestor participates in the paragraph: plaintext detection happens during logical-text construction, the bidi base is set to `None` for those paragraphs only, and a regression covers mixed paragraphs where only the plaintext paragraph resets its base while others retain the authored base direction.
- Explicit embedding/isolate contexts that would exceed `MAX_EXPLICIT_DEPTH` are now ignored entirely (no placeholder stack entries), so overflowed contexts don’t skew stack-sharing or closers; the control helper returns None on overflow and callers skip pushing context metadata.
- Added regression to ensure over-depth isolate chains are ignored rather than skewing reordering: a nest deeper than `MAX_EXPLICIT_DEPTH` still reorders to the logical text without crashing or misordering.
- Unicode line/paragraph separators (NEL U+0085, LS U+2028, PS U+2029) now follow CSS Text segment-break handling: in `normal/nowrap` they collapse to spaces, in `pre-line` they emit mandatory breaks with space collapsing, and in `pre/pre-wrap/break-spaces` they produce forced breaks. Added unit coverage for normal, pre-line, and pre paths.
- `white-space: pre-line` now trims spaces/tabs before segment breaks so collapsible runs don’t leave a pre-break space; CRLF/LS/PS/NEL forced breaks drop preceding collapsible runs and retain only the line content with mandatory break offsets. Regression added.
- Trailing collapsible spaces in `pre-line` now behave like `normal`: trailing runs set `trailing_collapsible` instead of emitting a space, so pending spaces merge across text nodes and are dropped at block end; added regression for a trailing space and adjusted CRLF/LS/PS expectations.
- CSS `line-break` parses/inherits with support for `auto/loose/normal/strict/anywhere`; `line-break:anywhere` injects break opportunities at every cluster boundary so min-content sizing and line breaks can split long tokens without overflow, with a regression verifying long-word breaking.
- `line-break` now inherits through cascade, and `anywhere` runs add cluster-boundary breaks after shaping (without affecting nowrap). Cascade regression ensures inheritance.
- Table colspan distribution now prefers flexible columns: spanning-cell min/max growth first consumes headroom from flexible columns before inflating fixed/percent tracks, falling back to all columns only if necessary so fixed widths stay stable unless unavoidable.
- Added regression to lock the flexible-first spanning growth: a span over a fixed and a flexible column leaves the fixed min width unchanged while the flexible column absorbs the extra.
- Spanning percentage widths now propagate to the covered columns: percentage widths on colspan cells split evenly across the spanned columns, turning them into percentage tracks instead of treating the span as purely intrinsic. Added a regression for percentage splitting.
- Spanning percentage assignment now preserves authored fixed/percentage columns and only allocates the remaining percentage to auto columns in the span; if authored percentages already cover the target, constraints are left untouched, with regressions for authored+auto and fixed/percent-only spans.
- `word-break: break-word` now follows the spec alias to `overflow-wrap:anywhere`, injecting break opportunities at every character boundary and shrinking min-content widths accordingly; inline tests updated.
- Break-all/anywhere break opportunities now align to grapheme cluster boundaries via `unicode-segmentation` instead of per-scalar splits, so combining marks/ZWJ sequences remain intact; regression covers avoiding intra-grapheme breaks for both break-all and break-word.
- Break deduplication now preserves mandatory breaks when additional anywhere/break-all opportunities occur at the same byte offset, so forced breaks survive added emergency breakpoints; regression covers newline + break-word.
- Table row extra-height distribution now matches CSS expectations: rows start from their intrinsic/content minimums, and when the table has a definite height, only auto rows receive extra space (proportional to their current heights; percent/fixed rows stay at their targets), with regressions for proportional and fixed/percent cases.
- Percentage row heights now resolve against the table’s content box even in collapsed border model: outer table borders are subtracted from the base for percent rows so they size to the available content height instead of including collapsed border thickness.
- Table padding is now honored in collapsed border model for sizing: padding is resolved even when borders collapse, contributes to available content height for percentage rows, and inflates the overall table box; row/column offsets start after padding in collapsed tables.
- Added regression for collapsed tables with padding: specified table height stays intact while content is inset by padding, ensuring cell rows start after the padding top.
- Column percentage widths now normalize when their sum exceeds 100%, scaling proportionally to stay within the table’s percentage budget; regression ensures over-100% columns are renormalized.
- Absolute/fixed offsets now resolve `em`/`ex`/`ch` using actual font metrics and `font-size-adjust`: AbsoluteLayout carries a FontContext, offset resolution uses metric-aware helpers, and regressions cover ex-based offsets and adjust scaling; PositionedStyle builder exposes `font-size-adjust` and defaults stay intact.
- Relative/sticky offsets now reuse the metric-aware resolver: PositionedLayout carries a FontContext, sticky constraints resolve through font metrics/size-adjust, and relative/absolute helpers use the same path so all positioned flows honor em/ex/ch accurately.
- Added regressions for positioned offsets with font metrics and font-size-adjust in relative and sticky cases to lock the metric-aware behavior.
- Flex and grid formatting contexts now resolve viewport-relative units using the actual viewport during Taffy conversion: contexts store a viewport size, the factory wires it through, and gaps/padding/margins/borders/flex-basis/grid tracks resolve vw/vh/vmin/vmax via the viewport instead of falling back to font-relative px.
- Viewport-relative units now resolve against the actual viewport/initial containing block instead of the local percentage base: the formatting-context factory carries the viewport size from `LayoutConfig`, block/inline contexts store it and pass it into length resolution, and replaced-element sizing uses viewport dimensions for vw/vh/vmin/vmax. Detached contexts default to an 800×600 viewport, and the viewport padding regression now asserts vw/vmin resolve to viewport size.
- Positioning offsets (relative/absolute/fixed/sticky) now resolve vw/vh/vmin/vmax against the viewport size instead of font-relative fallbacks: containing blocks carry an explicit viewport size, offset resolution handles viewport units, and positioning tests now cover viewport-based offsets.
- Font-relative and percentage lengths in layout now resolve against the element font size and the root font size for `rem` across block/inline sizing, padding/borders, margins, replaced sizing, and positioned offsets; root font size is propagated from the computed root element. Offset resolution now honors em/rem instead of dropping to 0, and a regression covers em/rem padding resolution.
- PositionedStyle now carries `root_font_size` so positioned layout can resolve rem/em offsets consistently with computed styles.
- Letter/word spacing now parse `normal`, resolve font-relative units/em/rem/ex/ch and percentages (word-spacing) against the element font size/root size, instead of ignoring relative units or leaving inherited values. Added regression covering normal reset, em resolution, percentage word spacing, and negative values.
- `text-transform` now follows the Level 3 grammar: a structured case transform plus optional `full-width` and `full-size-kana` flags. Transforms apply in spec order (case → full-width → full-size-kana); small kana (hiragana, katakana, halfwidth, phonetic extensions) expand to full-size forms, and full-width still widens via Unicode `<wide>/<narrow>` mappings with preserved-space handling. New regressions cover space behavior, halfwidth ordering, and small-kana expansion.
- `text-transform: capitalize` now uses Unicode word boundaries and uppercases the first codepoint in each word (via word-bound splits), instead of whitespace-only detection; mid-word punctuation/apostrophes follow UAX#29 so foo.bar stays one word while word starts still capitalize. Added tests for apostrophe handling, punctuation boundaries, and multi-letter uppercase glyphs.
- Non-image replaced elements (video/iframe/embed/object/canvas) now render a UA placeholder instead of an empty gray box: both painter and display list paths draw a labeled placeholder rectangle keyed to the replaced type so absent resources are still visible.
- Added regression covering SVG data URLs so the image cache decodes inline data for replaced content instead of silently falling back to placeholders.
- Display-list clipping builder now respects `visibility` like the painter: hidden fragments short-circuit before pushing clips/content, with a regression to lock the behavior.
- `font-synthesis` parses/inherits and controls synthetic small-caps: the shorthand resets to the initial (weight+style+small-caps), and synthetic small-caps are suppressed when authors disable the small-caps flag; a pipeline regression guards the non-synthetic path.
- `font-synthesis` now controls weight/style synthesis too: computed styles carry weight/style flags and the shorthand resets them, shaping only synthesizes bold/oblique when allowed, and `FontRun`/display list/text items propagate synthetic stroke/shear so the canvas/rasterizer can render synthetic bold/oblique when faces are missing (tests cover parsing, shaping, and rasterization).
- `font-size-adjust` parses/inherits (`none` | `<number>` | `from-font`), is reset by the `font` shorthand, and drives x-height-aware sizing: preferred aspects come from the authored value or the first available font, used font sizes scale per font during shaping (synthetic bold thickness scales too), and strut metrics use the adjusted size so layout and paint stay aligned. New regressions cover parsing and adjusted font sizes.
- Inline layout now resolves font-relative lengths (`em`/`ex`/`ch`) from actual font metrics and the adjusted used font size: ex pulls the scaled x-height, ch measures the “0” advance from the chosen font, and font-size-adjust influences the used size; inline padding/borders/markers/tabs/text-indent use these metric-aware values instead of fixed 0.5em fallbacks.
- Block layout now uses the same metric-aware font-relative resolution: padding/borders/margins and intrinsic widths resolve em/ex/ch against the selected font with font-size-adjust applied, and tests cover ex/ch correctness and adjustment scaling via a shared resolver in `layout::utils`.
- `text-transform: full-width` now maps characters using the Unicode `<wide>/<narrow>` compatibility decompositions (ASCII, currency, halfwidth kana/Hangul, arrows/box symbols, etc.). Spaces widen only when the white-space mode preserves them (pre/pre-wrap/break-spaces), matching the CSS Text transform ordering; new regressions cover collapsed vs preserved spaces and halfwidth katakana.
- Removed duplicated `overflow`/`overflow-x`/`overflow-y` parsing arms to silence unreachable-pattern warnings while keeping clip keyword handling intact.
- `text-underline-position` now parses/inherits (auto/from-font/under/left/right combinations), handles space-separated inline values, propagates with decorations, and the painter respects it by pushing underlines below descenders when authored; regression covers parsing, inheritance, and paint positioning.
- `text-underline-offset` now inherits per spec so descendant underlines default to ancestor offsets; cascade regression added alongside the underline-position coverage.
- CSS text emphasis added: `text-emphasis-style`/`color`/`position` parse/inherit (string or filled/open dot/circle/double-circle/triangle/sesame), shorthand is supported, and painter renders emphasis marks per glyph above/below text using currentColor fallback; regressions cover parsing, inheritance, and paint placement.
- Display-list path now carries text emphasis: Text items include emphasis metadata, the builder resolves mark positions/colors and shapes string marks, and the renderer paints emphasis marks/shaped strings so display list output matches painter. Added renderer regression for emphasis mark placement.
- `text-decoration-skip-ink` now parses to computed styles, inherits, and painter builds underline segments by subtracting glyph bounding boxes from the decoration band so descenders stay unpainted; regression compares decoration vs text color to ensure skip-ink gaps, and underline offset test warning cleared.
- Text decorations now propagate per spec instead of being confined to the element that declares them: cascade accumulates ancestor decorations unless an explicit `text-decoration: none` clears them, descendants can add additional lines, and the painter renders all propagated decorations with their own style/color/thickness/offset/skip-ink settings. Added cascade regressions for propagation, suppression, and additive decoration.
- `text-decoration-skip-ink` accepts the spec `all` keyword and treats it like auto (carving out underline segments wherever glyph ink intersects); painter/propagation support and a regression cover the behavior.
- Skip-ink carving now inflates glyph bounds by a small 0.5px tolerance instead of scaling with line thickness, and when exclusions would erase the line entirely we fall back to a single full-span segment so decorations still render; regressions cover both descender carving and `skip-ink: all` parity with auto.
- Table captions are now spec-compliant: `caption-side` parses/inherits (default `top`), `<caption>` defaults to `display: table-caption`, and table layout wraps the table box with a wrapper that positions captions above/below the table while keeping backgrounds/borders on the table box only. Caption width follows the table width and new regressions lock top/bottom placement.
- `empty-cells` parses/inherits (default `show`); when set to `hide`, empty cells with transparent backgrounds drop their borders in both separate and collapsed border models. Collapsed border resolution skips hidden empty cells, and cell fragments zero out borders/background when hidden; regressions cover both models.
- Table cell intrinsic widths no longer double-count padding/borders: intrinsic measurement strips padding/borders before sizing content and then adds edges once. Regression locks a padded fixed-width child at min-content 70px (50px content + 10px padding on each side).
- Table row and row-group background fragments are only emitted when they actually paint (background color/image, non-hidden borders with width, or box-shadows) to avoid inflating fragment counts and mispositioning cells when rows are visually empty.
- Column-group and column backgrounds now paint as dedicated fragments before rows/cells: colgroups span their covered columns, columns use their own styles, collapse/separate spacing is respected, and empty styles are filtered out. Regression asserts paint order and presence.
- Table decoration fragments strip borders for columns/column-groups/rows/row-groups before painting so column/row borders don’t render in separate border model or double-paint in collapsed. Gating now ignores borders when deciding whether to emit these fragments. Regression updated to ensure column borders are removed.
- `visibility` property now parses/inherits (visible/hidden/collapse) and painter/display-list/stacking builders skip hidden/collapsed fragments; regressions cover hidden/collapse paint suppression and display-list omission.
- `outline` longhands/shorthand parse/inherit: defaults invert/medium/none (shorthand resets to initial), supports `outline-style: auto` (paints solid) and `outline-color: invert` (painted via difference blend); negative widths ignored. Painter/display list emit outline strokes outside the border box using offset + half-width expansion; regressions cover paint, display-list emission, shorthand reset, currentColor fallback, and invert handling.
- Display list strokes now carry blend modes so outline invert can render as Difference; renderer and canvas support per-stroke blend overrides, stroke helpers/tests/benches updated.
- Outlines are no longer clipped by overflow/clip boxes: stacking bounds don’t clamp to overflow clips, outlines stay in the unclipped paint bucket, and build_with_clips emits outlines after pop_clip so they sit outside clipping. Added regressions for overflow-hidden outlines and clipped display-list builds.
- Stacking-context bounds now clip non-outline content to overflow clip axes while still letting outlines extend outside; layer bounding boxes stay tight for clipped content but preserve outline overflow. Regression updated.
- `box-sizing` now parses (`content-box`/`border-box`) and defaults to content-box; width/height/min/max resolve against the correct box in block layout, inline-block shrink-to-fit, replaced sizing, and positioned/absolute layout. Border-box widths subtract padding/borders from content, and new regressions cover block widths and replaced sizing under border-box.
- Flex/grid wrappers now honor `box-sizing: border-box` when feeding Taffy: absolute width/height/min/max lengths are converted to content-box lengths before padding/border are added, keeping border-box sizing consistent for flex/grid items. Added flex and grid regressions to assert border-box items retain their authored outer widths.
- CSS `overflow` now accepts the spec `clip` keyword; parsing sets overflow-x/y to Clip and the painter/stacking context logic treats it like a non-scrollable clip. Added stacking and parsing regressions to cover overflow: clip.
- `font-variant-alternates` now parses/inherits (historical-forms, stylistic/ styleset/ character-variant sets, swash, ornaments, annotation), resets via `font` shorthand, and maps to OpenType features (`hist`, `ssXX`, `cvXX`, `swsh`, `ornm`) during feature collection; regression added for alternates emission.
- Small-caps shaping now prefers native OpenType features when available (`smcp`/`c2sc` via font_db::font_has_feature), synthesizing only when the chosen face lacks them (covers all-small-caps too).
- `font-variant-east-asian` now parses/inherits (jis78/83/90/04, simplified/traditional, proportional/full-width, ruby), maps to OpenType toggles (`jp78/jp83/jp90/jp04/smpl/trad/fwid/pwid/ruby`), and resets via `font` shorthand alongside ligatures/numeric/kerning/feature overrides.
- `text-shadow` paints from computed styles: offsets/blur resolve relative lengths, shadows rasterize from glyph outlines before the fill, and a painter regression checks horizontal offsets render separate colored shadows.
- Display list path now carries resolved text shadows on `TextItem`, the renderer rasterizes shadows from glyph outlines (respecting opacity/transform/clip), and new display-list tests assert shadow offsets alongside the painter coverage.
- `text-underline-offset` parses (auto | length | percent), is stored on computed styles, and painter applies it to underline positioning (positive offsets push the line farther from the text). Added a regression asserting offsets move the underline by the authored length.
- Shaping collects OpenType features from computed styles, applies ligature defaults, and maps numeric/east-asian variants plus kerning into feature tags; `font-feature-settings` still overrides. New regressions cover numeric+EA feature emission.
- `font-variant-numeric` and `font-kerning` now parse/inherit and map to OpenType features: numeric figure/spacing/fraction variants drive `lnum/onum`, `pnum/tnum`, `frac/afrc`, plus `ordn`/`zero`, and kerning toggles `kern` (auto leaves defaults). `font` shorthand resets numeric, ligatures, kerning, and custom feature overrides.
- Shaping collects OpenType features from computed styles, applies ligature defaults, and lets `font-feature-settings` override/disable them; features flow through `FontRun` into HarfBuzz shaping and are covered by a regression.
- Line-height normal now uses actual font metrics when available: inline strut/text/replaced/inline-block computations pull scaled metrics from the shared FontContext and compute line-height from the font’s ascent/descent/line-gap instead of a hardcoded 1.2× font size. Added regression for metric-aware normal line-height.
- Painter and display-list builder now resolve scaled font metrics for alt text and compute line-height from those metrics, keeping fallback text alignment consistent with layout metrics instead of the 1.2× heuristic.
- API alt intrinsic sizing uses the same metric-aware line height, so alt-driven intrinsic sizes/aspect ratios align with layout/painter metrics.
- `font-variant-caps` parses/inherits (small/all-small/petite/all-petite/unicase/titling), is stored in computed styles, reset by `font` shorthand, and maps to OpenType features (`smcp/c2sc`, `pcap/c2pc`, `unic`, `titl`). Collect-opentype-features regression added, and synthetic small-caps now treats all-small-caps by scaling uppercase too.
- `font-variant-ligatures` now parses/inherits and maps to OpenType toggles (`liga`/`clig`/`dlig`/`hlig`/`calt`), `font-feature-settings` parses comma-separated tags with on/off/numeric values (rejects malformed tags), and `font` shorthand resets ligatures/feature overrides to initial.
- Shaping collects OpenType features from computed styles, applies ligature defaults, and lets `font-feature-settings` override/disable them; features flow through `FontRun` into HarfBuzz shaping and are covered by a regression.
- `font-weight` relative keywords now resolve against the parent per CSS Fonts 4's table (100/400/700/900 breakpoints), numeric weights are clamped to the valid 1-1000 range during cascade, and out-of-range values are ignored; cascade/pseudo paths resolve weights before inheritance is used downstream and new regressions lock the mapping.
- `font` shorthand now parses font-style/weight/size/line-height/family (with absolute/relative size keywords and line-height percentages), rejects missing family, and line-height percentages resolve to multipliers in both shorthand and longhand.
- `font-stretch` is parsed (keywords + percentages, clamped 50-200%), inherited, stored in computed styles, carried through font selection (painter, display list, inline struts), and respected by font shorthand; shaping now requests fonts with stretch via FontContext.
- `font-size` longhand now accepts CSS keywords, percentages, and em/rem (relative to parent/root), matching shorthand behavior and covered by regressions.
- `font-style: oblique <angle>` is parsed (angle optional), stored in computed styles, handled in font resolution, and supported in font shorthand; UA defaults for `i/em` switch to oblique(None).
- `font-variant: small-caps` is parsed/inherited and handled in font shorthand; shaping synthesizes small caps by uppercasing lowercase letters and scaling their font size to 80% while leaving uppercase at full size, with regression covering split run sizing.
- Rowspan height distribution now allocates spanning overflow to auto rows first (falling back to even splits), keeping fixed/percent rows stable; baseline reservation for spanning cells is clamped to the first row’s share to avoid monopolizing height, and a regression asserts rowspans leave later rows with real height in the full layout pipeline.
- Rowspan distribution now considers row floors (content + fixed/percent targets when definite) before deciding how much extra to spread, avoiding over-allocation when some rows already satisfy the span. Legacy row-height calculator got the same floor-aware, auto-preferred distribution plus regressions for fixed/percent rows.
- Inline RTL placement now positions visual fragments from the right edge using the resolved paragraph direction, so start/end alignment and indentation respect RTL flow; added regression for multi-fragment RTL lines.
- Replaced media without explicit dimensions now pick HTML default intrinsics (300×150, 2:1 ratio) for canvas/video/iframe so layout has a definite size when authors omit width/height; generation tests cover the defaults.
- Embed/object replaced elements now use dedicated types, preserve src/data, and also default to 300×150 with 2:1 aspect ratio when no intrinsic dimensions are provided.
- Embed/object (and iframe/video sources when image-like) now render actual image/SVG content through the shared ImageCache in both painter and display-list paths, with regressions covering inline-SVG embed/object decoding and paint.
- Embed/object/iframe intrinsic sizes now probe their data/src (including inline SVG) via ImageCache so layout picks correct intrinsic dimensions/aspect ratios instead of falling back to the 300×150 default when resources are resolvable; added intrinsic sizing regressions.
- Bidi analysis now keys levels by character, not byte offsets, preventing multi-byte text from misclassifying levels; unicode-bidi overrides force all characters to the element direction and skip reordering. Added tests for char-index handling and overrides.
- `unicode-bidi: plaintext` in the shaping pipeline now derives the paragraph base direction from first-strong content instead of always using the element direction, keeping shaping in sync with layout’s plaintext handling.
- Inline bidi reorder now tracks opened/closed embedding controls with a stack when constructing the logical text to reduce control leakage across nested inline boxes.
- Added regression for nested isolates and tightened control stack handling during inline bidi flattening to keep embeddings balanced.
- Bidi analyzer now keys levels to character starts (not byte slices), so multi-byte codepoints map to correct levels in the standalone text::bidi path as well; base handling unchanged.
- Inline bidi flattening now keeps embedding closers aligned to the active box stack (opens on entry, closes on exit) so isolates no longer close after each leaf; isolates tests restored.
- Inline bidi control emission now clamps to the Unicode max explicit depth, skipping additional embedding/isolating controls once the limit is hit, with a regression covering excessively deep inline stacks.
- Inline bidi context tracking now skips closing controls for contexts that emitted none (e.g., when depth-limited), preventing unbalanced control sequences during paragraph flattening.
- Inline bidi flattening now avoids pushing stack frames when both opens/closes are suppressed, and skips empty leaf wrappers, so the logical text stays minimal when controls are elided.
- Paragraph direction now resolves from first-strong content for `unicode-bidi: plaintext`: line records carry the resolved bidi base direction from UAX#9, start/end alignment and text-indent mapping use the per-line direction, and plaintext blocks align to RTL/LTR starts per their content. Tests cover RTL/LTR plaintext alignment.
- `unicode-bidi: plaintext` now wraps content with FSI/PDI isolates so paragraph base directions stay stable while plaintext spans choose their own first-strong direction; bidi control insertion always runs so isolates/embeds for other runs aren’t dropped, and a regression guards plaintext isolates not flipping the paragraph.
- Canvas now maintains clip masks (including rounded radii) and applies them to all primitives/text; display list renderer uses the clip radii, keeps transforms scoped with save/restore, avoids shrinking images to the clip rect, and has a regression for transform stacking plus clip-mask coverage in Canvas tests.
- `<img>` alt text now flows through the pipeline: ReplacedType::Image carries alt, intrinsic sizing falls back to shaped alt text when image loading fails/`src` is empty, and painter renders alt text instead of the gray placeholder. Tests cover both sizing and paint fallback.
- Display list builder now shapes text with the shared font context (using existing shaped runs when present) and emits alt text when images fail instead of gray placeholders, so display-list output matches painter fallback semantics.
- Display list text items now preserve font identity per shaped run (family/weight/style) and emit one item per run with correct bidi-aware glyph offsets; glyphs inherit the run’s direction/advance instead of flattening to a single anonymous font.
- Display list renderer grows feature coverage: respects linear/radial gradients via tiny-skia shaders, uses the canvas’ current blend mode for image/gradient draws, and clips gradients through the mask-aware Canvas path; regression tests cover transforms scoping and basic gradient rendering.
- Display list renderer now draws box shadows via the rasterizer (honoring opacity/blend/clip) and scopes stacking contexts through save/restore so nested clips don’t leak; added regressions for shadows and clip restoration.
- CSS gradients (linear/radial) now parse through the CSS value parser and paint as background images in the main painter, including stop normalization and clip-radius masking; gradient parsing/paint regressions added.
- Repeating gradients parsed and painted: repeating-linear/radial-gradient now map to background images, using repeat spread in the painter; parsing and paint regressions added.
- Display list gradients carry spread modes (pad/repeat/reflect) and the renderer maps them to tiny-skia; tests updated to set spreads and cover repeating linear gradients. Background cover offset test now matches the spec default `background-position: 0% 0%`.
- Background-repeat now supports the full grammar (repeat/space/round/no-repeat pairs): parsing builds per-axis keywords, painter rounds tile sizes for `round`, spaces tiles for `space` (first/last touch edges, background-position only when a single tile fits), and repeats patterns into the paint area. Added tiling helpers/tests for space and round.
- Added parsing coverage for background-repeat keywords/pairs to ensure style application maps shorthands and pair syntax correctly.
- `list-style-image` is parsed/inherited, resets via shorthand, and markers now carry either text or image content. Marker boxes load intrinsic sizes through the image cache, and inline layout positions image markers with outside/inside semantics (outside markers paint with negative offsets, inside markers consume a 0.5em gap). Box/debug printers and tests updated accordingly.
- Inline replaced elements now honor padding/borders in their inline box dimensions: layout accounts for padding/border in advance/width, marker images inherit the larger box, and inline fragment positions respect margins; added regression to guard inline replaced sizing.
- Bidi reordering now runs at paragraph scope: line builder aggregates paragraph text, feeds paragraph-level BidiInfo into each line, and preserves explicit embeddings across soft wraps. Added regression for unclosed RTL embeddings spanning lines.
- Table colspans now water-fill minimum widths: spanning cells first consume per-column headroom up to max widths, then grow all spanned columns evenly if needed; max widths expand evenly when spans exceed current sums. This keeps colspan constraints from unfairly flattening flexible columns.
- Colspan max expansion now favors columns with available headroom before falling back to even splits, so spanning cells don’t inflate already-tight columns unnecessarily; regression added for headroom-aware max distribution.
- Colspan width attributes (including percent when a base exists) now participate in column constraint construction even for multi-column cells: specified widths raise the spanned columns’ min/max targets before distribution, and a regression covers fixed-width spanners increasing column minima.
- Background-attachment parsed and respected: scroll/fixed/local stored in computed styles, and painter positions backgrounds relative to the viewport for `fixed` while clipping to the element. Gradients now use the positioning area separately from the paint area. Added regression covering fixed anchoring.
- `background-attachment: local` now anchors images to the scrollable overflow area (padding box) and treats `background-clip: border-box` like padding-box for scroll containers; clipping radii follow the adjusted box. Regression ensures border areas stay clear while padding paints.
- Background-size matches the CSS grammar: per-axis components accept length/percent/auto, single values default the second to auto, and cover/contain remain keywords. Painter resolves mixed auto/length pairs using intrinsic size/ratio (falling back to 100% when none) and rounding now checks explicit auto-auto. Parsing and paint regressions added.
- Background-position supports offset keywords per Images 3 syntax: components store alignment + offset, parse four-value forms like `right 10px top 25%` (with end offsets negated), default the missing axis to center, and painter resolves offsets against the available positioning area minus image size. Regression added for offsets/defaults.
- Background shorthand now resets all background fields to their initial values when set (including `none` and gradient/color shorthands) so stale repeat/position/size/attachment/origin/clip state doesn’t leak across declarations; regression covers reset.
- Background shorthand regression updated to expect authored repeat keywords (e.g. `no-repeat`) rather than default repeat after reset.
- Background shorthand now handles single-value forms (e.g. `background: red` or `background: none`) while still resetting all other background fields to their initial values.
- Background initial position now matches the spec default (0% 0% instead of center).
- Text decoration now matches CSS Text Decoration: line/style/color longhands are parsed, the shorthand resets unspecified parts, currentColor is honored, and painter draws solid/double/dotted/dashed/wavy lines with per-line positions.
- Text-decoration thickness is supported: longhand and shorthand accept lengths/keywords, defaulting to auto/from-font when unspecified; painter resolves authored thickness (including font/viewport-relative units) for underline/overline/line-through.
- list-style properties parsed and reset via shorthand (type/position), defaulting to `disc outside`.
- CSS counters parsed (`counter-reset`, `counter-increment`, `counter-set`), default list counters are scoped with CounterManager (default reset on `ol/ul`, default increment on `list-item` unless overridden), list markers format from counter values, and `lower-greek` is supported.
- List markers are dedicated marker boxes: markers no longer consume inline width when `list-style-position: outside`, paint from a negative offset to sit left of the content, and a regression checks marker/text positioning.
- Marker offsets use resolved marker margins (defaulting to 0.5em) and respect direction for outside positioning (RTL pushes markers right of the text start).
- Marker text ignores `text-transform` (styled from list-style type only) and skips hyphenation/breaking logic to stay atomic.
- ::marker pseudo support wired into cascade/box generation: selector parsing handles `::marker`, marker styles inherit list-style values with box-model resets, counter properties run during styled box generation, and marker boxes use pseudo `content` when provided. List-style now inherits, and styled pipeline uses counters for numbering. Added tests for list-style inheritance and marker styling.
- ::marker property restrictions tightened: marker styles are forced inline, box-model/layout effects are reset, and inline styles still inherit text properties; regression ensures authored display/padding/margins/background on ::marker are neutralized.
- ::marker text-transform forced to none in cascade to keep marker glyphs unaltered even if authors set transforms on the pseudo or list item; regression covers transform neutrality.
- Stacking-context display list path no longer double-emits descendants: stacking-context roots paint shallowly, child layers inherit the context origin for offsets, and stacking-tree construction keeps only direct children in layers while hoisting nested stacking contexts.
- Replaced content paints inside the content box: canvas images/SVGs now respect padding/border space during painting, dynamic images convert to premultiplied RGBA instead of BGRA to avoid channel swapping, and a regression covers padding isolation for replaced elements.
- Overflow clipping now applies in paint: stacking contexts generated for overflow hidden/scroll/auto clip descendants to the padding box with radius-aware masks and a hard pixel clip (prevents filter bleed); backgrounds/borders are left unclipped, and partial-axis overflow (x hidden / y visible) keeps visible axis unmasked. Regression updated accordingly.
 - Added per-axis overflow clipping regression for `overflow-y: hidden` with horizontal overflow visible; painter respects axis-specific clipping.
- Stacking-context bounds now include transforms and filter/backdrop outsets, and layer offsets come from the visual bounds so translated/rotated children aren't clipped by ancestor offscreen buffers. Added regression to ensure transformed children remain visible through parent stacking contexts.
- Overflow clips now shrink stacking-context layer bounds before filters/backdrop filters are applied: descendant bounds are intersected with the authored clip axes while keeping the root background/border uncut, preventing massive offscreen buffers and backdrop sampling beyond the padding box. Regression added to guard clipped bounds.
- Table row heights now honor row `height` (px/em/%): row-specified lengths become minimums, percentage rows resolve against a definite table height, and tables with `height`/`min-height` stretch rows to meet that target. New tests cover specified table height and percentage row heights with a definite table height.
- Table `max-height` now clamps the table’s used height (rows may overflow), ensuring bounding boxes respect author caps; regression added.
- Percentage row heights now resolve against the table height minus border-spacing gaps in separate border model, so row percent shares exclude spacing and spacing consumes its own slice of the table height. Added regression for percentage rows with vertical spacing.
- Row `min-height`/`max-height` are honored (px/em/%): author constraints are applied per row with percent bases tied to the table’s definite height (minus spacing), and row heights are clamped accordingly.
- Row percentage heights now resolve only when the table height is definite (specified height or containing block height); table `min-height` alone no longer triggers percentage resolution. Added regression for percent rows with only min-height.
- Percent rows now clamp to their target percent share when a definite table height exists (after subtracting spacing), so percentage rows are guaranteed their authored share instead of relying on later distribution. Regression still covers spacing/min-height behaviors.
- Specified table height now drives the used table height (clamped by min/max) rather than collapsing to content when provided.
- Percent rows fill the remaining height when mixed with auto rows: any leftover space after percent targets is distributed to non-percent rows (falling back to percent rows if needed), ensuring the sum of row heights matches the table height.
- Row distribution no longer shrinks rows below their laid-out content: percent/auto scaling is clamped to content-driven minimums so over-100% percentage mixes don’t overlap cells. Added regression `percent_rows_overflow_do_not_shrink_content`.
- Percent rows that total more than 100% are no longer scaled down to the table height; they keep their targets (respecting content minima) even if that overflows the specified height. Regression `percent_rows_over_100_percent_do_not_scale_down` covers the over-100% case with empty rows.
- Table boxes now honor padding and borders in separate border model: children are offset by padding+border, total bounds include those edges, and percentage row bases remain the content box. Collapsed tables still ignore padding per CSS 2.1. Regressions cover padding offsets and border expansion of bounds.
- Percentage row bases now exclude padding/borders and spacing (content box) when the table height is definite, keeping author percentages tied to the usable content height while the specified height remains a border-box.
- Column widths now subtract padding/borders from the available content width in the separated border model, intrinsic widths add padding/border edges, and when a definite table width is present (auto layout) flexible columns expand to fill the remaining content width after spacing/edges. Column distributor behavior for standalone use stays capped at max widths.
- Legacy `calculate_row_heights` now honors percentage/fixed row heights when an available height is provided, distributes remaining space to auto rows, and spreads rowspan contributions; added a percent-height regression for the legacy path.
- Cell baseline fallback now uses the bottom border edge when no text/line is present, ensuring empty cells still provide a baseline for row alignment; collapsed-spacing tests also cover legacy row-height distribution.
- Display list builder now decodes replaced images using `ImageCache` (including inline SVG), falling back to a placeholder only when decoding fails. Added regression for inline SVG decoding in the display list path.
- Display list builder now applies `object-fit/object-position` to image/SVG display items, using the same sizing semantics as paint. SVG sources (`ReplacedType::Svg`) are rasterized through the image cache too, so inline SVGs reach the display list with correct fitting. Added regression for contain centering.
- Object-position percentages in the display list builder now resolve as stored fractions (no double `/100`) and length-based components honor percentage resolution helpers; keyword handling uses the shared `PositionKeyword`.
- Object-fit/object-position math is centralized in `paint::object_fit` and alignment space is no longer clamped to zero, so oversized images can align with negative offsets; both painter and display list share the helper and tests cover overflow alignment/percent positioning.
- Default object-position now lives in the shared helper and display list falls back to CSS initial values when a fragment lacks style, keeping painter/display list defaults aligned.
- Object-position length components now resolve font-relative units using the element font-size (via shared helper), and helpers accept viewport size when available; painter supplies viewport/pixmap size while display-list builder degrades gracefully without one.
- Display list builder can now take a viewport size so `vw`/`vh` in object-position resolve per CSS Values; added regression to confirm viewport-relative alignment through the display list path and shared helper coverage for viewport units.
- Anonymous fixup now splits inline boxes that contain block-level descendants so the blocks participate in the parent's block flow; inline fragments keep their styles, replaced elements with inline display stay inline-level in the fixup checks, and regressions cover inline/block descendants and inline-block immunity.
- `text-indent` now matches CSS Text semantics: hanging no longer indents the first line (even with `each-line`), subsequent lines shift by the indent, intrinsic inline-size accounting matches the layout behavior, and regressions cover hanging/each-line combinations and hanging intrinsic widths.
- Negative `text-indent` no longer expands the available line width; line breaking now attempts to split breakable items even on empty lines (choosing the earliest break when none fit), preventing over-wide first items from swallowing following words. Regression added.
- Replaced SVGs now rasterize via resvg for both inline content and URL/data sources: painter draws SVGs with `object-fit/object-position`, and intrinsic sizes/aspect ratios are populated from rendered SVGs. Inline SVG rendering and intrinsic resolution are covered by new tests.
- Image loader now decodes SVG files/HTTP responses by MIME/extension/sniffing `<svg` text so external SVGs no longer fail rasterization; `ImageCache::render_svg_to_image` is public for reuse, and loaders/tests cover inline SVG rendering and intrinsic resolution via `FastRender`.
- `text-align-last` now applies per paragraph (forced breaks/newlines): the last line before a hard break uses `text-align-last`, not only the final line of the block. Regression added.
- `text-align-last: justify` now falls back to start when a line/paragraph has no justification opportunities (no spaces/clusters to expand), preventing over-justifying single-word lines while keeping paragraph-aware last-line handling.
- `text-align: justify-all` is parsed to justify all lines (including the last via `text-align-last: justify`), justification opportunity checks now probe split text items (so single text nodes with spaces still justify), and inter-word justification falls back to explicit space boundaries when the break finder misses them.
- `text-align: match-parent` is supported: parsing produces a match-parent value that resolves at cascade time to left/right based on the parent’s direction, and inline layout tests cover RTL inheritance.
- `text-align-all` shorthand supported: parsed values map to text-align, reset `text-align-last` to auto for non-justify-all/match-parent cases, and justify-all sets last-line justification.
- `match-parent` resolution now follows CSS Text: resolves to start/end based on parent direction (not left/right).
- `text-align` shorthand now resets `text-align-last` to auto (except justify-all → justify), with cascade tests validating reset/justify-all behavior.
- `match-parent` now inherits parent alignment fully (including non-start/end values) and maps start/end to physical alignment using the parent’s direction; cascade tests cover both inheritance and directional mapping.
- Image cache now keys entries by resolved URLs, preventing duplicate fetches when base URL resolution changes the concrete request.
- Collapsed-border conflict resolution now has added regression coverage for style precedence (double vs lower styles) and top-edge bias; CJK auto-justify test explicitly sets `text-align-last: justify` so forced breaks still justify under paragraph-aware last-line handling.
- Added regression to ensure justify-last fallback for space-less lines; paragraph-aware alignment remains intact.
- Collapsing border conflict resolution now follows CSS 2.1 ordering (hidden suppression, width before style ranking, cell/row/col/table precedence, and left/top bias honoring `direction`), with new coverage for width-vs-style and LTR/RTL tie cases.
- `tab-size` is parsed/inherited (number or length, default 8); preserved tabs (`white-space: pre/pre-wrap`) become explicit tab items that advance to the next stop based on the space advance or length, participate in bidi/script analysis, and have regression coverage for parsing/preservation/stop alignment.
- CRLF pairs are normalized to single segment breaks across whitespace modes: pre/pre-wrap emit one mandatory break per CRLF, pre-line keeps one hard break with collapsed whitespace, and normal/nowrap treat CRLF as a single collapsible space. Tests cover the CRLF handling for pre/pre-line.
- Segment breaks now cover VT/FF too: pre/pre-wrap emit mandatory breaks for form-feed/vertical tab, pre-line and normal/nowrap treat them as collapsible whitespace. Added regressions for FF in pre and VT collapsing in normal.
- `normalize_text_for_white_space` now returns a struct with normalized text, forced breaks, soft-wrap eligibility, and leading/trailing collapsible flags (CR/LF/VT/FF-aware). IFC callers/tests updated; edge flags are ready for cross-node whitespace collapsing.
- Collapsible whitespace between adjacent inline/text boxes now survives DOM splits: trailing collapsible runs are carried as pending spaces, realized before the next inline item (including inline boxes/replaced/inline-block), and dropped at line end. Tests cover text-to-text, text-to-inline box, and trailing suppression.
- Added `white-space: break-spaces`: parsed and normalized to preserve all spaces/tabs, emit mandatory breaks for CR/LF/VT/FF, allow wrapping, and avoid collapsible flags so sequences persist. Parsing test + normalization regression added.
- Refined `word-break: break-word` and `overflow-wrap: break-word`: removed eager per-character breaks from default opportunities, keep min-content sizing unchanged, and add emergency character-boundary fallback only when a token overflows and wrapping is allowed. Tests cover overflow splitting, nowrap suppression, and min-content parity for both properties.
- Column span constraints distribute minimums using existing headroom (max-min) before evenly inflating all spanned columns; max constraints inflate evenly. New tests cover headroom-preferred splits and no-headroom fallback (`src/layout/contexts/table/column_distribution.rs`).
- Rowspan height distribution now uses weighted expansion (preferring existing row heights/baseline requirements) instead of equal splits, and baseline-aligned spanning cells reserve their baseline offset in the first row so baseline positioning has room (`src/layout/table.rs`).
- Auto table distribution now preserves min-content when over-constrained: available < total min keeps min widths and flags overflow. Percentage columns shrink (but not below their min) when fixed+percent would starve flexible columns, leaving room for flexible mins; percent columns still honor their mins if that means over-constraint. Added targeted tests for both behaviors (`src/layout/contexts/table/column_distribution.rs`).
- Percentage-only tables over 100% now scale percents proportionally (respecting min/max) when no flexible columns exist; if mins alone over-constrain, we keep them and expose overflow. Added tests for over-100% percent tables with/without min over-constraint (`src/layout/contexts/table/column_distribution.rs`).
- Over-constraint integration tests now expect min widths to be preserved (no proportional scaling) with explicit overflow reporting; fixed-width overflow test updated accordingly (`tests/table_columns_test.rs`).
- Inline bidi reordering now uses byte indices (not char counts) when selecting run directions, walks all paragraphs in the line, and has a regression for multi-byte RTL followed by LTR text to prevent incorrect run reversal (`src/layout/contexts/inline/line_builder.rs`).
- Inline bidi reordering now slices mixed-direction text items into per-run fragments before visual ordering, so RTL/LTR content within a single text node reorders correctly; added regression for a single mixed-direction text run and preserved synthetic test widths without reshaping (`src/layout/contexts/inline/line_builder.rs`).
- Inline boxes are flattened into bidi leaves so descendants reorder with siblings; inline box edges (padding/border) are reapplied to the first/last visual fragment of each box after reordering to keep backgrounds/borders aligned with visual start/end (`src/layout/contexts/inline/line_builder.rs`).
- `unicode-bidi: plaintext` now forces first-strong paragraph direction regardless of the builder base level (effective base set to None when any plaintext leaf is present); regression added (`src/layout/contexts/inline/line_builder.rs`).
- Bidi isolation now respects ancestor `unicode-bidi` settings: inline box stacks emit the appropriate embedding/isolation controls (embed/override/isolate/isolate-override) based on their direction, so isolated spans no longer disturb surrounding runs. Added isolate regression (`src/layout/contexts/inline/line_builder.rs`).
- Plaintext on ancestors now triggers first-strong paragraph direction (box stack considered, not just leaves), and isolation regression added for `unicode-bidi:isolate` inline boxes (`src/layout/contexts/inline/line_builder.rs`).
- Plaintext leaves/ancestors now drop inserted isolation controls and derive the paragraph base level via first-strong analysis of the concatenated logical text before running bidi (so plaintext isn’t skewed by LRI/RLI wrappers); added RTL-first plaintext regression (`src/layout/contexts/inline/line_builder.rs`).
- Bidi logical-text construction now balances embedding/isolation controls across shared ancestor stacks instead of emitting opens/closes per leaf; contexts are opened/closed only when the stack changes, preventing unbalanced sequences. Added regression for multi-leaf isolate inline boxes (`src/layout/contexts/inline/line_builder.rs`).
- Inline bidi context management now keeps ancestor isolates/embeddings open across leaves (opens/ closes only on stack transitions) so multi-leaf isolates share one context and neutrals resolve across sibling leaves; added regression covering multi-leaf isolate neutral resolution (`src/layout/contexts/inline/line_builder.rs`).
- Added rowspan vertical-align regression to ensure spanning cells don't collapse subsequent rows and heights remain positive (`src/layout/table.rs` test).
- Baseline-aligned rowspans now explicitly reserve baseline space in the first row; added regression to guard the baseline reservation for spanning cells (`src/layout/table.rs`).
- Collapsed border model now covered by a bounds regression: table fragments include collapsed stroke widths even with empty cells (`src/layout/table.rs` test).
- Collapsed border row offsets covered by regression: total height accounts for collapsed top/bottom strokes plus minimal row height (`src/layout/table.rs` test).
- Collapsed border positioning regression ensures cell fragments are offset by collapsed border widths and overall table width reflects stroke thickness (`src/layout/table.rs` test).
- Percent columns are treated as auto when the table inline size is indefinite (auto/max-content/min-content without a definite containing block); regression added (`src/layout/table.rs`).
- Collapsed border + rowspan vertical-align regression asserts placement under collapsed borders (`src/layout/table.rs` test).
- Auto layout now keeps percentage columns at their authored percentages (clamped to min/max) even if they over-constrain the table; flexible columns take their mins and over-constraint is reported instead of shrinking percents. Updated tests to reflect CSS2.1 behavior (`src/layout/contexts/table/column_distribution.rs`).
- Removed HN-specific hacks (vote arrow injection, navigation text forcing) from `src/tree/box_generation.rs`.
- Default font size restored to 16px (`src/style/mod.rs`); table margins stripped back to zero in defaults.
- Fixed BGRA → RGBA conversion during image encoding (`src/image_output.rs`).
- Inline text fragments now carry computed styles; painter uses shaping pipeline and real glyph outlines instead of box approximations (`src/paint/painter.rs`).
- Table layout rewritten to use computed display values, default border-spacing 2px 2px, column constraints via `column_distribution`, `<col>/<colgroup>` width handling, min/max from IFC, fallback equal widths if zero; cells laid out with BFC using computed column widths (`src/layout/table.rs`).
- Added `FragmentNode::new_inline_styled` convenience (`src/tree/fragment_tree.rs`).
- Inline FC now shapes with `ShapingPipeline`, keeps shaped runs on fragments, and uses real font metrics for struts/baselines; painter reuses those runs with pen advance and rudimentary RTL handling (`src/layout/contexts/inline`, `src/paint/painter.rs`).
- Added embedded Roboto Regular fallback for fontless environments and generic fallbacks now pick the first available face when generic lookup fails (`resources/fonts`, `src/text/font_loader.rs`, `src/text/font_db.rs`).
- Block FC now buffers inline-level children (including inline replaced/inline-block) and lays them out with `InlineFormattingContext`; inline-blocks get laid out through their own formatting context as atomic inline items (`src/layout/contexts/block/mod.rs`, `src/layout/contexts/inline/mod.rs`).
- Tests currently pass (`cargo test`).
- Replaced elements now resolve intrinsic sizes from actual images via `ImageCache` (using base URL from API/bin), reuse those sizes in inline/block layout, and the painter renders decoded images instead of gray placeholders (`src/api.rs`, `src/layout/utils.rs`, `src/layout/contexts/{block,inline}`, `src/paint/painter.rs`).
- Inline text breaking now aligns break opportunities and splits to cluster boundaries using shaped glyphs; `TextItem` tracks cumulative cluster advances so wrapping and mandatory breaks no longer slice through ligatures/combining marks (`src/layout/contexts/inline/line_builder.rs`).
- Inline line finalization now performs bidi visual reordering per line with the Unicode algorithm, treating non-text inline items as object replacements; x-positions are reassigned in visual order so mixed-direction lines place RTL runs correctly (`src/layout/contexts/inline/line_builder.rs`).
- CSS `direction` is now parsed/inherited (initial `ltr`), carried through computed styles, and used as the base paragraph direction for bidi analysis and per-line reordering (`src/style/{types,mod,properties,cascade}.rs`, `src/text/pipeline.rs`, `src/layout/contexts/inline/mod.rs`).
- Added CSS `unicode-bidi` support (normal/embed/override/isolate/isolate-override/plaintext), plumbed through computed styles and applied during inline line reordering via appropriate UBA control characters; per-item direction comes from computed style and non-text items still participate via object replacement markers (`src/style/{types,mod,properties,cascade}.rs`, `src/layout/contexts/inline/line_builder.rs`).
- Inline splits now preserve shaped glyphs instead of reshaping: splitting uses existing runs at cluster boundaries, adjusts glyph offsets/advances without re-running HarfBuzz, so ligatures/kerning survive across line breaks (`src/layout/contexts/inline/line_builder.rs`).
- Non-text inline/replaced items now enter bidi reordering wrapped in directionally isolated control characters (LRI/RLI…PDI) rather than bare U+FFFC, improving structural ordering for mixed-direction lines (`src/layout/contexts/inline/line_builder.rs`).
- Inline boxes now contribute their children’s text into the bidi reorder string instead of collapsing to a single object, so nested inline wrappers reorder according to their actual textual content (`src/layout/contexts/inline/line_builder.rs`).
- Centralized bidi control generation with `bidi_controls`; logical-text construction now wraps inline boxes and atomic inline items per `unicode-bidi` values without auto-isolating inline-block/replaced placeholders when `unicode-bidi` is `normal` (`src/layout/contexts/inline/line_builder.rs`).
- Inline-block sizing now uses CSS 2.1 shrink-to-fit when `width:auto`, deriving preferred and preferred-min widths from intrinsic measurements and adding padding/borders; specified widths avoid over-constrained margins, and padding/border percentages resolve against the available inline size (`src/layout/contexts/inline/mod.rs`).
- Block layout now clamps computed content widths to `min-width`/`max-width` (percentages resolved against containing block) and recomputes margins with the clamped width so the constraint equation still holds when author limits kick in (`src/layout/contexts/block/mod.rs`).
- Inline replaced elements now honor horizontal margins: margins are resolved in the inline context, included in line advance, and their fragments are offset so margins behave as spacing rather than painted area (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Intrinsic sizing for inline content now excludes margins (replaced elements contribute their border-box width to min/max-content sums while layout still accounts for margins separately) to better match CSS sizing definitions (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Inline-blocks now resolve horizontal margins, subtract them from available inline space for shrink-to-fit sizing, and include them in line advance while only the border-box is painted (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Block intrinsic inline-size computation now accounts for inline content, in-flow block children, replaced boxes, and the element’s own padding/borders instead of just explicit widths (`src/layout/contexts/block/mod.rs`).
- Table column intrinsic widths now use the cell’s formatting context (block/flex/grid/inline) instead of forcing inline measurement, so block-only cells contribute widths correctly (`src/layout/table.rs`).
- `border-spacing` is now parsed/resolved from computed style (em/absolute lengths) and table layout pulls spacing from styles rather than a hardcoded 2px default (`src/style/{mod,properties}.rs`, `src/layout/table.rs`).
- Table column constraints now honor percentage widths on cells/cols and carry them through distribution, so percentage-specified columns consume their share of the available table width before auto distribution (`src/layout/table.rs`, `src/layout/contexts/table/column_distribution.rs`).
- Percentage columns remain unscaled even when total percentages exceed 100%, matching current column distribution expectations; over-constraint is flagged and flexible columns collapse to their minima (`src/layout/contexts/table/column_distribution.rs`).
- Colspan contributions now use the spanning-cell constraint distributor so multi-column cells raise min/max widths across the spanned range rather than per-column equal splits (`src/layout/table.rs`, `src/layout/contexts/table/column_distribution.rs`).
- Parsed `border-collapse` into computed styles and table spacing respects collapsed mode by zeroing spacing when collapse is set (`src/style/{types,mod,properties}.rs`, `src/layout/table.rs`).
- CSS `vertical-align` is now parsed/stored (UA default `middle` for `td/th`), and table layout uses baseline-aware row heights plus per-cell alignment for baseline/top/middle/bottom cases (`src/style/{types,mod,properties.rs,user_agent.css}`, `src/layout/table.rs`).
- CSS `table-layout` is parsed and stored; fixed layout now selects the fixed distribution path in the column distributor (`src/style/{types,mod,properties.rs}`, `src/layout/table.rs`).
- Fixed table layout now only inspects the first row for column sizing and ignores later rows when collecting constraints, matching CSS 2.1 fixed layout behavior (`src/layout/table.rs`).
- Explicit table widths (px/%, em/rem) are resolved against the containing block and used as the available table width; column distribution now honors author-specified table widths (`src/layout/table.rs`).
- Table widths respect `min-width`/`max-width` when clamping explicit/containing widths, and intrinsic width calculation for collapsed borders excludes border widths (padding only) so columns aren’t inflated by collapsed borders (`src/layout/table.rs`).
- Border styles now cover hidden/groove/ridge/inset/outset; collapsed-border conflict resolution honors style priority (hidden > double > solid > dashed > dotted > ridge > outset > groove > inset > none), width, and origin order, with new tests for hidden suppression and style vs. width precedence (`src/style/types.rs`, `src/style/properties.rs`, `src/layout/table.rs`).
- Collapsed borders now participate in layout: cell borders are zeroed for layout, collapsed border grid lines carry resolved widths/styles/colors and total table width/height includes them; line-level border fragments are emitted for painting when collapsed, and table border widths are zeroed at paint time to avoid double drawing (`src/layout/table.rs`).
- Layout now shares a single `FontContext` across the pipeline: `LayoutEngine`/`FormattingContextFactory` are built with the caller’s font context, block/inline/table contexts propagate it to child FCs, and `FastRender` constructs layout using the same context it hands to paint. Inline-block/table measurement now uses caller-provided fonts consistently (`src/layout/{engine,contexts/factory,contexts/block,contexts/inline}, src/layout/table.rs`, `src/api.rs`).
- CSS `white-space` behaviors are respected in inline layout: text is normalized per mode (collapse for normal/nowrap/pre-line, preservation for pre/pre-wrap), explicit breaks are inserted for newlines, wrapping is suppressed for `nowrap`/`pre`, and break opportunities are filtered accordingly. New unit coverage for normal/nowrap/pre flows (`src/layout/contexts/inline/mod.rs`).
- CSS text breaking properties added: `word-break` and `overflow-wrap` parsed into computed styles, and inline layout augments/removes break opportunities accordingly (`break-all`/`anywhere` add cluster breaks, `keep-all` prunes non-whitespace breaks) so min/max-content sizing and line breaking respond to author settings (`src/style/{types,mod,properties}.rs`, `src/layout/contexts/inline/mod.rs`).
- Hyphenation support added: `hyphens` parsed into computed styles, soft hyphens are removed while preserving their break points, and `hyphens:auto` uses a default English hyphenator to inject additional break opportunities so wrapped words can hyphenate per author intent (`src/style/{types,mod,properties}.rs`, `src/layout/contexts/inline/mod.rs`).
- Language inheritance from `lang`/`xml:lang` is normalized to lower-case BCP47 strings and passed through to shaping; HarfBuzz buffers now receive the computed language and shaped runs record it for debugging (`src/style/{mod,cascade}.rs`, `src/text/pipeline.rs`).
- Letter- and word-spacing now affect shaped runs and line metrics: spacing is applied after each cluster (word spacing layered on spaces), advances and glyph offsets updated, and unit tests cover the extra advance contributions (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Hyphenation breaks now insert a hyphen glyph at the break point (soft/auto hyphenation), preserving spacing and shaping with the same style; break metadata carries an `adds_hyphen` flag so line breaking can decide when to render the glyph (`src/text/line_break.rs`, `src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Border painting now respects CSS styles: dotted/dashed use dash patterns (round caps for dotted), double splits into parallel strokes, and inset/outset/groove/ridge apply shaded light/dark variants per edge (`src/paint/painter.rs`).
- Text decorations are painted per spec defaults: underline/overline/line-through use font metrics for position/thickness with color from current text (`src/paint/painter.rs`).
- CSS `text-transform` now applies before shaping/whitespace handling, covering uppercase, lowercase, and capitalize in inline layout (`src/layout/contexts/inline/mod.rs` tests added).
- Inline line fragments honor `text-align` (left/center/right/justify/start/end); justification spreads remaining inline space across word gaps on non-final lines, splitting text items at internal spaces and CJK break points so gaps inside a single run expand too (`src/layout/contexts/inline/mod.rs`).
- `text-align` now supports start/end mapped through `direction`; default text-align is `start`. `text-align-last` is parsed/stored and applied: last lines map start/end/left/right/center/justify, `auto` follows CSS defaults (justified paragraphs use start on final line, single-line non-justify uses text-align) (`src/style/{types.rs,mod.rs,computed.rs,properties.rs}`, `src/layout/contexts/inline/mod.rs`).
- Justification honors `text-justify`: parsed values (auto/none/inter-word/inter-character/distribute) feed inline justification. None forces start alignment even on explicit justify, auto/inter-word keep word-gap/CJK expansion, and inter-character/distribute expand at every cluster boundary. Last-line justify now applies when authored via `text-align-last`. TextItem exposes cluster byte offsets for inter-character splitting (`src/style/{types,mod,properties}.rs`, `src/layout/contexts/inline/{line_builder.rs,mod.rs}`).
- `text-indent` is parsed/inherited (length/percentage with hanging/each-line keywords) and applied during inline layout: indentation adjusts first/subsequent line available widths and offsets item placement per writing direction, with coverage for first-line vs. each-line behavior. Line boxes keep full available width when known so indentation doesn't shrink the block, unknown widths include indent extents, and intrinsic inline sizes add positive indent so shrink-to-fit honors offsets (`src/style/{types,mod,properties,cascade}.rs`, `src/layout/contexts/inline/{line_builder.rs,mod.rs}`).
- `text-justify:auto` now resolves heuristically: per-line script analysis picks inter-character when CJK dominates (otherwise inter-word). Fallback splits use per-character offsets when shaping lacks clusters, and CJK auto-justify coverage ensures per-cluster expansion (`src/layout/contexts/inline/mod.rs`, `src/layout/contexts/inline/line_builder.rs` tests).
- Ignoring synthetic mandatory breaks at end-of-text prevents empty justified lines; forced breaks still trigger splitting (`src/layout/contexts/inline/mod.rs`).
- Min-content sizing for inline content now walks the inline stream with shaped cluster advances, respecting hyphen insertion widths and avoiding synthetic end-of-text breaks between adjacent text nodes; forced breaks from normalization are tracked so explicit newlines still split segments. Added unit coverage for hyphen width accounting and cross-node words (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Max-content sizing for inline content now measures shaped clusters and only breaks on mandatory breaks (e.g., preserved newlines), so maximum width reflects the longest forced line rather than naive summing; inline boxes include their edges, and atomic inline/replaced boxes contribute without introducing breaks. New test covers preserved-newline behavior (`src/layout/contexts/inline/mod.rs`).
- Replaced images now honor CSS `object-fit` (fill/contain/cover/none/scale-down) and `object-position` (length/percent/keywords) during painting, centering and scaling content appropriately while keeping layout size unchanged. Added parsing and style defaults plus painter regression test (`src/style/{types,mod,properties.rs}`, `src/paint/painter.rs`).
- CSS parser now preserves space-separated value lists (e.g., `object-position: left 25%`) as `Multiple` so object-position parsing receives both components (`src/css/properties.rs`).
- Background positioning now obeys `background-position`, `background-origin`, and `background-clip` with proper percentage semantics (percentages resolve against the positioning area minus image size). Painter tiles images/clips to the selected box (border/padding/content) and centers/offsets from the chosen origin; defaults now match spec (origin padding-box, clip border-box) (`src/style/{types,mod,properties.rs}`, `src/paint/painter.rs`).
- Inline-level elements now materialize as `InlineBoxItem`s carrying padding/borders, vertical offsets, and styles so backgrounds/borders participate in painting; `vertical-align` from computed styles is resolved (length/percentage) and applied to text, inline boxes, inline-blocks, and replaced elements (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Inline box baselines are derived from their children (falling back to strut when empty) instead of always using the parent strut; padding/border insets adjust ascent/descent so nested inline boxes contribute realistic baselines (`src/layout/contexts/inline/mod.rs`).
- Replaced element sizing now resolves percentage widths/heights/min/max when a containing block size is available; percentage lengths with no base fall back to intrinsic sizes to avoid bogus zeros (`src/layout/utils.rs`, `src/layout/contexts/{block,inline}/mod.rs`).
- Block and inline formatting contexts propagate definite containing-block heights; percentage heights/min-heights/max-heights resolve when a base exists and fall back to auto/0/∞ when not. Vertical padding/border resolution uses the containing width to avoid panics on percentages, inline-block percentage heights honor available block height, and percentage bases for replaced sizing ignore NaN placeholders. Added tests for block/inline-block percentage height resolution (`src/layout/utils.rs`, `src/layout/contexts/{block,inline}/mod.rs`).
- Inline-block baselines now come from the last in-flow line box inside the fragment when present, falling back to the bottom border edge only when no lines exist. Baseline metrics for inline-blocks now use ascent/descent derived from that line instead of treating them as replaced elements (`src/layout/contexts/inline/line_builder.rs`).
- Collapsed table borders are painted as individual border edges using the resolved style/color/width for each grid line instead of flat stripes; vertical/horizontal borders are centered on grid boundaries and drawn with border styles (dotted/dashed/double/inset/outset/etc.) via the painter (`src/layout/table.rs`).
- Collapsed border data now carries per-segment winners (one border resolution per grid line segment), and painting renders each segment with its own style/color/width using boundary-aware positioning based on adjacent perpendicular segment widths so adjoining borders meet cleanly instead of flattening to a uniform line (`src/layout/table.rs`).
- Collapsed border corners now resolve a winner per grid junction and paint a square join using that style/color/width, reducing double-paint overlaps at intersections (`src/layout/table.rs`).
- Display-list construction now walks stacking contexts using `paint::stacking::creates_stacking_context`, emitting commands in stacking order (negative/zero/positive contexts) rather than globally sorting by z-index; backgrounds/borders for each context stay ahead of its content and descendants (`src/paint/painter.rs`).
- Stacking contexts with `opacity < 1` now render into their own layer and composite back into the canvas so opacity applies to the entire subtree instead of per-primitive alpha (`src/paint/painter.rs`).
- Opacity layers are now bounded to the stacking context’s content: commands are translated to a minimal bounding rectangle and composited back with a translation, avoiding full-canvas temporary buffers for translucent contexts (`src/paint/painter.rs`).
- Stacking contexts now honor CSS `transform`: transforms are composed into the context’s layer, applied around the fragment’s top-left, and rendered via a translated offscreen buffer before compositing back. Basic translate/scale/rotate/skew/matrix forms are supported; percentages resolve against the context’s box (`src/paint/painter.rs`).
- CSS `transform-origin` is parsed (length/percentage/keywords), stored in computed styles (default 50% 50%), and respected when composing stacking-context transforms so rotation/scale occur around the authored origin instead of top-left (`src/style/{mod.rs,properties.rs,types.rs}`, `src/paint/painter.rs`).
- CSS `mix-blend-mode` and `isolation` are parsed and stored; stacking contexts are created for non-normal blend modes or isolation, and painter composites layers using the mapped blend mode (`src/style/{types.rs,mod.rs,properties.rs}`, `src/paint/{stacking.rs,painter.rs}`).
- Isolation `isolate` now forces SourceOver when compositing the isolated layer back into its parent to prevent backdrop blending across contexts (`src/paint/painter.rs`).
- CSS `filter` is parsed and stored (blur, brightness, contrast, grayscale, sepia, saturate, hue-rotate, invert, opacity, drop-shadow). CurrentColor is deferred, lengths stay unresolved until paint, and `filter != none` creates a stacking context (`src/style/{types.rs,mod.rs,properties.rs}`, `src/paint/stacking.rs`).
- Painter resolves filters per stacking context, expands layer bounds for blur/drop-shadow outsets, and applies effects in order: color matrix filters, opacity, Gaussian blur, and drop-shadow with spread/blur/offset composited behind content (`src/paint/painter.rs`).
- Added filter parsing unit coverage for multi-function lists and drop-shadow defaults (`src/style/properties.rs` tests).
- CSS `backdrop-filter` is parsed (reusing the filter function set) and forces stacking contexts; painter copies the backdrop within the context bounds, applies the resolved filters (including blur/drop-shadow outsets), and composites it back before drawing the context, so backdrop blur/drop-shadow are visible behind translucent content (`src/style/{types.rs,mod.rs,properties.rs}`, `src/paint/{stacking.rs,painter.rs}`).
- Filters and backdrop-filters now clip to the element’s border box with resolved border radii: stacking layers and backdrop regions are masked by the computed rounded-rect radii before compositing, preventing glow/blur from bleeding outside rounded corners (`src/paint/painter.rs`).
- Background colors and images respect border-radius and `background-clip`: clip radii shrink with border/padding/content edges, fills draw as rounded rects, and image tiling is masked to the clipped rounded box (`src/paint/painter.rs`).
- `text-align-last: auto` now matches CSS Text: single-line justify paragraphs still justify (using the computed `text-align`), while multi-line paragraphs fall back to start alignment on the last line; added regression to lock the single-line justify behavior (`src/layout/contexts/inline/mod.rs`).
- `text-indent` keyword semantics refined: `each-line` now forces indentation on the first line even when `hanging` is present, hanging applies to subsequent lines as before, and regressions cover hanging + each-line behavior and intrinsic sizing with a hanging indent across lines (`src/layout/contexts/inline/mod.rs`).
- List markers respect `list-style-position`: outside markers no longer shift inline layout (painted outside with a gap), inside markers reserve their width+gap in layout. Regression updated to reflect outside marker positioning (`src/layout/contexts/inline/{mod.rs,line_builder.rs}`).
- Text decorations now render even when font metrics aren’t available: painter synthesizes underline/strike metrics from the font size instead of skipping decorations when fonts can’t supply metrics (`src/paint/painter.rs`).

## Current issues / gaps
- Bidi: still relies on injected controls instead of a dedicated embedding/isolate stack; nested isolates/overrides need validation against UAX#9 beyond the FSI/PDI wrapping.
- Justification lacks script-aware expansion (kashida/justification alternates, punctuation stretching) and `text-justify` is still approximated (auto treated as inter-word; no trim/edge handling).
- `text-align-last` currently maps start/end via direction; nuanced interaction with `text-justify` and additional values still pending.
- `text-indent` hanging/each-line semantics are approximate; indentation doesn’t yet handle hanging outdents per spec nuances.
- Max-content sizing now honors mandatory breaks but still ignores anonymous inline box generation and percent-driven height constraints.
- Table layout still partial: row/col spans not fully honored (rowspan baselines, percent/fixed widths still simplified vs CSS 2.1), colspan distribution still heuristic.
- Non-image replaced content (iframe/video/etc.) remains unrendered; need full replaced-element handling beyond images/SVG.
- Painting still lacks 3D transforms/transform-origin z and fuller filter/blend/isolation interplay, and the richer display list module remains partially integrated.
- Root line strut still provides minimum line-height rather than full descendant baseline synthesis.

## To-do / next steps (spec-oriented)
1. Inline/text:
   - Build bidi-aware flattening of inline boxes so descendants reorder per UAX#9 while maintaining box edges/backgrounds; lift `unicode-bidi: plaintext` to paragraph-scoped handling.
   - Align baseline/line-height calculations with real font metrics across multi-font runs.
   - Harden RTL run positioning and visual reordering in painter/layout so mixed-direction text paints correctly.
2. Tables:
   - Finish CSS 2.1 auto table layout: full border-collapse model including per-segment conflict resolution, style-aware painting (dotted/dashed/double geometry), percent/fixed widths resolved per spec, correct colspan/rowspan distribution (including baseline handling for rowspans), and row height/baseline behavior under collapsed borders.
3. Replaced content:
   - Render images for `ReplacedType::Image` instead of placeholders.
4. General bidi:
   - Ensure visual ordering in layout and paint for RTL/mixed runs.
5. Inline blocks:
   - Generate proper anonymous inline wrappers; validate remaining percentage/min-height edge cases and baseline behavior in nested formatting contexts.
6. Lists/markers:
   - Implement ::marker property restrictions and inside positioning geometry; round out counter style coverage and marker inheritance edge cases.

## Notes
- Current table code uses `InlineFormattingContext` for cell intrinsic widths; this fails for block/table/replaced content—needs a per-context intrinsic measurement.
- Default font family remains `"serif"`; UA defaults can be revisited when baseline metrics are real.

## Remote branch (cursor/pixel-perfect-news-ycombinator-com-rendering-gpt-5.1-codex-high-b0ad) scan
- Block FC: buffers inline children and runs them through `InlineFormattingContext` as a group, with margin collapse handling. Better than placeholder inline fragments—worth adopting concept.
- Painter: introduces `FontContext` parameter to `paint_tree`/`Painter::new` and uses `TextShaper` + `TextRasterizer` (`shape_text_simple`) with guessed font size; still LTR-only and style-agnostic. We already have a more capable shaping pipeline; don’t regress, but sharing the font context between layout/paint is a good idea.
- Table: adds a simplistic cell-content layout by stacking child fragments or collected text; ignores padding/borders/inline flow—worse than current plan.
- Inline FC: minor guard for mandatory breaks past end-of-text.

Actionable borrowings:
- Integrate the block inline-buffering approach (layout inline groups via IFC, flush on block children).
- Consider passing a shared `FontContext` into paint_tree/painter so paint and layout use the same font state.
